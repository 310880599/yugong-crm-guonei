<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>{:config('sys_name')}后台管理</title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <link rel="stylesheet" href="/static/plugins/layui/css/layui.css" media="all" />
    <link rel="stylesheet" href="/static/admin/css/global.css" media="all">
    <link rel="stylesheet" href="/static/common/css/font.css" media="all">
    <style>
        .filtrate-warp {
            margin-bottom: 10px;
        }

        .filtrate-warp .title {
            padding: 5px 12px 7px 12px;
            font-size: 14px;
            font-weight: normal;
            text-align: left;
            cursor: pointer;
            width: 90px;
            background-color: transparent !important;
            color: black !important;
        }

        .filtrate-warp .title:hover {
            color: black;
        }

        .filtrate-warp .flag {
            padding: 6px 12px 6px 12px;
            cursor: pointer;
        }

        .filtrate-warp .flag:hover {
            color: black;
        }

        .filtrate-warp .layui-badge:hover {
            color: white !important;
        }
          .timeline-item {
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }
        
        .timeline-title {
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .timeline-content {
            display: flex;
            align-items: flex-start;
        }
        
        .avatar {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            margin-right: 10px;
        }
    </style>
</head>

<body class="skin-<?php if(!empty($_COOKIE['skin'])){echo $_COOKIE['skin'];}else{echo '0';setcookie('skin','0');}?>">

    <div class="admin-main layui-anim layui-anim-upbit">
        <fieldset class="layui-elem-field">
            <legend>高级查询</legend>
            <div class="layui-card" style="box-shadow:none; margin-top:10px;">
                <div class="layui-form layui-card-header layuiadmin-card-header-auto"
                    style="border-bottom: transparent; height:auto;">
                    <div class="layui-form-item" style="text-align:left; padding-left:20px;">
                        <div class="layui-inline">
                            <label class="layui-form-label">客户级别：</label>
                            <div class="layui-input-inline">
                                <select name="kh_rank" id="kh_rank">
                                    <option value="">请选择客户级别</option>
                                    {volist name="khRankList" id="vo"}
                                    <option value="{$vo.rank_name}">{$vo.rank_name}</option>
                                    {/volist}
                                </select>
                            </div>
                        </div>
                        <div class="layui-inline">
                            <label class="layui-form-label">客户来源：</label>
                            <div class="layui-input-inline">
                                <select name="kh_status" id="kh_status">
                                    <option value="">请选择客户来源</option>
                                    {volist name="khStatusList" id="vo"}
                                    <option value="{$vo.status_name}">{$vo.status_name}</option>
                                    {/volist}
                                </select>
                            </div>
                        </div>
                        <div class="layui-inline">
                            <label class="layui-form-label">手机：</label>
                            <div class="layui-input-inline">
                                <input type="text" name="phone" id="phone" placeholder="请输入手机号码" class="layui-input">
                            </div>
                        </div>
                        <div class="layui-inline">
                            <label class="layui-form-label">客户名称：</label>
                            <div class="layui-input-inline">
                                <input type="text" name="kh_name" id="kh_name" placeholder="请输入客户名称"
                                    class="layui-input">
                            </div>
                        </div>
                        <div class="layui-inline">
                            <label class="layui-form-label">业务员：</label>
                            <div class="layui-input-inline">
                                <select name="pr_user" id="pr_user" lay-search="">
                                    <option value="">请选择业务员</option>
                                    {volist name="adminResult" id="vo"}
                                    <option value="{$vo.username}">{$vo.username}</option>
                                    {/volist}
                                </select>
                            </div>
                        </div>
                        <div class="layui-inline">
                            <label class="layui-form-label">日期查询：</label>
                            <div class="layui-input-inline">
                                <select name="timebucket" id="dateRange" lay-filter="dateRange">
                                    <option value="">自定义</option>
                                    <option value="today">今天</option>
                                    <option value="yesterday">昨天</option>
                                    <option value="week">本周</option>
                                    <option value="last week">上周</option>
                                    <option value="month">本月</option>
                                    <option value="last month">上月</option>
                                    <option value="year">今年</option>
                                    <option value="last year">去年</option>
                                    <option value="-2 hours">两个小时内</option>
                                </select>
                            </div>
                            <div class="layui-input-inline">
                                <input type="text" class="layui-input" name="at_time" id="at_time" placeholder="选择日期范围">
                            </div>
                        </div>
                    </div>
                    <div class="layui-inline" style="float:right; padding-bottom:15px;">
                        <button class="layui-btn layuiadmin-btn-list" lay-submit lay-filter="LAY-app-contlist-search">
                            <i class="layui-icon layui-icon-search layuiadmin-button-btn"></i>查询数据
                        </button>
                    </div>
                </div>
            </div>
        </fieldset>

        <table class="layui-table" id="table-list" lay-filter="table-list"></table>
    </div>

    <script type="text/html" id="action">
   <a class="layui-btn layui-btn-primary layui-btn-xs" lay-event="follow"><i class="layui-icon">&#xe654;</i>写跟进</a>
    <a class="layui-btn layui-btn-primary layui-btn-xs" lay-event="alter"><i class="layui-icon">&#xe60e;</i>转移</a>
    <a class="layui-btn layui-btn-primary layui-btn-xs" lay-event="chengjiao"><i class="layui-icon">&#xe63c;</i>成交</a>
    <a class="layui-btn  layui-btn-xs" lay-event="edit"><i class="layui-icon">&#xe642;</i>编辑</a>
</script>

    <script type="text/html" id="topBtn">
    <button type="button" class="layui-btn layui-btn-primary layui-btn-radius layui-btn-sm" id="add"><i class="layui-icon">&#xe608;</i>添加客户</button>
    <button type="button" class="layui-btn layui-btn-normal layui-btn-radius layui-btn-sm" id="toAll" style="margin-right: 10px"><i class="layui-icon">&#xe681;</i>导入客户</button>
    <button type="button" class="layui-btn layui-btn-danger layui-btn-radius layui-btn-sm" id="moveGh" lay-event="moveGh"><i class="layui-icon">&#xe770;</i>移入公海</button>
    <button type="button" class="layui-btn layui-btn-primary layui-btn-radius layui-btn-sm" id="alterAll" lay-event="alterAll"><i class="layui-icon">&#xe60e;</i>转移客户</button>
    <button type="button" class="layui-btn layui-btn-primary layui-btn-radius layui-btn-sm" id="chengjiaoAll" lay-event="chengjiaoAll"><i class="layui-icon">&#xe63c;</i>客户成交</button>
    <button type="button" id="delAlls" class="layui-btn layui-btn-danger layui-btn-radius layui-btn-sm" lay-event="delAlls"><i class="layui-icon">&#xe640;</i>选中删除</button>
</script>
  <!-- 跟进弹窗 -->
    <div id="follow-dialog" style="display: none; padding: 20px;">
        <div class="follow-container">
            <div class="follow-header">
                <h3>客户跟进</h3>
            </div>
            <div class="follow-content">
                <div class="follow-info">
                    <div class="info-item">
                        <span class="info-label">客户ID:</span>
                        <span id="follow-client-id"></span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">客户名称:</span>
                        <span id="follow-client-name"></span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">联系人:</span>
                        <span id="follow-contact"></span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">地区:</span>
                        <span id="follow-area"></span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">客户来源:</span>
                        <span id="follow-source"></span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">客户级别:</span>
                        <span id="follow-rank"></span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">负责人:</span>
                        <span id="follow-user"></span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">创建时间:</span>
                        <span id="follow-create-time"></span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">最后跟进:</span>
                        <span id="follow-last-time"></span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">跟进记录:</span>
                        <textarea id="follow-last-record" class="layui-textarea" readonly style="height: 80px;"></textarea>
                    </div>
                </div>
                <div class="follow-history">
                    <h4>跟进历史</h4>
                    <div id="follow-history-list" style="max-height: 300px; overflow-y: auto;">
                        <!-- 跟进历史将通过JS动态加载 -->
                    </div>
                    <div style="margin-top: 20px;">
                        <h4>添加跟进记录</h4>
                        <div class="layui-form-item layui-form-text">
                            <textarea name="reply_msg" id="reply_msg" required lay-verify="required"
                                placeholder="请输入跟进内容" class="layui-textarea" style="height: 100px;"></textarea>
                        </div>
                        <div class="layui-form-item">
                            <input type="hidden" name="leads_id" id="leads_id" value="">
                            <button class="layui-btn" lay-filter="btn_comment" lay-submit id="submit-comment">提交记录</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {include file="common/foot"/}
    <script>
        layui.use(['table', 'form', 'upload', 'util', 'laydate'], function () {
            var table = layui.table,
                form = layui.form,
                laydate = layui.laydate,
                $ = layui.jquery,
                upload = layui.upload,
                util = layui.util;

            // 表格初始化（默认不加任何筛选条件）
            var tableIn = table.render({
                elem: '#table-list',
                url: "{:url('index')}",
                method: 'post',
                toolbar: '#topBtn',
                defaultToolbar: ['filter', 'print', 'exports'],
                cols: [[
                    { checkbox: true, fixed: true },
                    { field: 'id', title: 'ID', hide: true },
                    {
                        field: 'kh_name', title: '客户名称', width: 200, templet: function (res) {
                            return "<a href='{:url(\"dialogue\")}?id=" + res.id + "'>" + res.kh_name + "</a>";
                        }
                    },
                    {
                        field: 'issuccess', title: '成交状态', templet: function (res) {
                            return res.issuccess == 1 ? '已成交' : '未成交';
                        }
                    },
                    { field: 'main_phone', title: '主电话', width: 180 },
                    { field: 'aux_phone', title: '辅助电话', width: 180 },
                    { field: 'last_up_records', title: '最新跟进记录' },
                    { field: 'pr_user', title: '负责人' },
                    { field: 'at_time', title: '创建时间' },
                    { field: 'ut_time', title: '更新时间' },
                    { width: 320, align: 'center', toolbar: '#action' }
                ]],
                limit: 100,
                page: { limits: [10, 20, 50, 100, 9999999] }
            });
 // 打开跟进弹窗
            function openFollowDialog(clientId) {
                // 显示加载提示
                var loading = layer.load(1, {shade: [0.1, '#fff']});
                
                // 获取客户信息和跟进记录
                $.ajax({
                    url: "{:url('Client/getClientDetailAndComments')}",
                    method: 'GET',
                    data: {id: clientId},
                    success: function(res) {
                        layer.close(loading);
                        if (res.code === 0) {
                            var clientData = res.data.client;
                            var comments = res.data.comments;
                            
                            // 填充客户信息
                            $('#follow-client-id').text(clientData.id);
                            $('#follow-client-name').text(clientData.kh_name);
                            $('#follow-contact').text(clientData.kh_contact);
                            $('#follow-area').text(clientData.xs_area);
                            $('#follow-source').text(clientData.kh_status);
                            $('#follow-rank').text(clientData.kh_rank);
                            $('#follow-user').text(clientData.pr_user);
                            $('#follow-create-time').text(clientData.at_time);
                            $('#follow-last-time').text(clientData.last_up_time || '暂无');
                            $('#follow-last-record').val(clientData.last_up_records || '暂无记录');
                            $('#leads_id').val(clientData.id);
                            
                            // 填充跟进历史
                            var html = '';
                            if (comments.length > 0) {
                                $.each(comments, function(index, item) {
                                    html += '<div class="timeline-item">' +
                                        '<div class="timeline-title">' + item.create_date + '</div>' +
                                        '<div class="timeline-content">' +
                                        '<img src="' + (item.avatar || '/static/admin/images/0.jpg') + '" class="avatar" onerror="this.src=\'/static/admin/images/0.jpg\'">' +
                                        '<strong>' + item.username + '：</strong>' +
                                        item.reply_msg +
                                        '</div>' +
                                        '</div>';
                                });
                            } else {
                                html = '<p>暂无跟进记录</p>';
                            }
                            $('#follow-history-list').html(html);
                            
                            // 显示弹窗
                            layer.open({
                                type: 1,
                                title: '客户跟进 - ' + clientData.kh_name,
                                area: ['90%', '80%'],
                                content: $('#follow-dialog'),
                                zIndex: 20000000, // 设置更高的z-index值，确保在最上层
                                success: function(layero, index) {
                                    // 确保弹窗内容正确显示
                                    $('#follow-dialog').show();
                                    // 确保弹窗在最上层
                                    layero.css('z-index', 20000000);
                                    // 确保遮罩层也在最上层
                                    $('.layui-layer-shade').css('z-index', 19999999);
                                },
                                end: function() {
                                    // 弹窗完全关闭后，确保元素被正确隐藏并移除遮挡
                                    $('#follow-dialog').hide().appendTo('body');
                                }
                            });
                        } else {
                            layer.msg(res.msg || '获取客户信息失败');
                        }
                    },
                    error: function() {
                        layer.close(loading);
                        layer.msg('网络错误，获取客户信息失败');
                    }
                });
            }

            // 提交跟进记录
            $('#submit-comment').on('click', function() {
                var replyMsg = $('#reply_msg').val();
                var leadsId = $('#leads_id').val();
                
                if (!replyMsg) {
                    layer.msg('请输入跟进内容');
                    return;
                }
                
                // 显示加载提示
                var loading = layer.load(1, {shade: [0.1, '#fff']});
                
                $.ajax({
                    method: 'post',
                    url: "{:url('Client/comment')}",
                    data: {
                        reply_msg: replyMsg,
                        leads_id: leadsId
                    },
                    success: function (res) {
                        layer.close(loading);
                        if (res.code === 0) {
                            layer.msg(res.msg);
                            $('#reply_msg').val('');
                            
                            // 更新历史记录
                            var now = new Date();
                            var createDate = now.getFullYear() + '年' + (now.getMonth() + 1) + '月' + now.getDate() + '日 ' 
                                + now.getHours() + ':' + (now.getMinutes() < 10 ? '0' : '') + now.getMinutes();
                            
                            var historyHtml = '<div class="timeline-item">' +
                                '<div class="timeline-title">' + createDate + '</div>' +
                                '<div class="timeline-content">' +
                                '<img src="{$Think.session.avatar|default="/static/admin/images/0.jpg"}" class="avatar" onerror="this.src=\'/static/admin/images/0.jpg\'">' +
                                '<strong>{$Think.session.username}：</strong>' +
                                res.data.reply_msg +
                                '</div>' +
                                '</div>';
                            $('#follow-history-list').prepend(historyHtml);
                            
                            // 更新最新跟进记录显示
                            $('#follow-last-record').val(res.data.reply_msg);
                            $('#follow-last-time').text(createDate);
                            
                            // 更新表格中的最新跟进记录
                            tableIn.reload();
                        } else {
                            layer.msg(res.msg);
                        }
                    },
                    error: function () {
                        layer.close(loading);
                        layer.msg('提交失败');
                    }
                });
            });
            table.on('tool(table-list)', function (obj) {
                var data = obj.data;
                if (obj.event === 'del') {
                    layer.confirm('您确定要删除这个客户吗？', function (index) {
                        var loading = layer.load(1, { shade: [0.1, '#fff'] });
                        $.post("{:url('del')}", { id: data.id }, function (res) {
                            layer.close(loading);
                            if (res.code === 0) {
                                layer.msg(res.msg, { time: 1000, icon: 1 });
                                tableIn.reload();
                            } else {
                                layer.msg('操作失败！', { time: 1000, icon: 2 });
                            }
                        });
                        layer.close(index);
                    });
                } else if (obj.event === 'edit') {
                    layer_add("编辑客户", "{:url('Client/edit')}?id=" + data.id);
                } else if (obj.event === 'alter') {
                    layer_add("转移客户", "{:url('Client/alterPrUser')}?ids=" + data.id)
                } else if (obj.event === 'chengjiao') {
                    layer.confirm('您确定这个客户成交了吗？', function (index) {
                        $.post("{:url('Client/chengjiao')}", { ids: data.id }, function (res) {
                            if (res.code === 0) {
                                layer.msg(res.msg, { time: 1000, icon: 1 });
                                tableIn.reload();
                            } else {
                                layer.msg('操作失败！', { time: 1000, icon: 2 });
                            }
                        })
                    });
                }
            });

            $('body').on('click', '#add', function () {
                layer.open({
                    type: 2,
                    title: '添加客户',
                    closeBtn: 1,
                    area: ['100%', '86%'],
                    anim: 2,
                    shadeClose: false,
                    maxmin: false,
                    content: ["{:url('Client/add')}"]
                });
            });

            // 工具栏批量操作（原样保留）
            table.on('toolbar(table-list)', function (obj) {
                var checkStatus = table.checkStatus(obj.config.id), data = checkStatus.data;
                switch (obj.event) {
                    case 'moveGh':
                        if (data.length === 0) { layer.msg('请选择一行'); }
                        else {
                            var alterList = data.map(function (o) { return o.id; });
                            var currConfirm = layer.confirm('您确定这' + data.length + '个客户转入公海吗？', function () {
                                layer.open({
                                    type: 2,
                                    title: '移入公海',
                                    closeBtn: 1,
                                    area: ['100%', '86%'],
                                    anim: 2,
                                    shadeClose: false,
                                    maxmin: false,
                                    content: ["{:url('Client/toMoveGh')}?ids=" + alterList]
                                });
                            });
                        }
                        break;
                    case 'alterAll':
                        if (data.length > 0) {
                            var alterList2 = data.map(function (o) { return o.id; });
                            var currConfirm2 = layer.confirm('您确定要转移这' + data.length + '个客户吗？', function () {
                                layer.close(currConfirm2);
                                layer.open({
                                    type: 2,
                                    title: '转移客户',
                                    closeBtn: 1,
                                    area: ['100%', '86%'],
                                    anim: 2,
                                    shadeClose: false,
                                    maxmin: false,
                                    content: ["{:url('Client/alterPrUser')}?ids=" + alterList2]
                                });
                            });
                        } else {
                            layer.msg("请选择需要转移的客户");
                        }
                        break;
                    case 'chengjiaoAll':
                        if (data.length > 0) {
                            var ids = data.map(function (o) { return o.id; });
                            layer.confirm('您确定' + data.length + '个客户成交了吗？', function () {
                                $.post("{:url('Client/chengjiao')}", { ids: ids }, function (res) {
                                    if (res.code === 0) {
                                        layer.msg(res.msg, { time: 1000, icon: 1 });
                                        tableIn.reload();
                                    } else {
                                        layer.msg('操作失败！', { time: 1000, icon: 2 });
                                    }
                                })
                            });
                        } else {
                            layer.msg("请选择成交的客户");
                        }
                        break;
                    case 'delAlls':
                        if (data.length === 0) {
                            layer.msg('请先选择要删除的客户');
                        } else {
                            var ids2 = data.map(function (o) { return o.id; });
                            layer.confirm('确定删除选中的' + ids2.length + '个客户？', function (index) {
                                var loading = layer.load(1, { shade: [0.1, '#fff'] });
                                $.post("{:url('del')}", { ids: ids2 }, function (res) {
                                    layer.close(loading);
                                    if (res.code === 0) {
                                        layer.msg(res.msg, { time: 1000, icon: 1 });
                                        tableIn.reload();
                                    } else {
                                        layer.msg(res.msg || '删除失败', { time: 1500, icon: 2 });
                                    }
                                });
                                layer.close(index);
                            });
                        }
                        break;
                }
            });

            // 监听搜索提交事件
            form.on('submit(LAY-app-contlist-search)', function (data) {
                // 重载表格，根据筛选条件精确查询
                table.reload('table-list', {
                    url: "{:url('index')}",           // 统一使用 index 接口
                    method: 'post',
                    where: { keyword: data.field },   // 将所有字段参数打包进 keyword
                    page: { curr: 1 }
                });
                return false;
            });


            // 日期范围选择器初始化
            laydate.render({
                elem: '#at_time',
                range: true,
                trigger: 'click'
            });
            // 日期下拉选项切换：选择“自定义”时显示日期范围输入
            form.on('select(dateRange)', function (data) {
                var isCustom = (data.value === '');
                $('#at_time').toggle(isCustom);
                if (!isCustom) {
                    // 切换到预设范围时清空自定义日期输入
                    $('#at_time').val('');
                }
            });
            // 根据默认选项决定是否显示日期输入框
            if ($('#dateRange').val() !== '') {
                $('#at_time').hide();
            }

            // 批量导入（原样保留）
            var indexMsg;
            upload.render({
                elem: '#toAll',
                url: "{:url('Client/xlsUpload')}",
                accept: 'file',
                field: 'xlsFile',
                exts: 'xls|xlsx',
                before: function () {
                    indexMsg = layer.msg('正在导入数据，请稍等...', { icon: 16, shade: 0.04, time: false });
                },
                done: function (res) {
                    layer.close(indexMsg);
                    if (res.code == 0) {
                        layer.msg(res.msg, { time: 3000, icon: 1 }, function () { location.reload() });
                    } else {
                        layer.msg(res.msg, { time: 1800, icon: 2 });
                    }
                },
                error: function () {
                    layer.close(indexMsg);
                    layer.msg('系统繁忙，请稍后...', { time: 1800, icon: 1 });
                }
            });
        });
    </script>

    <script>
        /*添加*/
        function layer_add(title, url) {
            layer.open({
                type: 2,
                title: title,
                closeBtn: 1,
                area: ['100%', '80%'],
                anim: 2,
                shadeClose: false,
                maxmin: true,
                content: [url],
            });
        }
    </script>
</body>

</html>