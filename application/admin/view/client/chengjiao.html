<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>{:config('sys_name')}åå°ç®¡ç†</title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <link rel="stylesheet" href="/static/plugins/layui/css/layui.css" media="all" />
    <link rel="stylesheet" href="/static/admin/css/global.css" media="all">
    <link rel="stylesheet" href="/static/common/css/font.css" media="all">
    <link rel="stylesheet" href="/static/admin/css/select.css" media="all">  <!-- å¼•å…¥ä¸‹æ‹‰é€‰æ‹©ç»„ä»¶æ ·å¼ -->
    <script src="/static/admin/js/select.js"></script>  <!-- å¼•å…¥ä¸‹æ‹‰é€‰æ‹©ç»„ä»¶è„šæœ¬ -->
    <style>
        /* éšè—æ¨¡æ¿è„šæœ¬æ ‡ç­¾ï¼Œé¿å…åœ¨é¡µé¢ä¸Šæ˜¾ç¤ºä¸ºä»£ç  */
        script[type="text/html"] {
            display: none !important;
        }

        /* ç­›é€‰åŒºåŸŸæ ·å¼ä¼˜åŒ– */
        .filtrate-warp {
            margin-bottom: 15px;
            transition: all 0.3s ease;
        }

        .filtrate-warp .title {
            padding: 8px 16px;
            font-size: 14px;
            font-weight: 500;
            text-align: left;
            cursor: pointer;
            width: 90px;
            background-color: transparent !important;
            color: #333 !important;
            border-radius: 4px;
            transition: all 0.3s ease;
        }

        .filtrate-warp .title:hover {
            color: #1890ff !important;
            background-color: #f0f7ff !important;
        }

        .filtrate-warp .flag {
            padding: 8px 16px;
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.3s ease;
        }

        .filtrate-warp .flag:hover {
            color: #1890ff;
            background-color: #f0f7ff;
        }

        .filtrate-warp .layui-badge:hover {
            color: white !important;
            transform: scale(1.05);
            transition: transform 0.2s ease;
        }

        /* é«˜çº§æŸ¥è¯¢åŒºåŸŸä¼˜åŒ– */
        .layui-elem-field {
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            border: 1px solid #e8e8e8;
            /* overflow: hidden; */
            background: #fafafa;
        }

        .layui-elem-field legend {
            font-size: 16px;
            font-weight: 600;
            background: #6695ea;
            border-radius: 8px;
            color: #fff;
            padding: 10px 15px;
        }

        .layui-card {
            background: #fafafa;
            border-radius: 6px;
        }

        .layui-form-item {
            margin-bottom: 15px;
        }

        .layui-form-label {
            font-weight: 500;
            color: #555;
        }

        .layui-input, .layui-select {
            border-radius: 4px;
            border: 1px solid #d9d9d9;
            transition: all 0.3s ease;
        }

        .layui-input:focus, .layui-select:focus {
            border-color: #1890ff;
            box-shadow: 0 0 0 2px rgba(24, 144, 255, 0.1);
        }

        .layui-btn {
            border-radius: 4px;
            transition: all 0.3s ease;
        }

        .layui-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        /* è¡¨æ ¼æ ·å¼ä¼˜åŒ– */
        .layui-table {
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }

        .layui-table thead tr {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .layui-table thead th {
            color: #fff;
            font-weight: 600;
            padding: 15px 10px;
        }

        .layui-table tbody tr {
            transition: all 0.2s ease;
        }

        .layui-table tbody tr:hover {
            background-color: #f5f7fa;
            transform: scale(1.01);
        }

        .layui-table tbody td {
            padding: 12px 10px;
        }

        .client-link {
            color: #1890ff;
            transition: all 0.2s ease;
        }

        .client-link:hover {
            color: #40a9ff;
            text-decoration: underline;
        }

        /* æ—¶é—´çº¿æ ·å¼ä¼˜åŒ– */
        .timeline-item {
            margin-bottom: 20px;
            padding: 15px;
            padding-bottom: 20px;
            border-bottom: 1px solid #e8e8e8;
            background: #fafafa;
            border-radius: 6px;
            transition: all 0.3s ease;
            position: relative;
        }

        .timeline-item:last-child {
            border-bottom: none;
        }

        .timeline-item:hover {
            background: #f0f7ff;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            transform: translateX(5px);
        }

        .timeline-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 20px;
            bottom: 20px;
            width: 3px;
            background: linear-gradient(180deg, #1890ff, #52c41a);
            border-radius: 2px;
        }

        .timeline-title {
            font-weight: 600;
            margin-bottom: 10px;
            color: #333;
            font-size: 14px;
            display: flex;
            align-items: center;
        }

        .timeline-title::before {
            content: 'ğŸ“…';
            margin-right: 8px;
        }

        .timeline-content {
            display: flex;
            align-items: flex-start;
            padding-left: 5px;
        }

        .timeline-content strong {
            color: #1890ff;
            margin-right: 8px;
            font-weight: 600;
        }

        .avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            margin-right: 12px;
            border: 2px solid #e8e8e8;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .avatar:hover {
            transform: scale(1.1);
            border-color: #1890ff;
        }

        /* è·Ÿè¿›å¼¹çª—æ ·å¼ä¼˜åŒ– */
        #follow-dialog {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        }

        .follow-container {
            background: #fff;
            border-radius: 8px;
            padding: 20px;
        }

        .follow-header {
            padding: 20px;
            border-bottom: 2px solid #f0f0f0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 8px 8px 0 0;
            margin: -20px -20px 20px -20px;
        }

        .follow-header h3 {
            color: #fff;
            margin: 0;
            font-size: 18px;
            font-weight: 600;
        }

        .follow-content {
            display: flex;
            gap: 20px;
        }

        .follow-info {
            flex: 1;
            background: #fafafa;
            padding: 20px;
            border-radius: 6px;
            border: 1px solid #e8e8e8;
        }

        .follow-history {
            flex: 1;
            border-left: 2px solid #e8e8e8;
            padding-left: 20px;
        }

        .info-item {
            display: flex;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #f0f0f0;
            transition: all 0.2s ease;
        }

        .info-item:last-child {
            border-bottom: none;
        }

        .info-item:hover {
            background: #f5f7fa;
            padding-left: 10px;
            border-radius: 4px;
        }

        .info-label {
            font-weight: 600;
            color: #666;
            min-width: 100px;
            margin-right: 15px;
        }

        .info-item span:not(.info-label) {
            color: #333;
            flex: 1;
        }

        .follow-history h4 {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #1890ff;
            display: inline-block;
        }

        #follow-history-list {
            background: #fff;
            border: 1px solid #e8e8e8;
            border-radius: 6px;
            padding: 15px;
        }

        #follow-history-list::-webkit-scrollbar {
            width: 6px;
        }

        #follow-history-list::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }

        #follow-history-list::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 3px;
        }

        #follow-history-list::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        .layui-textarea {
            border-radius: 4px;
            border: 1px solid #d9d9d9;
            transition: all 0.3s ease;
        }

        .layui-textarea:focus {
            border-color: #1890ff;
            box-shadow: 0 0 0 2px rgba(24, 144, 255, 0.1);
        }

        /* æŸ¥è¯¢æŒ‰é’®ä¼˜åŒ– */
        .layuiadmin-btn-list {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            box-shadow: 0 2px 6px rgba(102, 126, 234, 0.4);
        }

        .layuiadmin-btn-list:hover {
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.6);
        }

        /* æ“ä½œæŒ‰é’®ä¼˜åŒ– */
        .layui-btn-xs {
            padding: 4px 12px;
            font-size: 12px;
            border-radius: 4px;
            margin: 0 3px;
            line-height: 14px !important;
        }

        .follow-btn {
            transition: all 0.3s ease;
        }

        .follow-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }

        /* å“åº”å¼ä¼˜åŒ– */
        @media (max-width: 768px) {
            .layui-form-item {
                margin-bottom: 10px;
            }

            .layui-inline {
                display: block;
                width: 100%;
                margin-bottom: 10px;
            }

            .timeline-item {
                padding: 12px;
            }

            .follow-content {
                flex-direction: column;
            }

            .follow-history {
                border-left: none;
                border-top: 2px solid #e8e8e8;
                padding-left: 0;
                padding-top: 20px;
                margin-top: 20px;
            }
        }

        /* åŠ è½½åŠ¨ç”»ä¼˜åŒ– */
        .layui-layer-loading {
            border-radius: 50%;
        }
    </style>
</head>
<body class="skin-<?php echo !empty($_COOKIE['skin']) ? $_COOKIE['skin'] : '0'; setcookie('skin','0'); ?>">
<div class="admin-main layui-anim layui-anim-upbit">

    <!-- é«˜çº§æŸ¥è¯¢è¡¨å• -->
    <fieldset class="layui-elem-field">
        <legend>é«˜çº§æŸ¥è¯¢</legend>
        <div class="layui-card" style="box-shadow:none; margin-top:10px;">
            <div class="layui-form layui-card-header layuiadmin-card-header-auto" style="border-bottom:transparent; height:auto;">
                <div class="layui-form-item" style="text-align:left; padding-left:20px;">
                    <div class="layui-inline">
                        <label class="layui-form-label">å®¢æˆ·çº§åˆ«ï¼š</label>
                        <div class="layui-input-inline">
                            <select name="kh_rank" id="kh_rank">
                                <option value="">è¯·é€‰æ‹©å®¢æˆ·çº§åˆ«</option>
                                <!-- value ä½¿ç”¨ç­‰çº§IDï¼Œåå°æŒ‰IDç­›é€‰ -->
                                {volist name="khRankList" id="vo"}
                                <option value="{$vo.id}">{$vo.rank_name}</option>
                                {/volist}
                            </select>
                        </div>
                    </div>
                    <div class="layui-inline">
                        <label class="layui-form-label">æ‰€å±æ¸ é“ï¼š</label>
                        <div class="layui-input-inline">
                            <select name="inquiry_id" id="inquiry_id" lay-filter="inquiry_id">
                                <option value="">è¯·é€‰æ‹©æ‰€å±æ¸ é“</option>
                                {volist name="inquiryList" id="vo"}
                                <option value="{$vo.id}">{$vo.inquiry_name}</option>
                                {/volist}
                            </select>
                        </div>
                    </div>
                    <div class="layui-inline">
                        <label class="layui-form-label">æ‰‹æœºï¼š</label>
                        <div class="layui-input-inline">
                            <input type="text" id="phone" name="phone" placeholder="è¯·è¾“å…¥æ‰‹æœºå·ç " class="layui-input">
                        </div>
                    </div>
                    <div class="layui-inline">
                        <label class="layui-form-label">å®¢æˆ·åç§°ï¼š</label>
                        <div class="layui-input-inline">
                            <input type="text" id="kh_name" name="kh_name" placeholder="è¯·è¾“å…¥å®¢æˆ·åç§°" class="layui-input">
                        </div>
                    </div>
                    <div class="layui-inline">
                        <label class="layui-form-label">è¿è¥äººå‘˜ï¼š</label>
                        <div class="layui-input-4">
                            <input type="text" id="oper_user_input" name="oper_user" placeholder="è¯·é€‰æ‹©è¿è¥äººå‘˜" class="layui-input">
                        </div>
                    </div>
                    <div class="layui-inline">
                        <label class="layui-form-label">è¿è¥ç«¯å£ï¼š</label>
                        <div class="layui-input-inline">
                            <select name="port_id" id="port_id" lay-search>
                                <option value="">è¯·å…ˆé€‰æ‹©æ‰€å±æ¸ é“</option>
                            </select>
                        </div>
                    </div>
                    <div class="layui-inline">
                        <label class="layui-form-label">æ—¥æœŸæŸ¥è¯¢ï¼š</label>
                        <div class="layui-input-inline">
                            <select id="dateRange" lay-filter="dateRange" name="timebucket" class="layui-select">
                                <option value="" selected>è‡ªå®šä¹‰</option>
                                <option value="today">ä»Šå¤©</option>
                                <option value="yesterday">æ˜¨å¤©</option>
                                <option value="week">æœ¬å‘¨</option>
                                <option value="last week">ä¸Šå‘¨</option>
                                <option value="month">æœ¬æœˆ</option>
                                <option value="last month">ä¸Šæœˆ</option>
                                <option value="year">ä»Šå¹´</option>
                                <option value="last year">å»å¹´</option>
                                <option value="-2 hours">ä¸¤ä¸ªå°æ—¶å†…</option>
                            </select>
                        </div>
                        <div class="layui-input-inline">
                            <input type="text" class="layui-input" id="at_time" name="at_time" placeholder="é€‰æ‹©æ—¥æœŸèŒƒå›´">
                        </div>
                    </div>
                    {if $Think.session.aid == 1}
                    <div class="layui-inline">
                        <label class="layui-form-label">ä¸šåŠ¡å‘˜ï¼š</label>
                        <div class="layui-input-inline">
                            <select name="pr_user" id="pr_user">
                                <option value="">è¯·é€‰æ‹©ä¸šåŠ¡å‘˜</option>
                                {volist name="adminResult" id="vo"}
                                <option value="{$vo.username}">{$vo.username}</option>
                                {/volist}
                            </select>
                        </div>
                    </div>
                    {/if}
                </div>
                <div class="layui-inline" style="float:right; padding-bottom:15px;">
                    <button class="layui-btn layuiadmin-btn-list" lay-submit lay-filter="LAY-app-contlist-search">
                        <i class="layui-icon layui-icon-search layuiadmin-button-btn" style="vertical-align: sub;"></i>æŸ¥è¯¢æ•°æ®
                    </button>
                </div>
            </div>
        </div>
    </fieldset>

    <!-- æˆäº¤å®¢æˆ·åˆ—è¡¨è¡¨æ ¼ -->
    <table class="layui-table" id="table-list" lay-filter="table-list"></table>

</div>

<!-- è·Ÿè¿›è®°å½•å¼¹çª—ï¼Œç”¨äºæŸ¥çœ‹åŠæ–°å¢è·Ÿè¿› -->
<div id="follow-dialog" style="display: none;">
    <div class="follow-container">
        <div class="follow-header"><h3>å®¢æˆ·è·Ÿè¿›</h3></div>
        <div class="follow-content">
            <div class="follow-info">
                <div class="info-item"><span class="info-label">å®¢æˆ·ID:</span> <span id="follow-client-id"></span></div>
                <div class="info-item"><span class="info-label">å®¢æˆ·åç§°:</span> <span id="follow-client-name"></span></div>
                <div class="info-item"><span class="info-label">è”ç³»äºº:</span> <span id="follow-contact"></span></div>
                <div class="info-item"><span class="info-label">ä¸»ç”µè¯:</span> <span id="follow-main-phone"></span></div>
                <div class="info-item"><span class="info-label">è¾…åŠ©ç”µè¯:</span> <span id="follow-aux-phone"></span></div>
                <div class="info-item"><span class="info-label">åœ°åŒº:</span> <span id="follow-area"></span></div>
                <div class="info-item"><span class="info-label">æ‰€å±æ¸ é“:</span> <span id="follow-source"></span></div>
                <div class="info-item"><span class="info-label">è¿è¥ç«¯å£:</span> <span id="follow-source-port"></span></div>
                <div class="info-item"><span class="info-label">å®¢æˆ·çº§åˆ«:</span> <span id="follow-rank"></span></div>
                <div class="info-item"><span class="info-label">è´Ÿè´£äºº:</span> <span id="follow-user"></span></div>
                <div class="info-item"><span class="info-label">ååŒäºº:</span> <span id="follow-joint-person"></span></div>
                <div class="info-item"><span class="info-label">åˆ›å»ºæ—¶é—´:</span> <span id="follow-create-time"></span></div>
                <div class="info-item"><span class="info-label">æœ€åè·Ÿè¿›:</span> <span id="follow-last-time"></span></div>
                <div class="info-item">
                    <span class="info-label">è·Ÿè¿›è®°å½•:</span>
                    <textarea id="follow-last-record" class="layui-textarea" readonly style="height: 80px;"></textarea>
                </div>
            </div>
            <div class="follow-history">
                <h4>è·Ÿè¿›å†å²</h4>
                <div id="follow-history-list" style="max-height: 300px; overflow-y: auto;">
                    <!-- è·Ÿè¿›å†å²å†…å®¹é€šè¿‡JSåŠ¨æ€åŠ è½½ -->
                </div>
                <div style="margin-top: 20px;">
                    <h4>æ·»åŠ è·Ÿè¿›è®°å½•</h4>
                    <div class="layui-form-item layui-form-text">
                        <textarea name="reply_msg" id="reply_msg" required lay-verify="required" placeholder="è¯·è¾“å…¥è·Ÿè¿›å†…å®¹" class="layui-textarea" style="height: 100px;"></textarea>
                    </div>
                    <div class="layui-form-item">
                        <input type="hidden" name="leads_id" id="leads_id" value="">
                        <button class="layui-btn" lay-filter="btn_comment" lay-submit id="submit-comment">æäº¤è®°å½•</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- æ“ä½œæ æ¨¡æ¿ï¼šä»…ä¿ç•™â€œå†™è·Ÿè¿›â€æŒ‰é’® -->
<script type="text/html" id="action">
    <a class="layui-btn layui-btn-primary layui-btn-xs follow-btn" href="javascript:void(0);" data-id="{{d.id}}"><i class="layui-icon">&#xe654;</i>å†™è·Ÿè¿›</a>
</script>

{include file="common/foot"/}
<script>
layui.use(['table','form','upload','util','laydate','layer'], function(){
    var table = layui.table, form = layui.form, laydate = layui.laydate, $ = layui.jquery, upload = layui.upload, layer = layui.layer;
    var isMobile = $(window).width() < 768;
    var currentUsername = "{$Think.session.username}" || "default";
    var columnWidthKey = "crm_table_column_widths_" + currentUsername;
    var tableId = "table-list";
    // å®šä¹‰è¡¨æ ¼åˆ—
    var cols = [[
        { type: 'checkbox', fixed: true , width: 50},
        { field: 'id', title: 'ID', width: 80, hide: true, fixed: true },
        { field: 'kh_name', title: 'å®¢æˆ·åç§°', sort: true, templet: function(res){
                return "<a href='{:url('dialogue')}?id=" + res.id + "' class='client-link'>" + (res.kh_name || '') + "</a>";
            }, width:180
        },
        { field: 'product_name', title: 'äº§å“åç§°' , width:180},
        { field: 'inquiry_name', title: 'æ‰€å±æ¸ é“' , width:180},
        { field: 'port_name', title: 'è¿è¥ç«¯å£', width:180 },
        { field: 'main_phone', title: 'ä¸»ç”µè¯' , width:180},
        { field: 'aux_phone', title: 'è¾…åŠ©ç”µè¯' , width:180},
        { field: 'joint_person_names', title: 'ååŒäºº' , width:180},
        { field: 'issuccess', title: 'æˆäº¤çŠ¶æ€', templet: function(res){ return res.issuccess == 1 ? 'å·²æˆäº¤' : 'æœªæˆäº¤'; } , width:180},
        { field: 'last_up_records', title: 'æœ€æ–°è·Ÿè¿›è®°å½•', width:180 },
        { field: 'pr_user', title: 'è´Ÿè´£äºº', width:180 },
        { field: 'at_time', title: 'åˆ›å»ºæ—¶é—´', sort: true, width:180 },
        { field: 'ut_time', title: 'æ›´æ–°æ—¶é—´', sort: true, width:180 },
        { field: 'original_creation_time', title: 'åŸåˆ›å»ºæ—¶é—´', width:180, templet: function(d){
                var v = d.original_creation_time;
                if (!v) return '';
                // å¦‚æœæ˜¯æ—¶é—´æˆ³ï¼Œæ ¼å¼åŒ–ä¸ºæ—¥æœŸ
                if (/^\d+$/.test(v)) return layui.util.toDateString(v * 1000);
                return v;
            }
        },
        { field: 'original_modification_time', title: 'åŸä¿®æ”¹æ—¶é—´', width:180, templet: function(d){
                var v = d.original_modification_time;
                if (!v) return '';
                if (/^\d+$/.test(v)) return layui.util.toDateString(v * 1000);
                return v;
            }
        },
        { fixed: 'right', width: 100, align: 'center', toolbar: '#action' }
    ]];
    // æ¢å¤åˆ—å®½è®¾ç½®ï¼ˆå¦‚æœæœ‰å­˜å‚¨ï¼‰
    // if(typeof restoreColWidth === "function"){ restoreColWidth(cols[0]); }
    // åˆå§‹åŒ–è¡¨æ ¼
    var tableIns = table.render({
        elem: '#' + tableId,
        id: tableId,
        url: "{:url('successCliList')}",
        method: 'post',
        // ä¸æ˜¾ç¤ºé¡¶éƒ¨å·¥å…·æ æŒ‰é’®
        // toolbar: false,
        defaultToolbar: ['filter'],
        page: true,
        limit: 30,
        cols: cols,
        // done: bindResizeSave  // åˆ—å®½æ‹–åŠ¨äº‹ä»¶ç»‘å®šï¼ˆåœ¨ common/foot è„šæœ¬ä¸­å®šä¹‰ï¼‰
    });
    // è·Ÿè¿›æŒ‰é’®ç‚¹å‡»äº‹ä»¶ - æ‰“å¼€è·Ÿè¿›å¼¹çª—
    $(document).on('click', '.follow-btn, .client-link', function() {
        var clientId = $(this).data('id');
        openFollowDialog(clientId);
    });
    // æ‰“å¼€è·Ÿè¿›å¼¹çª—å¹¶åŠ è½½æ•°æ®
    function openFollowDialog(clientId) {
        var loading = layer.load(1, { shade: [0.1, '#fff'] });
        $.ajax({
            url: "{:url('Client/getClientDetailAndComments')}",
            method: 'GET',
            data: { id: clientId },
            success: function(res) {
                layer.close(loading);
                if (res.code === 0) {
                    var clientData = res.data.client;
                    var comments = res.data.comments;
                    // å¡«å……å®¢æˆ·ä¿¡æ¯
                    $('#follow-client-id').text(clientData.id || '');
                    $('#follow-client-name').text(clientData.kh_name || '');
                    $('#follow-contact').text(clientData.kh_contact || '');
                    $('#follow-main-phone').text(clientData.main_phone || 'æš‚æ— ');
                    $('#follow-aux-phone').text(clientData.aux_phone || 'æš‚æ— ');
                    $('#follow-area').text(clientData.xs_area || '');
                    $('#follow-source').text(clientData.inquiry_name || clientData.inquiry_id || '');
                    $('#follow-source-port').text(clientData.port_name || clientData.port_id || 'æš‚æ— ');
                    $('#follow-rank').text(clientData.kh_rank_name || clientData.kh_rank || '');
                    $('#follow-user').text(clientData.pr_user || '');
                    $('#follow-joint-person').text(clientData.joint_person_names || 'æš‚æ— ');
                    $('#follow-create-time').text(clientData.at_time || '');
                    $('#follow-last-time').text(clientData.last_up_time || 'æš‚æ— ');
                    $('#follow-last-record').val(clientData.last_up_records || 'æš‚æ— è®°å½•');
                    $('#leads_id').val(clientData.id);
                    // å¡«å……è·Ÿè¿›å†å²
                    var html = '';
                    if (comments.length > 0) {
                        $.each(comments, function(index, item) {
                            html += '<div class="timeline-item">' +
                                        '<div class="timeline-title">' + item.create_date + '</div>' +
                                        '<div class="timeline-content">' +
                                            '<img src="' + (item.avatar || '/static/admin/images/0.jpg') + '" class="avatar" onerror="this.src=\'/static/admin/images/0.jpg\'">' +
                                            '<strong>' + item.username + 'ï¼š</strong>' + item.reply_msg +
                                        '</div></div>';
                        });
                    } else {
                        html = '<p>æš‚æ— è·Ÿè¿›è®°å½•</p>';
                    }
                    $('#follow-history-list').html(html);
                    // æ˜¾ç¤ºå¼¹çª—
                    layer.open({
                        type: 1,
                        title: 'å®¢æˆ·è·Ÿè¿› - ' + clientData.kh_name,
                        area: ['90%', '80%'],
                        content: $('#follow-dialog'),
                        zIndex: layer.zIndex,
                        success: function(layero, index) {
                            $('#follow-dialog').show();
                            layer.setTop(layero);
                        },
                        end: function() {
                            $('#follow-dialog').hide().appendTo('body');
                        }
                    });
                } else {
                    layer.msg(res.msg || 'è·å–å®¢æˆ·ä¿¡æ¯å¤±è´¥');
                }
            },
            error: function() {
                layer.close(loading);
                layer.msg('ç½‘ç»œé”™è¯¯ï¼Œè·å–å®¢æˆ·ä¿¡æ¯å¤±è´¥');
            }
        });
    }
    // æäº¤æ–°è·Ÿè¿›è®°å½•
    $('#submit-comment').on('click', function() {
        var replyMsg = $('#reply_msg').val();
        var leadsId = $('#leads_id').val();
        if (!replyMsg) {
            layer.msg('è¯·è¾“å…¥è·Ÿè¿›å†…å®¹');
            return false;
        }
        // æäº¤è·Ÿè¿›è¯„è®º
        $.post("{:url('Client/comment')}", { reply_msg: replyMsg, leads_id: leadsId }, function(res) {
            if (res.code === 0) {
                layer.msg('æäº¤æˆåŠŸ', { time: 1000, icon: 1 });
                // å°†æ–°è¯„è®ºè¿½åŠ åˆ°è·Ÿè¿›å†å²åˆ—è¡¨
                var newItem = '<div class="timeline-item">' +
                              '<div class="timeline-title">' + res.data.create_date + '</div>' +
                              '<div class="timeline-content">' +
                                  '<img src="' + (res.data.avatar || '/static/admin/images/0.jpg') + '" class="avatar" onerror="this.src=\'/static/admin/images/0.jpg\'">' +
                                  '<strong>' + (res.data.username || '') + 'ï¼š</strong>' + res.data.reply_msg +
                              '</div></div>';
                $('#follow-history-list').prepend(newItem);
                // æ›´æ–°æœ€åè·Ÿè¿›è®°å½•æ˜¾ç¤º
                $('#follow-last-time').text(res.data.create_date);
                $('#follow-last-record').val(res.data.reply_msg);
                $('#reply_msg').val('');
            } else {
                layer.msg(res.msg || 'æäº¤å¤±è´¥', { icon: 2 });
            }
        });
        return false;
    });
    // æ‹–æ‹½åˆ—å®½åçš„ä¿å­˜
    // function bindResizeSave() {
    //     $(document).off('mouseup.saveWidth').on('mouseup.saveWidth', function () {
    //         setTimeout(saveWidths, 10);
    //     });
    // }
    // function saveWidths() {
    //     var widths = {};
    //     $('#' + tableId).next('.layui-table-view').find('th').each(function () {
    //         var field = $(this).data('field');
    //         if (field) widths[field] = $(this).outerWidth();
    //     });
    //     localStorage.setItem(columnWidthKey, JSON.stringify(widths));
    // }
    // function restoreColWidth(colArr) {
    //     var saved = JSON.parse(localStorage.getItem(columnWidthKey) || '{}');
    //     colArr.forEach(function (c) { if (saved[c.field]) c.width = saved[c.field]; });
    // }
    // é«˜çº§æœç´¢è¡¨å•æäº¤
    form.on('submit(LAY-app-contlist-search)', function(data) {
        table.reload('table-list', {
            url: "{:url('Client/chengjiaoClientSearch')}",
            where: { keyword: data.field },
            page: { curr: 1 }
        });
        return false;
    });
    // æ—¥æœŸé€‰æ‹©ç»„ä»¶åˆå§‹åŒ–ï¼ˆæ”¯æŒèŒƒå›´é€‰æ‹©ï¼‰
    laydate.render({ elem: '#at_time', range: true, trigger: 'click' });
    form.on('select(dateRange)', function(data) {
        var isCustom = (data.value === '');
        $('#at_time').toggle(isCustom);
        if (!isCustom) $('#at_time').val('');
    });
    // åˆå§‹åŒ–è¿è¥äººå‘˜ä¸‹æ‹‰ï¼ˆEditableSelectæ’ä»¶ï¼‰
    const yySelect = new EditableSelect(document.getElementById('oper_user_input'), {$_yyList|raw}, 'è¿è¥äººå‘˜', '', 'name');
    // æ‰€å±æ¸ é“ä¸è¿è¥ç«¯å£è”åŠ¨ï¼šé€‰æ‹©æ¸ é“åå¼‚æ­¥åŠ è½½å¯¹åº”ç«¯å£åˆ—è¡¨
    form.on('select(inquiry_id)', function(data) {
        var inquiryId = data.value;
        var $portSelect = $('#port_id');
        $portSelect.empty();
        if (!inquiryId) {
            $portSelect.append('<option value="">è¯·å…ˆé€‰æ‹©æ‰€å±æ¸ é“</option>');
            form.render('select');
            return;
        }
        $.ajax({
            url: "{:url('Client/getPortsByInquiry')}",
            type: 'GET',
            data: { inquiry_id: inquiryId },
            success: function(res) {
                if (res.code === 0 && res.data) {
                    $portSelect.append('<option value="">è¯·é€‰æ‹©è¿è¥ç«¯å£</option>');
                    $.each(res.data, function(index, port) {
                        $portSelect.append('<option value="' + port.id + '">' + port.port_name + '</option>');
                    });
                } else {
                    $portSelect.append('<option value="">è¯¥æ¸ é“æš‚æ— ç«¯å£æ•°æ®</option>');
                }
                form.render('select');
            },
            error: function() {
                $portSelect.append('<option value="">è·å–ç«¯å£å¤±è´¥</option>');
                form.render('select');
            }
        });
    });
});
</script>
</body>
</html>