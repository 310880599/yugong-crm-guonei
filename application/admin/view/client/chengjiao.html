<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>{:config('sys_name')}后台管理</title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <link rel="stylesheet" href="/static/plugins/layui/css/layui.css" media="all" />
    <link rel="stylesheet" href="/static/admin/css/global.css" media="all">
    <link rel="stylesheet" href="/static/common/css/font.css" media="all">
    <link rel="stylesheet" href="/static/admin/css/select.css" media="all">  <!-- 引入下拉选择组件样式 -->
    <script src="/static/admin/js/select.js"></script>  <!-- 引入下拉选择组件脚本 -->
    <style>
        .filtrate-warp { margin-bottom: 10px; }
        .filtrate-warp .title { padding: 5px 12px 7px 12px; font-size: 14px; font-weight: normal; text-align: left; cursor: pointer; width: 90px; background-color: transparent !important; color: black !important; }
        .filtrate-warp .title:hover { color: black; }
        .filtrate-warp .flag { padding: 6px 12px 6px 12px; cursor: pointer; }
        .filtrate-warp .flag:hover { color: black; }
        .filtrate-warp .layui-badge:hover { color: white !important; }
        /* 跟进弹窗样式 */
        .follow-container { padding: 15px; }
        .follow-header { border-bottom: 1px solid #e6e6e6; padding-bottom: 10px; margin-bottom: 15px; }
        .follow-content { display: flex; }
        .follow-info { flex: 1; padding-right: 15px; }
        .follow-history { flex: 1; border-left: 1px solid #e6e6e6; padding-left: 15px; }
        .info-item { margin-bottom: 10px; }
        .info-label { font-weight: bold; display: inline-block; width: 80px; }
        .timeline-item { margin-bottom: 15px; }
        .timeline-title { color: rosybrown; font-size: 14px; margin-bottom: 5px; }
        .timeline-content { margin-left: 10px; }
        .avatar { width: 30px; height: 30px; border-radius: 50%; margin-right: 5px; vertical-align: middle; }
    </style>
</head>
<body class="skin-<?php echo !empty($_COOKIE['skin']) ? $_COOKIE['skin'] : '0'; setcookie('skin','0'); ?>">
<div class="admin-main layui-anim layui-anim-upbit">

    <!-- 高级查询表单 -->
    <fieldset class="layui-elem-field">
        <legend>高级查询</legend>
        <div class="layui-card" style="box-shadow:none; margin-top:10px;">
            <div class="layui-form layui-card-header layuiadmin-card-header-auto" style="border-bottom:transparent; height:auto;">
                <div class="layui-form-item" style="text-align:left; padding-left:20px;">
                    <div class="layui-inline">
                        <label class="layui-form-label">客户级别：</label>
                        <div class="layui-input-inline">
                            <select name="kh_rank" id="kh_rank">
                                <option value="">请选择客户级别</option>
                                <!-- value 使用等级ID，后台按ID筛选 -->
                                {volist name="khRankList" id="vo"}
                                <option value="{$vo.id}">{$vo.rank_name}</option>
                                {/volist}
                            </select>
                        </div>
                    </div>
                    <div class="layui-inline">
                        <label class="layui-form-label">所属渠道：</label>
                        <div class="layui-input-inline">
                            <select name="inquiry_id" id="inquiry_id" lay-filter="inquiry_id">
                                <option value="">请选择所属渠道</option>
                                {volist name="inquiryList" id="vo"}
                                <option value="{$vo.id}">{$vo.inquiry_name}</option>
                                {/volist}
                            </select>
                        </div>
                    </div>
                    <div class="layui-inline">
                        <label class="layui-form-label">手机：</label>
                        <div class="layui-input-inline">
                            <input type="text" id="phone" name="phone" placeholder="请输入手机号码" class="layui-input">
                        </div>
                    </div>
                    <div class="layui-inline">
                        <label class="layui-form-label">客户名称：</label>
                        <div class="layui-input-inline">
                            <input type="text" id="kh_name" name="kh_name" placeholder="请输入客户名称" class="layui-input">
                        </div>
                    </div>
                    <div class="layui-inline">
                        <label class="layui-form-label">运营人员：</label>
                        <div class="layui-input-4">
                            <input type="text" id="oper_user_input" name="oper_user" placeholder="请选择运营人员" class="layui-input">
                        </div>
                    </div>
                    <div class="layui-inline">
                        <label class="layui-form-label">运营端口：</label>
                        <div class="layui-input-inline">
                            <select name="port_id" id="port_id" lay-search>
                                <option value="">请先选择所属渠道</option>
                            </select>
                        </div>
                    </div>
                    <div class="layui-inline">
                        <label class="layui-form-label">日期查询：</label>
                        <div class="layui-input-inline">
                            <select id="dateRange" lay-filter="dateRange" name="timebucket" class="layui-select">
                                <option value="" selected>自定义</option>
                                <option value="today">今天</option>
                                <option value="yesterday">昨天</option>
                                <option value="week">本周</option>
                                <option value="last week">上周</option>
                                <option value="month">本月</option>
                                <option value="last month">上月</option>
                                <option value="year">今年</option>
                                <option value="last year">去年</option>
                                <option value="-2 hours">两个小时内</option>
                            </select>
                        </div>
                        <div class="layui-input-inline">
                            <input type="text" class="layui-input" id="at_time" name="at_time" placeholder="选择日期范围">
                        </div>
                    </div>
                    {if $Think.session.aid == 1}
                    <div class="layui-inline">
                        <label class="layui-form-label">业务员：</label>
                        <div class="layui-input-inline">
                            <select name="pr_user" id="pr_user">
                                <option value="">请选择业务员</option>
                                {volist name="adminResult" id="vo"}
                                <option value="{$vo.username}">{$vo.username}</option>
                                {/volist}
                            </select>
                        </div>
                    </div>
                    {/if}
                </div>
                <div class="layui-inline" style="float:right; padding-bottom:15px;">
                    <button class="layui-btn layuiadmin-btn-list" lay-submit lay-filter="LAY-app-contlist-search">
                        <i class="layui-icon layui-icon-search layuiadmin-button-btn" style="vertical-align: sub;"></i>查询数据
                    </button>
                </div>
            </div>
        </div>
    </fieldset>

    <!-- 成交客户列表表格 -->
    <table class="layui-table" id="table-list" lay-filter="table-list"></table>

</div>

<!-- 跟进记录弹窗，用于查看及新增跟进 -->
<div id="follow-dialog" style="display: none;">
    <div class="follow-container">
        <div class="follow-header"><h3>客户跟进</h3></div>
        <div class="follow-content">
            <div class="follow-info">
                <div class="info-item"><span class="info-label">客户ID:</span> <span id="follow-client-id"></span></div>
                <div class="info-item"><span class="info-label">客户名称:</span> <span id="follow-client-name"></span></div>
                <div class="info-item"><span class="info-label">联系人:</span> <span id="follow-contact"></span></div>
                <div class="info-item"><span class="info-label">主电话:</span> <span id="follow-main-phone"></span></div>
                <div class="info-item"><span class="info-label">辅助电话:</span> <span id="follow-aux-phone"></span></div>
                <div class="info-item"><span class="info-label">地区:</span> <span id="follow-area"></span></div>
                <div class="info-item"><span class="info-label">所属渠道:</span> <span id="follow-source"></span></div>
                <div class="info-item"><span class="info-label">运营端口:</span> <span id="follow-source-port"></span></div>
                <div class="info-item"><span class="info-label">客户级别:</span> <span id="follow-rank"></span></div>
                <div class="info-item"><span class="info-label">负责人:</span> <span id="follow-user"></span></div>
                <div class="info-item"><span class="info-label">协同人:</span> <span id="follow-joint-person"></span></div>
                <div class="info-item"><span class="info-label">创建时间:</span> <span id="follow-create-time"></span></div>
                <div class="info-item"><span class="info-label">最后跟进:</span> <span id="follow-last-time"></span></div>
                <div class="info-item">
                    <span class="info-label">跟进记录:</span>
                    <textarea id="follow-last-record" class="layui-textarea" readonly style="height: 80px;"></textarea>
                </div>
            </div>
            <div class="follow-history">
                <h4>跟进历史</h4>
                <div id="follow-history-list" style="max-height: 300px; overflow-y: auto;">
                    <!-- 跟进历史内容通过JS动态加载 -->
                </div>
                <div style="margin-top: 20px;">
                    <h4>添加跟进记录</h4>
                    <div class="layui-form-item layui-form-text">
                        <textarea name="reply_msg" id="reply_msg" required lay-verify="required" placeholder="请输入跟进内容" class="layui-textarea" style="height: 100px;"></textarea>
                    </div>
                    <div class="layui-form-item">
                        <input type="hidden" name="leads_id" id="leads_id" value="">
                        <button class="layui-btn" lay-filter="btn_comment" lay-submit id="submit-comment">提交记录</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 操作栏模板：仅保留“写跟进”按钮 -->
<script type="text/html" id="action">
    <a class="layui-btn layui-btn-primary layui-btn-xs follow-btn" href="javascript:void(0);" data-id="{{d.id}}"><i class="layui-icon">&#xe654;</i>写跟进</a>
</script>

{include file="common/foot"/}
<script>
layui.use(['table','form','upload','util','laydate','layer'], function(){
    var table = layui.table, form = layui.form, laydate = layui.laydate, $ = layui.jquery, upload = layui.upload, layer = layui.layer;
    var isMobile = $(window).width() < 768;
    var currentUsername = "{$Think.session.username}" || "default";
    var columnWidthKey = "crm_table_column_widths_" + currentUsername;
    var tableId = "table-list";
    // 定义表格列
    var cols = [[
        { type: 'checkbox', fixed: true },
        { field: 'id', title: 'ID', width: 80, hide: true, fixed: true },
        { field: 'kh_name', title: '客户名称', sort: true, templet: function(res){
                return "<a href='{:url('dialogue')}?id=" + res.id + "' class='client-link'>" + (res.kh_name || '') + "</a>";
            }
        },
        { field: 'product_name', title: '产品名称' },
        { field: 'inquiry_name', title: '所属渠道' },
        { field: 'port_name', title: '运营端口' },
        { field: 'main_phone', title: '主电话' },
        { field: 'aux_phone', title: '辅助电话' },
        { field: 'joint_person_names', title: '协同人' },
        { field: 'issuccess', title: '成交状态', templet: function(res){ return res.issuccess == 1 ? '已成交' : '未成交'; } },
        { field: 'last_up_records', title: '最新跟进记录' },
        { field: 'pr_user', title: '负责人', width: 150 },
        { field: 'at_time', title: '创建时间', sort: true, width: 150 },
        { field: 'ut_time', title: '更新时间', sort: true, width: 150 },
        { field: 'original_creation_time', title: '原创建时间', width: 150, templet: function(d){
                var v = d.original_creation_time;
                if (!v) return '';
                // 如果是时间戳，格式化为日期
                if (/^\d+$/.test(v)) return layui.util.toDateString(v * 1000);
                return v;
            }
        },
        { field: 'original_modification_time', title: '原修改时间', width: 150, templet: function(d){
                var v = d.original_modification_time;
                if (!v) return '';
                if (/^\d+$/.test(v)) return layui.util.toDateString(v * 1000);
                return v;
            }
        },
        { fixed: 'right', width: 100, align: 'center', toolbar: '#action' }
    ]];
    // 恢复列宽设置（如果有存储）
    if(typeof restoreColWidth === "function"){ restoreColWidth(cols[0]); }
    // 初始化表格
    var tableIns = table.render({
        elem: '#' + tableId,
        id: tableId,
        url: "{:url('successCliList')}",
        method: 'post',
        // 不显示顶部工具栏按钮
        // toolbar: false,
        defaultToolbar: ['filter'],
        page: true,
        limit: 30,
        cols: cols,
        done: bindResizeSave  // 列宽拖动事件绑定（在 common/foot 脚本中定义）
    });
    // 跟进按钮点击事件 - 打开跟进弹窗
    $(document).on('click', '.follow-btn, .client-link', function() {
        var clientId = $(this).data('id');
        openFollowDialog(clientId);
    });
    // 打开跟进弹窗并加载数据
    function openFollowDialog(clientId) {
        var loading = layer.load(1, { shade: [0.1, '#fff'] });
        $.ajax({
            url: "{:url('Client/getClientDetailAndComments')}",
            method: 'GET',
            data: { id: clientId },
            success: function(res) {
                layer.close(loading);
                if (res.code === 0) {
                    var clientData = res.data.client;
                    var comments = res.data.comments;
                    // 填充客户信息
                    $('#follow-client-id').text(clientData.id || '');
                    $('#follow-client-name').text(clientData.kh_name || '');
                    $('#follow-contact').text(clientData.kh_contact || '');
                    $('#follow-main-phone').text(clientData.main_phone || '暂无');
                    $('#follow-aux-phone').text(clientData.aux_phone || '暂无');
                    $('#follow-area').text(clientData.xs_area || '');
                    $('#follow-source').text(clientData.inquiry_name || clientData.inquiry_id || '');
                    $('#follow-source-port').text(clientData.port_name || clientData.port_id || '暂无');
                    $('#follow-rank').text(clientData.kh_rank_name || clientData.kh_rank || '');
                    $('#follow-user').text(clientData.pr_user || '');
                    $('#follow-joint-person').text(clientData.joint_person_names || '暂无');
                    $('#follow-create-time').text(clientData.at_time || '');
                    $('#follow-last-time').text(clientData.last_up_time || '暂无');
                    $('#follow-last-record').val(clientData.last_up_records || '暂无记录');
                    $('#leads_id').val(clientData.id);
                    // 填充跟进历史
                    var html = '';
                    if (comments.length > 0) {
                        $.each(comments, function(index, item) {
                            html += '<div class="timeline-item">' +
                                        '<div class="timeline-title">' + item.create_date + '</div>' +
                                        '<div class="timeline-content">' +
                                            '<img src="' + (item.avatar || '/static/admin/images/0.jpg') + '" class="avatar" onerror="this.src=\'/static/admin/images/0.jpg\'">' +
                                            '<strong>' + item.username + '：</strong>' + item.reply_msg +
                                        '</div></div>';
                        });
                    } else {
                        html = '<p>暂无跟进记录</p>';
                    }
                    $('#follow-history-list').html(html);
                    // 显示弹窗
                    layer.open({
                        type: 1,
                        title: '客户跟进 - ' + clientData.kh_name,
                        area: ['90%', '80%'],
                        content: $('#follow-dialog'),
                        zIndex: layer.zIndex,
                        success: function(layero, index) {
                            $('#follow-dialog').show();
                            layer.setTop(layero);
                        },
                        end: function() {
                            $('#follow-dialog').hide().appendTo('body');
                        }
                    });
                } else {
                    layer.msg(res.msg || '获取客户信息失败');
                }
            },
            error: function() {
                layer.close(loading);
                layer.msg('网络错误，获取客户信息失败');
            }
        });
    }
    // 提交新跟进记录
    $('#submit-comment').on('click', function() {
        var replyMsg = $('#reply_msg').val();
        var leadsId = $('#leads_id').val();
        if (!replyMsg) {
            layer.msg('请输入跟进内容');
            return false;
        }
        // 提交跟进评论
        $.post("{:url('Client/comment')}", { reply_msg: replyMsg, leads_id: leadsId }, function(res) {
            if (res.code === 0) {
                layer.msg('提交成功', { time: 1000, icon: 1 });
                // 将新评论追加到跟进历史列表
                var newItem = '<div class="timeline-item">' +
                              '<div class="timeline-title">' + res.data.create_date + '</div>' +
                              '<div class="timeline-content">' +
                                  '<img src="' + (res.data.avatar || '/static/admin/images/0.jpg') + '" class="avatar" onerror="this.src=\'/static/admin/images/0.jpg\'">' +
                                  '<strong>' + (res.data.username || '') + '：</strong>' + res.data.reply_msg +
                              '</div></div>';
                $('#follow-history-list').prepend(newItem);
                // 更新最后跟进记录显示
                $('#follow-last-time').text(res.data.create_date);
                $('#follow-last-record').val(res.data.reply_msg);
                $('#reply_msg').val('');
            } else {
                layer.msg(res.msg || '提交失败', { icon: 2 });
            }
        });
        return false;
    });
    // 拖拽列宽后的保存
    function bindResizeSave() {
        $(document).off('mouseup.saveWidth').on('mouseup.saveWidth', function () {
            setTimeout(saveWidths, 10);
        });
    }
    function saveWidths() {
        var widths = {};
        $('#' + tableId).next('.layui-table-view').find('th').each(function () {
            var field = $(this).data('field');
            if (field) widths[field] = $(this).outerWidth();
        });
        localStorage.setItem(columnWidthKey, JSON.stringify(widths));
    }
    function restoreColWidth(colArr) {
        var saved = JSON.parse(localStorage.getItem(columnWidthKey) || '{}');
        colArr.forEach(function (c) { if (saved[c.field]) c.width = saved[c.field]; });
    }
    // 高级搜索表单提交
    form.on('submit(LAY-app-contlist-search)', function(data) {
        table.reload('table-list', {
            url: "{:url('Client/chengjiaoClientSearch')}",
            where: { keyword: data.field },
            page: { curr: 1 }
        });
        return false;
    });
    // 日期选择组件初始化（支持范围选择）
    laydate.render({ elem: '#at_time', range: true, trigger: 'click' });
    form.on('select(dateRange)', function(data) {
        var isCustom = (data.value === '');
        $('#at_time').toggle(isCustom);
        if (!isCustom) $('#at_time').val('');
    });
    // 初始化运营人员下拉（EditableSelect插件）
    const yySelect = new EditableSelect(document.getElementById('oper_user_input'), {$_yyList|raw}, '运营人员', '', 'name');
    // 所属渠道与运营端口联动：选择渠道后异步加载对应端口列表
    form.on('select(inquiry_id)', function(data) {
        var inquiryId = data.value;
        var $portSelect = $('#port_id');
        $portSelect.empty();
        if (!inquiryId) {
            $portSelect.append('<option value="">请先选择所属渠道</option>');
            form.render('select');
            return;
        }
        $.ajax({
            url: "{:url('Client/getPortsByInquiry')}",
            type: 'GET',
            data: { inquiry_id: inquiryId },
            success: function(res) {
                if (res.code === 0 && res.data) {
                    $portSelect.append('<option value="">请选择运营端口</option>');
                    $.each(res.data, function(index, port) {
                        $portSelect.append('<option value="' + port.id + '">' + port.port_name + '</option>');
                    });
                } else {
                    $portSelect.append('<option value="">该渠道暂无端口数据</option>');
                }
                form.render('select');
            },
            error: function() {
                $portSelect.append('<option value="">获取端口失败</option>');
                form.render('select');
            }
        });
    });
});
</script>
</body>
</html>