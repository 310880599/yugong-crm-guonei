<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>{:config('sys_name')} 后台管理</title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <link rel="stylesheet" href="/static/plugins/layui/css/layui.css" media="all" />
    <link rel="stylesheet" href="/static/admin/css/global.css" media="all">
    <link rel="stylesheet" href="/static/common/css/font.css" media="all">
    <script src="/static/plugins/layui/layui.js"></script>
    <script src="/static/admin/js/xm-select.js"></script>
    <style>
        .layui-form-pane .layui-form-label {
            width: 110px;
            padding: 8px 15px;
            height: 38px;
            line-height: 20px;
            border-width: 0px;
            border-style: none;
            border-radius: 2px 0 0 2px;
            text-align: center;
            background-color: #FBFBFB;
            overflow: hidden;
            box-sizing: border-box;
        }

        /* 确保“电话输入 + 加号按钮”的总宽度 = 客户名称输入框宽度 */
        .input-row {
            display: flex;
            align-items: center;
            gap: 10px;           /* 控制输入框与按钮间距 */
            width: 100%;
            margin-bottom: 10px;
        }


        .add-btn {
            background-color: #009688;
            color: #fff;
        }

        .layui-layer-btn .layui-layer-btn0 {
            background-color: #009688 !important;
        }

        .remove-btn {
            background-color: #FF5722;
            color: #fff;
        }

        .add-btn,
        .remove-btn {
            height: 38px;        /* 与 .layui-input 高度一致 */
            line-height: 38px;
            padding: 0 12px;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            font-size: 14px;
        }

        .phone {
            display: flex;
            align-items: center;
            flex: 1 1 auto;      /* 占满剩余空间 */
            min-width: 0;        /* 防止在 flex 布局里溢出 */
        }

        .phone .layui-input {
            width: 100%;
        }

        .phone_code {
            width: 80px;
            margin-right: 10px;
        }
    </style>
</head>
<body class="skin-<?php echo !empty($_COOKIE['skin'])?$_COOKIE['skin']:'0'; setcookie('skin','0'); ?>">

<div class="admin-main layui-anim layui-anim-upbit">
    <form class="layui-form layui-form-pane" action="" method="post">
        <input type="hidden" name="id" value="{$result.id}" />

        <!-- 客户名称 -->
        <div class="layui-form-item">
            <label class="layui-form-label">客户名称<span style="color:red;">*</span></label>
            <div class="layui-input-4">
                <input type="text" name="kh_name" lay-verify="required" placeholder="请输入客户名称" class="layui-input" value="{$result.kh_name|default=''}">
            </div>
        </div>

        <!-- 主电话 -->
        <div class="layui-form-item">
            <label class="layui-form-label">电话<span style="color:red;">*</span></label>
            <div class="layui-input-4" id="mainPhoneBox">
                <div class="input-row">
                    <div class="phone">
                        <!-- 统一改为 more_phones[]，作为主电话数组的第一项 -->
                        <input type="text" name="more_phones[]" lay-verify="phone" placeholder="电话" class="layui-input multiple_telephone">
                    </div>
                    <button type="button" class="add-btn">+</button>
                </div>
            </div>
            <div class="layui-form-mid layui-word-aux" style="margin-left:110px;">可点击“+”添加多个主电话，所有主电话都会按主电话存入。</div>
        </div>

        <!-- 辅助电话 -->
        <div class="layui-form-item">
            <label class="layui-form-label">辅助电话</label>
            <div class="layui-input-4">
                <input type="text" name="phone2" lay-verify="phone" placeholder="辅助电话" class="layui-input" value="{$auxPhone|default=''}">
            </div>
        </div>

        <!-- 产品名称 -->
        <div class="layui-form-item">
            <label class="layui-form-label">产品名称<span style="color:red;">*</span></label>
            <div class="layui-input-4">
                <select name="product_name" lay-search lay-verify="required">
                    <option value="">请选择产品名称</option>
                    {volist name="productList" id="vo"}
                    <option value="{$vo.id}" {eq name="result.product_name" value="$vo.id"}selected{/eq}>{$vo.product_name} ({$vo.category_name|default='无'})</option>
                    {/volist}
                </select>
            </div>
        </div>

        <!-- 询盘来源 -->
        <div class="layui-form-item">
            <label class="layui-form-label">询盘来源<span style="color:red;">*</span></label>
            <div class="layui-input-4">
                <select name="kh_status" lay-search lay-filter="kh_status" lay-verify="required">
                    <option value="">请选择询盘来源</option>
                    {volist name="khStatusList" id="vo"}
                    <option value="{$vo.id}" {eq name="result.kh_status" value="$vo.id"}selected{/eq}>{$vo.status_name}</option>
                    {/volist}
                </select>
            </div>
        </div>

        <!-- 来源端口：可搜索单选下拉（根据询盘来源动态更新） -->
        <div class="layui-form-item">
            <label class="layui-form-label">来源端口</label>
            <div class="layui-input-4">
                <select name="source_port" lay-search>
                    <option value="">请先选择询盘来源</option>
                </select>
            </div>
        </div>

        <!-- 协同人（多选） -->
        <div class="layui-form-item">
            <label class="layui-form-label">协同人</label>
            <div class="layui-input-4">
                <div id="collaboratorSelect"></div>
            </div>
        </div>

        <!-- 其他信息 -->
        <div class="layui-form-item">
            <label class="layui-form-label">其他信息</label>
            <div class="layui-input-4">
                <textarea name="remark" class="layui-textarea" placeholder="请输入其他信息">{$result.remark|default=''}</textarea>
            </div>
        </div>

        <!-- 提交按钮 -->
        <div class="layui-form-item">
            <div class="layui-input-block">
                <button type="button" class="layui-btn" lay-submit lay-filter="submit">提交保存</button>
            </div>
        </div>
    </form>
</div>

{include file="common/foot"/}

<script>
layui.use(['form', 'layer', 'jquery'], function () {
    var form = layui.form
      , layer = layui.layer
      , $ = layui.jquery;

    // 协同人多选初始化
    var collaboratorData = {$collaboratorList|raw};          // [{name, value}]
    var jointPersonInit = {$jointPersonInit|raw};            // [id, id, ...]
    xmSelect.render({
        el: '#collaboratorSelect',
        name: 'joint_person',
        layVerify: '',
        tips: '请选择协同人员',
        filterable: true,
        clickClose: false,
        initValue: jointPersonInit,                          // 预选
        data: collaboratorData
    });

    // 自定义校验：电话为11位数字（与新增一致）
    form.verify({
        phone: function (value) {
            if (value.trim() && !/^\d{11}$/.test(value)) {
                return '号码应为11位纯数字';
            }
        }
    });

    /* 多行（新增/删除） */
    $(document).on('click', '.add-btn', function (e) {
        e.preventDefault();
        var $container = $(this).closest('.layui-input-4');
        var $newRow = $(
            '<div class="input-row">' +
                '<div class="phone">' +
                    // 额外电话不覆盖主电话 name，避免影响后端接收
                    '<input type="text" name="more_phones[]" lay-verify="phone" placeholder="电话" class="layui-input multiple_telephone">' +
                '</div>' +
                '<button type="button" class="remove-btn">-</button>' +
            '</div>'
        );
        $container.append($newRow);
    });

    $(document).on('click', '.remove-btn', function (e) {
        e.preventDefault();
        $(this).closest('.input-row').remove();
    });


    // 渲染下拉框
    form.render('select');

    // 根据来源联动来源端口（键：来源中文名，与新增一致）
    var shopList = {$shopList|raw}; // 店铺列表分组数据：{ 来源名称: [ {id:..., name:...}, ... ], ... }

    function fillSourcePortBySourceName(sourceName, selectedPortId) {
        var shops = shopList[sourceName] || [];
        var $sourcePort = $('select[name="source_port"]');
        $sourcePort.empty();
        if (shops.length > 0) {
            $sourcePort.append('<option value="">请选择来源端口</option>');
            $.each(shops, function (i, shop) {
                var sel = (String(selectedPortId) === String(shop.id)) ? ' selected' : '';
                $sourcePort.append('<option value="' + shop.id + '"' + sel + '>' + shop.name + '</option>');
            });
        } else {
            $sourcePort.append('<option value="">该来源暂无店铺数据</option>');
        }
        form.render('select');
    }

    // 初次按当前来源填充来源端口选项
    var initSourceName = $('select[name="kh_status"] option:selected').text();
    var initSourcePortId = "{$result.source_port|default=''}";
    fillSourcePortBySourceName(initSourceName, initSourcePortId);

    // 监听来源变化
    form.on('select(kh_status)', function (data) {
        var sourceName = $(data.elem).find("option:selected").text();
        fillSourcePortBySourceName(sourceName, ''); // 切换来源时清空来源端口选择
    });

    /* =========================
    [新增] 编辑页主电话“回填渲染”
    要求：后端把 $mainPhones 以 JSON 传入（见控制器替换）
    ========================= */
    (function prefillMainPhones(){
        var initMainPhones = {$mainPhones|raw}; // 形如 ["13800000000","13900000000"]
        if (!Array.isArray(initMainPhones)) {
            try { initMainPhones = JSON.parse(initMainPhones || '[]'); } catch (e) { initMainPhones = []; }
        }

        var $box = $('#mainPhoneBox');
        var $firstRow   = $box.find('.input-row').first();
        var $firstInput = $firstRow.find('.multiple_telephone').first();

        if (initMainPhones.length > 0) {
            // 第一个主电话填入第一行
            $firstInput.val(initMainPhones[0]);
        }

        // 其余主电话一行一个，并带“-”删除按钮
        for (var i = 1; i < initMainPhones.length; i++) {
            var phone = initMainPhones[i];
            var $row = $(
                '<div class="input-row">' +
                    '<div class="phone">' +
                        '<input type="text" name="more_phones[]" lay-verify="phone" placeholder="电话" class="layui-input multiple_telephone" value="' + phone + '">' +
                    '</div>' +
                    '<button type="button" class="remove-btn">-</button>' +
                '</div>'
            );
            $box.append($row);
        }
    })();

    // 提交保存
    form.on('submit(submit)', function (data) {

        // 1) 采集并清洗所有主电话
        var phones = [];
        $('.multiple_telephone').each(function () {
            var v = $.trim($(this).val()).replace(/\D/g, '');
            if (v) phones.push(v);
        });


        // console.log($('.multiple_telephone').first().val());
        // console.log($('input[name="phone2"]').val());
        // return false;


        // 去重并仅保留11位数字
        phones = Array.from(new Set(phones.filter(function (v) { return /^\d{11}$/.test(v); })));


        //至少一个有效主电话
        if (phones.length === 0) {
            layer.msg('请至少填写一个11位主电话');
            return false;
        }

        // 2) 校验辅助电话，并确保与主电话不同
        var aux = $.trim($('input[name="phone2"]').val()).replace(/\D/g, '');
        if (aux && !/^\d{11}$/.test(aux)) {
            layer.msg('辅助电话必须为11位数字');
            return false;
        }
        if (aux && phones.indexOf(aux) > -1) {
            layer.msg('主电话与辅助电话不能相同');
            return false;
        }

        // 3) 将主电话以 JSON 数组方式提交，后端 parsePhones 支持 JSON / 数组
        data.field.more_phones = JSON.stringify(phones);

        // 4) 清理可能存在的旧字段，避免干扰（容错）
        delete data.field['more_phones[]'];
        delete data.field['phone'];

        $.post("{:url('Client/edit')}", data.field, function (res) {
            if (res.code === 0) {
                layer.msg(res.msg, { time: 1500 }, function () {
                    var index = parent.layer.getFrameIndex(window.name);
                    parent.layer.close(index);
                    parent.layui.table.reload('table-list');
                });
            } else {
                layer.msg(res.msg || '保存失败', { time: 2000 });
            }
        }, 'json');
        return false;
    });
});
</script>
</body>
</html>
