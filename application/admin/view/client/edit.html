<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>{:config('sys_name')} 后台管理</title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <link rel="stylesheet" href="/static/plugins/layui/css/layui.css" media="all" />
    <link rel="stylesheet" href="/static/admin/css/global.css" media="all">
    <link rel="stylesheet" href="/static/common/css/font.css" media="all">
    <script src="/static/plugins/layui/layui.js"></script>
    <script src="/static/admin/js/xm-select.js"></script>
</head>
<body class="skin-<?php echo !empty($_COOKIE['skin'])?$_COOKIE['skin']:'0'; setcookie('skin','0'); ?>">

<div class="admin-main layui-anim layui-anim-upbit">
    <form class="layui-form layui-form-pane" action="" method="post">
        <input type="hidden" name="id" value="{$result.id}" />

        <!-- 客户名称 -->
        <div class="layui-form-item">
            <label class="layui-form-label">客户名称<span style="color:red;">*</span></label>
            <div class="layui-input-4">
                <input type="text" name="kh_name" lay-verify="required" placeholder="请输入客户名称" class="layui-input" value="{$result.kh_name|default=''}">
            </div>
        </div>

        <!-- 主电话 -->
        <div class="layui-form-item">
            <label class="layui-form-label">电话<span style="color:red;">*</span></label>
            <div class="layui-input-4">
                <input type="text" name="phone" lay-verify="phone" placeholder="电话" class="layui-input" value="{$mainPhone|default=''}">
            </div>
        </div>

        <!-- 辅助电话 -->
        <div class="layui-form-item">
            <label class="layui-form-label">辅助电话</label>
            <div class="layui-input-4">
                <input type="text" name="phone2" lay-verify="phone" placeholder="辅助电话" class="layui-input" value="{$auxPhone|default=''}">
            </div>
        </div>

        <!-- 产品名称 -->
        <div class="layui-form-item">
            <label class="layui-form-label">产品名称<span style="color:red;">*</span></label>
            <div class="layui-input-4">
                <select name="product_name" lay-search lay-verify="required">
                    <option value="">请选择产品名称</option>
                    {volist name="productList" id="vo"}
                    <option value="{$vo.id}" {eq name="result.product_name" value="$vo.id"}selected{/eq}>{$vo.product_name} ({$vo.category_name|default='无'})</option>
                    {/volist}
                </select>
            </div>
        </div>

        <!-- 询盘来源 -->
        <div class="layui-form-item">
            <label class="layui-form-label">询盘来源<span style="color:red;">*</span></label>
            <div class="layui-input-4">
                <select name="kh_status" lay-search lay-filter="kh_status" lay-verify="required">
                    <option value="">请选择询盘来源</option>
                    {volist name="khStatusList" id="vo"}
                    <option value="{$vo.id}" {eq name="result.kh_status" value="$vo.id"}selected{/eq}>{$vo.status_name}</option>
                    {/volist}
                </select>
            </div>
        </div>

        <!-- 运营人员（按来源联动） -->
        <div class="layui-form-item">
            <label class="layui-form-label">运营人员<span style="color:red;">*</span></label>
            <div class="layui-input-4">
                <select name="oper_user" lay-search lay-verify="required" id="oper_user_select">
                    <option value="">请选择运营人员</option>
                    {volist name="operUserList" id="user"}
                    <option value="{$user.id}" {eq name="result.oper_user" value="$user.id"}selected{/eq}>{$user.name}</option>
                    {/volist}
                </select>
            </div>
        </div>

        <!-- 协同人（多选） -->
        <div class="layui-form-item">
            <label class="layui-form-label">协同人</label>
            <div class="layui-input-4">
                <div id="collaboratorSelect"></div>
            </div>
        </div>

        <!-- 其他信息 -->
        <div class="layui-form-item">
            <label class="layui-form-label">其他信息</label>
            <div class="layui-input-4">
                <textarea name="remark" class="layui-textarea" placeholder="请输入其他信息">{$result.remark|default=''}</textarea>
            </div>
        </div>

        <!-- 提交按钮 -->
        <div class="layui-form-item">
            <div class="layui-input-block">
                <button type="button" class="layui-btn" lay-submit lay-filter="submit">提交保存</button>
            </div>
        </div>
    </form>
</div>

{include file="common/foot"/}

<script>
layui.use(['form', 'layer', 'jquery'], function () {
    var form = layui.form
      , layer = layui.layer
      , $ = layui.jquery;

    // 协同人多选初始化
    var collaboratorData = {$collaboratorList|raw};          // [{name, value}]
    var jointPersonInit = {$jointPersonInit|raw};            // [id, id, ...]
    xmSelect.render({
        el: '#collaboratorSelect',
        name: 'joint_person',
        layVerify: '',
        tips: '请选择协同人员',
        filterable: true,
        clickClose: false,
        initValue: jointPersonInit,                          // 预选
        data: collaboratorData
    });

    // 自定义校验：电话为11位数字（与新增一致）
    form.verify({
        phone: function (value) {
            if (value.trim() && !/^\d{11}$/.test(value)) {
                return '号码应为11位纯数字';
            }
        }
    });

    // 渲染下拉框
    form.render('select');

    // 根据来源联动运营人员（键：来源中文名，与新增一致）
    var yyList = {$yyList|raw}; // { 来源名称: [ {id,name}, ... ] }

    function fillOperUsersBySourceName(sourceName, selectedId) {
        var users = yyList[sourceName] || [];
        var $oper = $('#oper_user_select');
        $oper.empty();
        $oper.append('<option value="">请选择运营人员</option>');
        $.each(users, function (i, user) {
            var sel = (String(selectedId) === String(user.id)) ? ' selected' : '';
            $oper.append('<option value="' + user.id + '"' + sel + '>' + user.name + '</option>');
        });
        form.render('select');
    }

    // 初次按当前来源填充运营人员选项
    var initSourceName = $('select[name="kh_status"] option:selected').text();
    var initOperUserId = "{$result.oper_user|default=''}";
    fillOperUsersBySourceName(initSourceName, initOperUserId);

    // 监听来源变化
    form.on('select(kh_status)', function (data) {
        var sourceName = $(data.elem).find("option:selected").text();
        fillOperUsersBySourceName(sourceName, '');
    });

    // 提交保存
    form.on('submit(submit)', function (data) {
        $.post("{:url('Client/edit')}", data.field, function (res) {
            if (res.code === 0) {
                layer.msg(res.msg, { time: 1500 }, function () {
                    var index = parent.layer.getFrameIndex(window.name);
                    parent.layer.close(index);
                    parent.layui.table.reload('table-list');
                });
            } else {
                layer.msg(res.msg || '保存失败', { time: 2000 });
            }
        }, 'json');
        return false;
    });
});
</script>
</body>
</html>
