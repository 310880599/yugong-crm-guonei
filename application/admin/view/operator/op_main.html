{include file="common/head"/}
<link rel="stylesheet" type="text/css" href="/static/admin/css/admin.css" />
<link rel="stylesheet" type="text/css" href="/static/admin/css/panel.css" />
<div class="admin-main layui-anim layui-anim-upbit">
    <!-- 冲突查询 -->
    <div class="layui-card">
        <div class="layui-card-body">
            <form class="layui-form" action="{:url('client/conflict')}" method="get">
                <div class="layui-row layui-col-space15">
                    <div class="layui-col-md9">
                        <input type="text" name="keyword" placeholder="输入客户名称/手机号/whatsapp/邮箱" autocomplete="off"
                            class="layui-input">
                    </div>
                    <div class="layui-col-md3">
                        <button type="submit" class="layui-btn layuiadmin-btn-list" lay-submit>

                            <i class="layui-icon layui-icon-search"></i> 查询数据
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!--  核心指标 -->
    <div class="layui-row layui-col-space15">
        <div class="layui-col-md3">
            <div class="layui-card">
                <div class="layui-card-header">我的询盘
                    <span class="layui-badge layui-bg-cyan layuiadmin-badge">月</span>
                </div>
                <div class="layui-card-body">
                    <p class="layuiadmin-big-font">{$data['xp_count']} <span class="layui-text">个</span></p>

                </div>
            </div>
        </div>
        <div class="layui-col-md3">
            <div class="layui-card">
                <div class="layui-card-header">我的业绩
                    <span class="layui-badge layui-bg-cyan layuiadmin-badge">月</span>
                </div>
                <div class="layui-card-body">
                    <p class="layuiadmin-big-font">{$data['profit']} <span class="layui-text">元</span></p>

                </div>
            </div>
        </div>
        <div class="layui-col-sm3 layui-col-md6">
            <form class="layui-form" id="searchForm">
                <fieldset class="layui-elem-field " style="padding:18px 0;">
                    <legend>时间范围查询</legend>
                    <div class="layui-row">
                        <div class="layui-col-md8">
                            <div class="layui-form-item">
                                <label class="layui-form-label">时间范围：</label>
                                <div class="layui-input-inline">
                                    <div class="layui-col-sm3  layui-col-md8">
                                        <select id="dateRange" lay-filter="dateRange" name="timebucket"
                                            class="layui-input">
                                            <option value="">自定义</option>
                                            <option value="today" selected>今天</option>
                                            <option value="yesterday">昨天</option>
                                            <option value="week">本周</option>
                                            <option value="month">本月</option>
                                            <option value="last month">上月</option>
                                            <option value="year">今年</option>
                                        </select>
                                    </div>
                                    <div class="layui-col-sm3 layui-col-md4">
                                        <div class="layui-input-inline">
                                            <input type="text" class="layui-input" id="at_time" name="at_time"
                                                placeholder="选择日期范围">
                                        </div>
                                    </div>
                                </div>
                            </div>

                        </div>
                        <div class="layui-col-md4">
                            <button class="layui-btn layuiadmin-btn-list" lay-submit lay-filter="LAY-search">
                                <i class="layui-icon layui-icon-search layuiadmin-button-btn"
                                    style="vertical-align: sub;"></i>查询数据
                            </button>
                        </div>
                    </div>
                </fieldset>
            </form>
        </div>
    </div>

    <div class="layui-row layui-col-space15">
        <div class="layui-col-md12">
            <div class="layui-card-header tongji"
                style="font-size:18px; font-weight:bold; color:#333; display:flex; align-items:center;">
                <i class="layui-icon layui-icon-data" style="margin-right:8px; color:#009688;"></i>
                {$data['org']} 数据统计
                <button style="margin-left: 20px;" class="layui-btn layuiadmin-btn-list"
                    onclick="ExportSelectTables.exportSelected('运营数据导出')">导出选中表格</button>
            </div>
        </div>
    </div>


    <!-- 主体部分：左边统计，右边待办 -->
    <div class="layui-row layui-col-space15" id="search-con">
        {include file="operator/main_content"/}
    </div>


</div>

{include file="common/foot"/}
<script src="/js/xlsx.full.min.js"></script>
<script src="/static/admin/js/export.js"></script>


<script>

    layui.use(['table', 'laydate', 'form'], function () {

        var table = layui.table,
            laydate = layui.laydate,
            form = layui.form,
            $ = layui.jquery;

        // 搜索表单
        form.on('submit(LAY-search)', function (data) {
            $.ajax({
                url: "{:url('Operator/main')}",
                type: "POST",
                data: { keyword: data.field },
                success: function (res) {
                    $("#search-con").html(res);
                }
            });
            return false;
        });
        // 日期控件
        laydate.render({
            elem: '#at_time',
            range: true, // 开启范围选择
            trigger: 'click',
        });

        // 控制日期范围选择框的显示与隐藏
        form.on('select(dateRange)', function (data) {
            const isCustom = data.value === '';
            $('#at_time').toggle(isCustom);
            if (!isCustom) {
                $('#at_time').val('');
            }

        });

        // 初始隐藏日期范围选择框
        $('#at_time').hide();
        // 委托绑定
        $(document).on('click', '.toggle-table', function () {
            var $btn = $(this);
            var $scroll = $btn.closest('.fold-card').find('.table-scroll');

            if ($scroll.length === 0) {
                console.warn("未找到 table-scroll 容器");
                return;
            }
            $scroll.toggleClass('expanded');
            if ($scroll.hasClass('expanded')) {
                $btn.text('折叠');
            } else {
                $btn.text('展开');
            }
        });

    })
    // 询盘排行筛选功能
    function filterList(selector, table) {
        var selectedTeam = $(selector).val();
        var totalSum = 0;

        // 遍历业务询盘排行表格的每一行
        $(table + ' tbody tr').each(function () {
            var $row = $(this);
            var teamName = $row.find('td:first').text();
            // 提取团队名称（从括号中提取）
            var match = teamName.match(/\(([^)]+)\)/);
            if (match) {
                teamName = match[1];
            }

            if (selectedTeam === '' || teamName === selectedTeam) {
                $row.show();
                // 累加显示的行的询盘数量
                var num = parseInt($row.find('td:last').text()) || 0;
                totalSum += num;
            } else {
                $row.hide();
            }
        });

        // 更新合计显示
        $(table).closest('.layui-card').find('.total span').text(totalSum);
    }
    $(document).on('change', '#yw_team_filter', function () {
        filterList('#yw_team_filter', '#yw_list_table');
    });
    $(document).on('change', '#yy_team_filter', function () {
        filterList('#yy_team_filter', '#yy_list_table');
    });

    $(document).on('click', '.detail-link', function () {
        var url = $(this).data('url');
        var params = {
            'timebucket': $('#dateRange').val(),
            'at_time': $('#at_time').val(),
        }
        url += '?' + $.param(params);
        // 打开弹窗;
        layer.open({
            type: 2,
            title: '询盘详情',
            area: ['100%', '80%'],
            maxmin: true,
            content: url,

        });
    })
</script>
</body>

</html>