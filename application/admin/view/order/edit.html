<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>{:config('sys_name')} 后台管理</title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link rel="stylesheet" href="/static/plugins/layui/css/layui.css" media="all" />
    <link rel="stylesheet" href="/static/admin/css/global.css" media="all" />
    <link rel="stylesheet" href="/static/common/css/font.css" media="all" />
    <link rel="stylesheet" href="/static/admin/css/select.css" media="all" />
    <script src="/js/jquery.min.js"></script>
    <script src="/static/admin/js/select.js"></script>
    <script src="/static/plugins/layui/layui.js"></script>
    <script src="/static/admin/js/xm-select.js"></script>
    <style>
        .layui-form-pane .layui-form-label {
            width: 110px;
            padding: 8px 15px;
            height: 38px;
            line-height: 20px;
            text-align: left;
            background-color: #FBFBFB;
            box-sizing: border-box;
        }
        /* 将下拉中括号内的分类名称加粗显示 */
        .cat-bold { font-weight: bold; }
        /* =================== 修复：强制 LayUI 下拉选中值左对齐 =================== */
        body .layui-form-select .layui-select-title input.layui-input,
        body .layui-form-select .layui-select-title input.layui-input[readonly],
        body .layui-form-select .layui-select-title > input.layui-input.layui-unselect {
            text-align: left !important;
            text-indent: 0 !important;
            padding-left: 12px !important;
            padding-right: 12px !important;
        }
        /* 下拉面板里的文字左对齐 */
        body .layui-form-select dl dd,
        body .layui-form-select dl dt {
            text-align: left !important;
        }
        /* ====================================================================== */
    </style>
    
    <style>
        /* 强制 LayUI 下拉选择框选中项文本为黑色，背景/边框为默认颜色 */
        body .layui-form-select .layui-select-title input.layui-input,
        body .layui-form-select .layui-select-title input.layui-input[readonly],
        body .layui-form-select .layui-select-title input.layui-input.layui-unselect {
            color: #000000 !important;       /* 文本颜色改为黑色 */
            background-color: #FFFFFF !important;  /* 背景颜色改为白色 */
            border-color: #E6E6E6 !important;      /* 边框颜色改为默认的浅灰色 */
        }
        body .layui-form-select dl {
            background-color: #FFFFFF !important;  /* 下拉列表背景改为白色 */
            border: 1px solid #D2D2D2 !important;  /* 下拉列表边框改为默认浅灰色 */
        }
        body .layui-form-select dl dd,
        body .layui-form-select dl dt {
            color: #000000 !important;       /* 下拉选项文本改为黑色 */
            background-color: #FFFFFF !important;  /* 下拉选项背景改为白色 */
        }
    </style>

</head>
<body class="skin-{$Think.cookie.skin|default='0'}">
    <div class="admin-main layui-anim layui-anim-upbit">
        <form class="layui-form layui-form-pane">
            <!-- 隐藏域：订单ID -->
            <input type="hidden" name="id" value="{$orderInfo.id}">
            <!-- 客户联系方式 -->
            <div class="layui-form-item">
                <label class="layui-form-label">联系方式<span style="color:red;">*</span></label>
                <div class="layui-input-4">
                    <input type="text" id="contact" name="contact" lay-verify="required" onchange="changeyewu()"
                           value="{$orderInfo.contact|htmlentities}" placeholder="请输入客户联系方式" class="layui-input">
                </div>
            </div>
            <!-- 发货地址 -->
            <div class="layui-form-item">
                <label class="layui-form-label">发货地址<span style="color:red;">*</span></label>
                <div class="layui-input-4">
                    <textarea id="country" name="country" lay-verify="required" placeholder="请输入发货详细地址"
                              class="layui-textarea">{:htmlentities($orderInfo.country)}</textarea>
                </div>
            </div>
            <!-- 客户名称 -->
            <div class="layui-form-item">
                <label class="layui-form-label">客户名称<span style="color:red;">*</span></label>
                <div class="layui-input-4">
                    <input type="text" id="cname" name="cname" lay-verify="required"
                           value="{$orderInfo.cname|htmlentities}" placeholder="请输入客户名称" class="layui-input">
                </div>
            </div>
            <!-- 客户公司 -->
            <div class="layui-form-item">
                <label class="layui-form-label">客户公司</label>
                <div class="layui-input-4">
                    <input type="text" id="client_company" name="client_company" lay-verify="required"
                           value="{$orderInfo.client_company|htmlentities}" placeholder="请输入客户公司" class="layui-input">
                </div>
            </div>
            <!-- 客户负责人 -->
            <div class="layui-form-item">
                <label class="layui-form-label">客户负责人</label>
                <div class="layui-input-4">
                    <input type="text" id="pr_user" name="pr_user" lay-verify="required"
                           value="{$orderInfo.pr_user|default=''}" class="layui-input">
                </div>
            </div>
            <!-- 询盘来源 -->
            <div class="layui-form-item">
                <label class="layui-form-label">询盘来源</label>
                <div class="layui-input-4">
                    <select name="source" id="source" lay-verify="required" lay-filter="kh_status" lay-search>
                        <option value="">请选择询盘来源</option>
                        {volist name="sourceList" id="vo"}
                        <option value="{$vo|htmlentities}" {if $vo == $orderInfo.source} selected {/if}>{$vo|htmlentities}</option>
                        {/volist}
                    </select>
                </div>
            </div>
            <!-- 收款账户 (Receiving Account) -->
            <div class="layui-form-item">
                <label class="layui-form-label">收款账户</label>
                <div class="layui-input-4">
                    <select name="bank_account" id="bank_account" lay-verify="required" lay-search>
                        <option value="">请选择收款账户</option>
                        {volist name="accountList" id="acc"}
                        <option value="{$acc.id}" {if $acc.id == $orderInfo.bank_account}selected{/if}>{$acc.account}</option>
                        {/volist}
                    </select>
                </div>
            </div>
            <!-- 运营人员 -->
            <div class="layui-form-item">
                <label class="layui-form-label">运营人员<span style="color:red;">*</span></label>
                <div class="layui-input-4">
                    <select name="oper_user" lay-search lay-verify="required">
                        <option value="">请选择运营人员</option>
                        {volist name="operUserList" id="user"}
                        <option value="{$user.id}" {if $user.id == $orderInfo.oper_user} selected {/if}>{$user.name}</option>
                        {/volist}
                    </select>
                </div>
            </div>
            <!-- 协同人 -->
            <div class="layui-form-item">
                <label class="layui-form-label">协同人<span style="color:red;">*</span></label>
                <div class="layui-input-4">
                    <div id="collaboratorSelect"></div>
                </div>
            </div>
            <!-- 团队名称 -->
            <div class="layui-form-item">
                <label class="layui-form-label">团队名称</label>
                <div class="layui-input-4">
                    <select name="team_name" id="team_name" lay-verify="required" lay-search>
                        <option value="">请选择团队名称</option>
                        {volist name="teamList" id="vo"}
                        <option value="{$vo}" {if $vo == $orderInfo.team_name} selected {/if}>{$vo}</option>
                        {/volist}
                    </select>
                </div>
            </div>
            <!-- 客户性质 -->
            <div class="layui-form-item">
                <label class="layui-form-label">客户性质</label>
                <div class="layui-input-4">
                    <select name="customer_type" id="customer_type" lay-verify="required" lay-search>
                        <option value="">请选择客户性质</option>
                        {volist name="customer_type" id="vo"}
                        <option value="{$vo}" {if $vo == $orderInfo.customer_type} selected {/if}>{$vo}</option>
                        {/volist}
                    </select>
                </div>
            </div>
            <!-- 成交时间 -->
            <div class="layui-form-item">
                <label class="layui-form-label">成交时间</label>
                <div class="layui-input-4">
                    <input type="text" id="orderTime" name="order_time" value="{$orderInfo.order_time}"
                           placeholder="请选择成交时间" class="layui-input">
                </div>
            </div>
            <!-- 产品明细表格 -->
            <div class="layui-form-item">
                <label class="layui-form-label">产品明细</label>
                <div class="layui-input-block">
                    <table id="product-table" class="layui-table">
                        <thead>
                            <tr>
                                <th>产品名称</th>
                                <th>产品经理</th>
                                <th>规格型号</th>
                                <th>单位</th>
                                <th>数量</th>
                                <th>销售单价</th>
                                <th>销售价合计</th>
                                <th>进价合计</th>
                                <th>子项利润</th>
                                <th>行备注</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="productTableBody">
                            {volist name="orderItems" id="item"}
                            <tr>
                                <td>
                                    <select name="product_name[]" lay-search lay-verify="required">
                                        <option value="">请选择产品名称</option>
                                        {volist name="productList" id="vo"}
                                        <option value="{$vo.id}" {if $vo.id == $item.product_id} selected {/if}>{$vo.product_name} ({$vo.category_name|default='无'})</option>
                                        {/volist}
                                    </select>
                                </td>
                                <td>
                                    <select name="product_manager[]" lay-search lay-verify="required">
                                        <option value="">请选择产品经理</option>
                                        {volist name="managerList" id="vo"}
                                        <option value="{$vo.admin_id}" {if $vo.admin_id == $item.manager_id} selected {/if}>{$vo.username}</option>
                                        {/volist}
                                    </select>
                                </td>
                                <td><input type="text" name="spec_model[]" value="{$item.spec_model|htmlentities}" class="layui-input"></td>
                                <td><input type="text" name="unit[]" value="{$item.unit|htmlentities}" class="layui-input"></td>
                                <td><input type="number" name="qty[]" value="{$item.qty}" class="layui-input" lay-verify="required|number"></td>
                                <td><input type="number" name="unit_price[]" value="{$item.unit_price}" class="layui-input" lay-verify="required|number" step="0.01"></td>
                                <td><input type="number" name="total_price[]" value="{$item.total_price}" class="layui-input" readonly></td>
                                <td><input type="number" name="purchase_price[]" value="{$item.purchase_price}" class="layui-input" lay-verify="required|number" step="0.01"></td>
                                <td><input type="number" name="sub_profit[]" value="{$item.sub_profit}" class="layui-input" readonly></td>
                                <td><input type="text" name="item_remark[]" value="{$item.remark|htmlentities}" class="layui-input"></td>
                                <td><button type="button" class="layui-btn layui-btn-danger layui-btn-sm delete-row">删除</button></td>
                            </tr>
                            {/volist}
                            {if condition="!isset($orderItems) or count($orderItems) == 0"}
                            <tr>
                                <td>
                                    <select name="product_name[]" lay-search lay-verify="required">
                                        <option value="">请选择产品名称</option>
                                        {volist name="productList" id="vo"}
                                        <option value="{$vo.id}">{$vo.product_name} ({$vo.category_name|default='无'})</option>
                                        {/volist}
                                    </select>
                                </td>
                                <td>
                                    <select name="product_manager[]" lay-search lay-verify="required">
                                        <option value="">请选择产品经理</option>
                                        {volist name="managerList" id="vo"}
                                        <option value="{$vo.admin_id}">{$vo.username}</option>
                                        {/volist}
                                    </select>
                                </td>
                                <td><input type="text" name="spec_model[]" class="layui-input"></td>
                                <td><input type="text" name="unit[]" class="layui-input"></td>
                                <td><input type="number" name="qty[]" class="layui-input" lay-verify="required|number"></td>
                                <td><input type="number" name="unit_price[]" class="layui-input" lay-verify="required|number" step="0.01"></td>
                                <td><input type="number" name="total_price[]" class="layui-input" readonly></td>
                                <td><input type="number" name="purchase_price[]" class="layui-input" lay-verify="required|number" step="0.01"></td>
                                <td><input type="number" name="sub_profit[]" class="layui-input" readonly></td>
                                <td><input type="text" name="item_remark[]" class="layui-input"></td>
                                <td><button type="button" class="layui-btn layui-btn-danger layui-btn-sm delete-row">删除</button></td>
                            </tr>
                            {/if}
                        </tbody>
                    </table>
                    <button type="button" id="addRow" class="layui-btn layui-btn-normal">新增一行</button>
                </div>
            </div>
            <!-- 费用和金额字段 -->
            <div class="layui-form-item">
                <label class="layui-form-label">估算运费<span style="color:red;">*</span></label>
                <div class="layui-input-4">
                    <input type="text" id="shipping_cost" name="shipping_cost" lay-verify="required"
                           value="{$orderInfo.shipping_cost|default='0'}" placeholder="请输入估算运费" class="layui-input">
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label">票种/票金额<span style="color:red;">*</span></label>
                <div class="layui-input-4">
                    <input type="text" id="invoice_amount" name="invoice_amount" lay-verify="required"
                           value="{$orderInfo.invoice_amount|default='0'}" placeholder="请输入开票金额" class="layui-input">
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label">税费金额<span style="color:red;">*</span></label>
                <div class="layui-input-4">
                    <input type="text" id="tax_amount" name="tax_amount" lay-verify="required"
                           value="{$orderInfo.tax_amount|default='0'}" placeholder="请输入税费金额" class="layui-input">
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label">调试费<span style="color:red;">*</span></label>
                <div class="layui-input-4">
                    <input type="text" id="debugging_cost" name="debugging_cost" lay-verify="required"
                           value="{$orderInfo.debugging_cost|default='0'}" placeholder="请输入调试费" class="layui-input">
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label">佣金<span style="color:red;">*</span></label>
                <div class="layui-input-4">
                    <input type="text" id="sales_commission" name="sales_commission" lay-verify="required"
                           value="{$orderInfo.sales_commission|default='0'}" placeholder="请输入佣金" class="layui-input">
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label">分成备注<span style="color:red;">*</span></label>
                <div class="layui-input-4">
                    <input type="text" id="split_remarks" name="split_remarks" lay-verify="required"
                           value="{$orderInfo.split_remarks|default=''}" placeholder="请输入分成备注" class="layui-input">
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label">已收款金额<span style="color:red;">*</span></label>
                <div class="layui-input-4">
                    <input type="text" id="amount_received" name="amount_received" lay-verify="required"
                           value="{$orderInfo.amount_received|default='0'}" placeholder="请输入已收款金额" class="layui-input">
                </div>
            </div>
            <!-- 订单金额、利润、利润率 -->
            <div class="layui-form-item">
                <label class="layui-form-label">订单金额(￥)</label>
                <div class="layui-input-4">
                    <input type="text" id="money" name="money" lay-verify="number|required"
                           value="{$orderInfo.money|default='0'}" placeholder="订单总金额" class="layui-input">
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label">利润(￥)</label>
                <div class="layui-input-4">
                    <input type="text" id="profit" name="profit" lay-verify="required"
                           value="{$orderInfo.profit|default='0'}" placeholder="利润额" class="layui-input">
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label">利润率(%)</label>
                <div class="layui-input-4" style="position: relative;">
                    <input type="text" id="margin_rate" name="margin_rate" lay-verify="required"
                           value="{$orderInfo.margin_rate|default='0'}" placeholder="利润率" class="layui-input">
                    <span style="position: absolute; right: 5px; top: 50%; transform: translateY(-50%);">%</span>
                </div>
            </div>
            <!-- 备注 -->
            <div class="layui-form-item">
                <label class="layui-form-label">备注</label>
                <div class="layui-input-4">
                    <textarea name="remark" placeholder="请输入备注信息" class="layui-textarea">{:htmlentities($orderInfo.remark)}</textarea>
                </div>
            </div>
            <!-- 提交按钮 -->
            <div class="layui-form-item">
                <div class="layui-input-block">
                    <button type="button" class="layui-btn" lay-submit lay-filter="submit">提交保存</button>
                </div>
            </div>
        </form>
    </div>
    {include file="common/foot"/}
    <script type="text/javascript">
        // 根据联系方式自动获取客户信息
        function changeyewu() {
            var contact = $("#contact").val();
            $('#cname').val('');
            $.ajax({
                type: "GET",
                dataType: "json",
                url: "{:url('Order/changeyewu')}" + "?contact=" + encodeURIComponent(contact),
                success: function (result) {
                    if (result['msg']['code'] == 0) {
                        $('#checklabel').css('color', 'red');
                    } else {
                        $('#checklabel').css('color', 'green');
                        // 填充返回的客户信息
                        $('#cname').val(result['msg']['custname']);
                        $('#pr_user').val(result['msg']['pr_user']);
                        $('#oper_user_input').val(result['msg']['oper_user']);
                        $('#country').val(result['msg']['country']);
                        $('#kh_username').val(result['msg']['kh_username']);
                        // 根据返回的来源文本匹配下拉选中项
                        var sourceValue = result['msg']['source'] || "";
                        var lowerSourceValue = sourceValue.toLowerCase();
                        var $sourceSelect = $('#source');
                        var matched = false;
                        $sourceSelect.find('option').each(function () {
                            var optionValue = $(this).val();
                            if (optionValue !== '' && lowerSourceValue.includes(optionValue.toLowerCase())) {
                                $sourceSelect.val(optionValue);
                                matched = true;
                                return false;
                            }
                        });
                        if (!matched) {
                            $sourceSelect.val('');
                        }
                        layui.form.render('select');
                        fixSelectAlign(); // 渲染后调整下拉框对齐
                    }
                    $('#checklabel').html(result['msg']['msg']);
                },
                error: function () {
                    alert("异常！");
                }
            });
        }
        layui.use(['form', 'layer', 'laydate'], function () {
            var form = layui.form, layer = layui.layer, $ = layui.jquery, laydate = layui.laydate;
            // 成交时间选择器
            laydate.render({
                elem: '#orderTime',
                type: 'datetime',
                format: 'yyyy-MM-dd HH:mm:ss'
            });
            // 自定义验证规则：数值验证
            form.verify({
                number: function (value) {
                    if (!/^\d+(\.\d+)?$/.test(value)) {
                        return '请输入有效的数字';
                    }
                }
            });
            // 协同人多选下拉初始化
            var collaboratorData = {$collaboratorList|raw};
            xmSelect.render({
                el: '#collaboratorSelect',
                name: 'joint_person',
                layVerify: 'required',
                tips: '请选择协同人员',
                filterable: true,
                clickClose: false,
                data: collaboratorData
            });



            // 渲染表单
            form.render('select');
            fixSelectAlign(); // 首次渲染后调整下拉框文本左对齐





            // 分类名加粗显示处理
            function boldCategory($select) {
                var $options = $select.next('.layui-form-select').find('dl dd');
                $options.each(function () {
                    var text = $(this).text();
                    var m = text.match(/^(.*)\s*\((.+)\)\s*$/);
                    if (m) {
                        $(this).html(m[1] + ' (<span class="cat-bold">' + m[2] + '</span>)');
                    }
                });
            }
            // 初始化时对已有的产品名称下拉选项应用加粗样式
            boldCategory($('select[name="product_name[]"]'));
            // 新增产品明细行
            var productOptions = $('select[name="product_name[]"]').first().html();
            var managerOptions = $('select[name="product_manager[]"]').first().html();
            $('#addRow').on('click', function () {
                var $tbody = $('#productTableBody');
                var newRow = document.createElement('tr');
                newRow.innerHTML =
                    '<td><select name="product_name[]" lay-search lay-verify="required">' + productOptions + '</select></td>' +
                    '<td><select name="product_manager[]" lay-search lay-verify="required">' + managerOptions + '</select></td>' +
                    '<td><input type="text" name="spec_model[]" class="layui-input"></td>' +
                    '<td><input type="text" name="unit[]" class="layui-input"></td>' +
                    '<td><input type="number" name="qty[]" class="layui-input" lay-verify="required|number"></td>' +
                    '<td><input type="number" name="unit_price[]" class="layui-input" lay-verify="required|number" step="0.01"></td>' +
                    '<td><input type="number" name="total_price[]" class="layui-input" readonly></td>' +
                    '<td><input type="number" name="purchase_price[]" class="layui-input" lay-verify="required|number" step="0.01"></td>' +
                    '<td><input type="number" name="sub_profit[]" class="layui-input" readonly></td>' +
                    '<td><input type="text" name="item_remark[]" class="layui-input"></td>' +
                    '<td><button type="button" class="layui-btn layui-btn-danger layui-btn-sm delete-row">删除</button></td>';
                $tbody.append(newRow);
                form.render('select');
                fixSelectAlign(); // 确保新行下拉框文本左对齐
                boldCategory($(newRow).find('select[name="product_name[]"]'));
            });
            // 删除产品行
            $('#productTableBody').on('click', '.delete-row', function () {
                $(this).closest('tr').remove();
                updateTotals();  // 更新总计
            });
            // 更新单行的销售合计和子项利润
            function updateRow($tr) {
                var qty = parseFloat($tr.find('input[name="qty[]"]').val()) || 0;
                var unitPrice = parseFloat($tr.find('input[name="unit_price[]"]').val()) || 0;
                var purchase = parseFloat($tr.find('input[name="purchase_price[]"]').val()) || 0;
                var total = qty * unitPrice;
                var profit = total - purchase;
                $tr.find('input[name="total_price[]"]').val(total.toFixed(2));
                $tr.find('input[name="sub_profit[]"]').val(profit.toFixed(2));
            }
            // 更新所有产品行的总金额和总利润
            function updateTotals() {
                var sumTotal = 0, sumProfit = 0;
                $('#productTableBody tr').each(function () {
                    var $tr = $(this);
                    var qty = parseFloat($tr.find('input[name="qty[]"]').val()) || 0;
                    var unitPrice = parseFloat($tr.find('input[name="unit_price[]"]').val()) || 0;
                    var purchase = parseFloat($tr.find('input[name="purchase_price[]"]').val()) || 0;
                    sumTotal += qty * unitPrice;
                    sumProfit += (qty * unitPrice) - purchase;
                });
                $('#money').val(sumTotal.toFixed(2));
                var shippingCost = parseFloat($('#shipping_cost').val()) || 0;
                var taxAmount   = parseFloat($('#tax_amount').val()) || 0;
                var debugging   = parseFloat($('#debugging_cost').val()) || 0;
                var commission  = parseFloat($('#sales_commission').val()) || 0;
                var finalProfit = sumProfit - shippingCost - taxAmount - debugging - commission;
                $('#profit').val(finalProfit.toFixed(2));
                var marginRate = (sumTotal > 0) ? (finalProfit / sumTotal) * 100 : 0;
                $('#margin_rate').val(marginRate.toFixed(2));
            }
            // 数量、单价或进价改变时，更新对应行和总计
            $('#productTableBody').on('input', 'input[name="qty[]"], input[name="unit_price[]"], input[name="purchase_price[]"]', function () {
                updateRow($(this).closest('tr'));
                updateTotals();
            });
            // 页面初始时计算总计
            updateTotals();
            // 运费、税费、调试费、佣金改变时，更新总利润和利润率
            $('#shipping_cost, #tax_amount, #debugging_cost, #sales_commission').on('input', updateTotals);
            // 表单提交监听
            form.on('submit(submit)', function (data) {

                // 提交前先更新总计，避免遗漏最新数据
                updateTotals();
                $.post("{:url('Order/edit')}", data.field, function (res) {
                    if (res.code === 0) {
                        layer.msg(res.msg, { time: 2000 }, function () {
                            layer.close(layer.index);
                            window.parent.location.reload();
                        });
                    } else {
                        layer.msg(res.msg, { time: 2000 });
                    }
                }, 'json');
                return false;
            });
            // 工具函数：修正下拉框文本左对齐
            function fixSelectAlign(ctx) {
                var $ctx = ctx ? $(ctx) : $(document);
                $ctx.find('.layui-form-select .layui-select-title input.layui-input').each(function () {
                    this.style.setProperty('text-align', 'left', 'important');
                    this.style.setProperty('text-indent', '0px', 'important');
                    this.style.setProperty('padding-left', '12px', 'important');
                    this.style.setProperty('padding-right', '12px', 'important');
                });
            }
            // 将对齐修正函数暴露到全局，便于在其他异步回调中调用
            window.fixSelectAlign = fixSelectAlign;
        });
    </script>
</body>
</html>
