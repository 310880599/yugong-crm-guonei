<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>{:config('sys_name')} 后台管理</title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <link rel="stylesheet" href="/static/plugins/layui/css/layui.css" media="all" />
    <link rel="stylesheet" href="/static/admin/css/global.css" media="all">
    <link rel="stylesheet" href="/static/common/css/font.css" media="all">
    <link rel="stylesheet" href="/static/admin/css/select.css" media="all">
    <script src="/js/jquery.min.js"></script>
    <script src="/static/admin/js/select.js"></script>
    <script src="/static/plugins/layui/layui.js"></script>
    <script src="/static/admin/js/xm-select.js"></script>
    <script src="/static/admin/js/china-provinces-cities.js"></script>
    <style>
        .layui-form-pane .layui-form-label {
            width: 110px;
            padding: 8px 15px;
            height: 38px;
            line-height: 20px;
            border-width: 0;
            border-style: none;
            border-radius: 2px 0 0 2px;
            text-align: left;
            background-color: #FBFBFB;
            box-sizing: border-box;
        }

        /* Ensure category name in dropdown is bold */
        .cat-bold {
            font-weight: bold;
        }
        
        /* 确保左侧填写说明完整显示 */
        .admin-main {
            overflow: visible !important;
            min-height: auto !important;
            max-height: none !important;
        }
        
        body {
            overflow: visible !important;
        }
        
        /* 如果页面在iframe中，确保内容可以完整显示 */
        html, body {
            height: auto !important;
            min-height: 100% !important;
        }
        .layui-form-pane .layui-form-label {
    width: 146px;
    padding: 8px 15px;
    height: 38px;
    line-height: 20px;
    border-width: 0;
    border-style: none;
    border-radius: 2px 0 0 2px;
    text-align: left;
    background-color: #FBFBFB;
    box-sizing: border-box;
}
    </style>
</head>

<body class="skin-<?php if(!empty($_COOKIE['skin'])){echo $_COOKIE['skin'];}else{echo '0';setcookie('skin','0');}?>">

    <script type="text/javascript">
        // 全局变量：存储客户验证状态
        var customerValidated = false;
        
        // **加粗产品下拉中括号内的分类名称部分** - 移到全局作用域
        function boldCategory($select) {
            // 找到 LayUI 渲染后下拉的所有选项元素，并将括号内的文字加粗
            var $options = $select.next('.layui-form-select').find('dl dd');
            $options.each(function () {
                var text = $(this).text();
                var match = text.match(/^(.*)\s*\((.+)\)\s*$/);
                if (match) {
                    // 用<span class="cat-bold">包裹分类名称部分
                    $(this).html(match[1] + ' (<span class="cat-bold">' + match[2] + '</span>)');
                }
            });
        }
        
        // AJAX function to fetch client info by contact (no changes needed here)
        function changeyewu() {
            var contact = $("#contact").val();
            $('#cname').val('');
            customerValidated = false; // 重置验证状态
            $.ajax({
                type: "GET",
                dataType: "json",
                url: "{:url('Order/changeyewu')}" + "?contact=" + encodeURIComponent(contact),
                success: function (result) {
                    if (result['msg']['code'] == 0) {
                        $('#checklabel').css('color', 'red');
                        customerValidated = false; // 客户验证失败
                    } else {
                        $('#checklabel').css('color', 'green');
                        customerValidated = true; // 客户验证成功
                        // Fill in returned client info
                        $('#cname').val(result['msg']['custname']);
                        $('#pr_user').val(result['msg']['pr_user']);
                        $('#oper_user_input').val(result['msg']['oper_user']);
                        $('#country').val(result['msg']['country']);
                        $('#kh_username').val(result['msg']['kh_username']);
                        // Match the source dropdown by text (case-insensitive match)
                        var sourceValue = result['msg']['source'] || "";
                        var lowerSourceValue = sourceValue.toLowerCase();
                        var $sourceSelect = $('#source');
                        var matched = false;
                        $sourceSelect.find('option').each(function () {
                            var optionValue = $(this).val();
                            if (optionValue !== '' && lowerSourceValue.includes(optionValue.toLowerCase())) {
                                $sourceSelect.val(optionValue);
                                matched = true;
                                return false; // break loop
                            }
                        });
                        if (!matched) {
                            $sourceSelect.val('');
                        }
                        layui.form.render('select');
                        // 如果来源匹配成功，更新运营端口选项并自动选择
                        if (matched) {
                            // 使用 setTimeout 确保 layui 已经初始化完成
                            setTimeout(function() {
                                // 触发 select 事件以更新运营端口选项列表
                                $sourceSelect.trigger('change');
                                
                                // 如果有返回的来源端口值，自动选择
                                var sourcePortValue = result['msg']['source_port'] || '';
                                if (sourcePortValue && typeof window.fillSourcePortBySourceName === 'function') {
                                    // 先更新选项列表
                                    window.fillSourcePortBySourceName(sourceValue);
                                    
                                    // 然后选择对应的端口
                                    setTimeout(function() {
                                        var $sourcePort = $('#source_port');
                                        // 尝试通过值匹配
                                        var portMatched = false;
                                        $sourcePort.find('option').each(function() {
                                            if ($(this).val() === sourcePortValue || $(this).val() === String(sourcePortValue)) {
                                                $sourcePort.val(sourcePortValue);
                                                portMatched = true;
                                                return false;
                                            }
                                        });
                                        if (portMatched) {
                                            layui.form.render('select');
                                        }
                                    }, 200);
                                } else {
                                    // 如果没有来源端口值，只更新选项列表
                                    if (typeof window.fillSourcePortBySourceName === 'function') {
                                        window.fillSourcePortBySourceName(sourceValue);
                                    }
                                }
                            }, 100);
                        }
                        
                        // 自动填充团队名称
                        var teamName = result['msg']['team_name'] || '';
                        if (teamName) {
                            var $teamSelect = $('#team_name');
                            // 尝试通过值匹配团队名称
                            var teamMatched = false;
                            $teamSelect.find('option').each(function() {
                                if ($(this).val() === teamName || $(this).text() === teamName) {
                                    $teamSelect.val($(this).val());
                                    teamMatched = true;
                                    return false;
                                }
                            });
                            if (teamMatched) {
                                layui.form.render('select');
                            }
                        }
                        
                        // 自动填充协同人
                        var jointPersonIds = result['msg']['joint_person'] || [];
                        if (jointPersonIds && jointPersonIds.length > 0) {
                            // 确保协同人ID是字符串或数字格式
                            var jointPersonValues = jointPersonIds.map(function(id) {
                                return String(id);
                            });
                            // 使用 setTimeout 确保 xmSelect 已初始化
                            setTimeout(function() {
                                // 重新渲染 xmSelect 组件，设置初始值
                                if (window.collaboratorSelectInstance) {
                                    // 销毁旧实例
                                    if (window.collaboratorSelectInstance.destroy) {
                                        window.collaboratorSelectInstance.destroy();
                                    }
                                    // 重新渲染并设置初始值
                                    window.collaboratorSelectInstance = xmSelect.render({
                                        el: '#collaboratorSelect',
                                        name: 'joint_person',
                                        layVerify: 'required',
                                        tips: '请选择协同人员',
                                        filterable: true,
                                        clickClose: false,
                                        initValue: jointPersonValues,
                                        data: window.collaboratorData || []
                                    });
                                }
                            }, 200);
                        }
                        
                        // 无论客户是否成交，都不自动填充历史订单产品信息，让用户手动选择产品
                        // 确保产品明细表格始终保持只有一行空行的初始状态
                        var $tbody = $('#productTableBody');
                        var productOptions = window.productOptions || $('select[name="product_name[]"]').first().html();
                        var managerOptions = window.managerOptions || $('select[name="product_manager[]"]').first().html();
                        
                        // 清空所有现有的产品明细行
                        $tbody.empty();
                        
                        // 添加一行空的输入行（初始状态）
                        var emptyRow = document.createElement('tr');
                        emptyRow.innerHTML =
                            '<td><select name="product_name[]" lay-search lay-verify="required">' + productOptions + '</select></td>' +
                            '<td><select name="product_manager[]" lay-search lay-verify="required">' + managerOptions + '</select></td>' +
                            '<td><input type="text" name="spec_model[]" class="layui-input"></td>' +
                            '<td><input type="text" name="unit[]" class="layui-input"></td>' +
                            '<td><input type="number" name="qty[]" class="layui-input" lay-verify="required|number"></td>' +
                            '<td><input type="number" name="unit_price[]" class="layui-input" lay-verify="required|number" step="0.01"></td>' +
                            '<td><input type="number" name="total_price[]" class="layui-input" readonly></td>' +
                            '<td><input type="number" name="purchase_price[]" class="layui-input" lay-verify="required|number" step="0.01"></td>' +
                            '<td><input type="number" name="sub_profit[]" class="layui-input" readonly></td>' +
                            '<td><input type="text" name="item_remark[]" class="layui-input"></td>' +
                            '<td><button type="button" class="layui-btn layui-btn-danger layui-btn-sm delete-row">删除</button></td>';
                        $tbody.append(emptyRow);
                        
                        // 重新渲染下拉框
                        layui.form.render('select');
                        
                        // 对产品名称下拉选项调用 boldCategory，使分类名加粗
                        $tbody.find('select[name="product_name[]"]').each(function() {
                            boldCategory($(this));
                        });
                        
                        // 重置金额字段
                        $('#money').val('0.00');
                        $('#profit').val('0.00');
                        $('#margin_rate').val('0.00');
                    }
                    $('#checklabel').html(result['msg']['msg']);
                },
                error: function () {
                    alert("异常！");
                }
            });
        }
    </script>

    <div class="admin-main layui-anim layui-anim-upbit" ng-app="hd" ng-controller="ctrl">
        <form class="layui-form layui-form-pane">
            <!-- 客户联系方式 -->
            <div class="layui-form-item">
                <label class="layui-form-label">联系方式<span style="color:red;">*</span></label>
                <div class="layui-input-4">
                    <input type="text" id="contact" onchange="changeyewu()" name="contact" lay-verify="required"
                        placeholder="请输入客户联系方式" class="layui-input">
                </div>
            </div>
            <div class="layui-form-item">
                <div class="layui-input-4">
                    <label id="checklabel"></label>
                </div>
            </div>
            <!-- 省市选择 -->
            <div class="layui-form-item">
                <label class="layui-form-label">所在省市</label>
                <div class="layui-input-4">
                    <div style="display: flex; gap: 10px;">
                        <div style="flex: 1;">
                            <select name="province" id="province" lay-search lay-filter="province_select">
                                <option value="">请选择省份</option>
                            </select>
                        </div>
                        <div style="flex: 1;">
                            <select name="city" id="city" lay-search>
                                <option value="">请先选择省份</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
            <!-- 收货地址 -->
            <div class="layui-form-item">
                <label class="layui-form-label">收货地址<span style="color:red;">*</span></label>
                <div class="layui-input-4">
                    <textarea id="country" name="country" placeholder="请输入发货详细地址" class="layui-textarea"></textarea>
                </div>
            </div>
            <!-- 客户名称 -->
            <div class="layui-form-item">
                <label class="layui-form-label">客户名称</label>
                <div class="layui-input-4">
                    <input type="text" id="cname" name="cname" lay-verify="required" value="{$kh_name}"
                        placeholder="请输入客户名称" class="layui-input">
                </div>
            </div>
            <!-- 客户公司 -->
            <div class="layui-form-item">
                <label class="layui-form-label">客户公司</label>
                <div class="layui-input-4">
                    <input type="text" id="client_company" name="client_company" lay-verify="required" value=""
                        placeholder="请输入客户公司" class="layui-input">
                </div>
            </div>
            <!-- 客户负责人 -->
            <div class="layui-form-item">
                <label class="layui-form-label">客户负责人</label>
                <div class="layui-input-4">
                    <input type="text" id="pr_user" name="pr_user" lay-verify="required" value="{$username}"
                        class="layui-input">
                </div>
            </div>
            <!-- 询盘来源 -->
            <div class="layui-form-item">
                <label class="layui-form-label">询盘来源</label>
                <div class="layui-input-4">
                    <select name="source" id="source" lay-filter="kh_status" lay-search="">
                        <option value="">请选择询盘来源</option>
                        {volist name='sourceList' id='vo'}
                        <option value="{$vo|htmlentities}">{$vo|htmlentities}</option>
                        {/volist}
                    </select>
                </div>
            </div>
            <!-- 运营端口：可搜索单选下拉（根据询盘来源动态更新） -->
            <div class="layui-form-item">
                <label class="layui-form-label">运营端口</label>
                <div class="layui-input-4">
                    <select name="source_port" id="source_port" lay-search>
                        <option value="">请先选择询盘来源</option>
                    </select>
                </div>
            </div>
            <!-- 收款账户 -->
            <div class="layui-form-item">
                <label class="layui-form-label">收款账户</label>
                <div class="layui-input-4">
                    <select name="bank_account" id="bank_account" lay-verify="required" lay-search="">
                        <option value="">请选择收款账户</option>
                        {volist name="accountList" id="acc"}
                            <option value="{$acc.id}">{$acc.account|htmlentities}</option>
                        {/volist}
                    </select>
                </div>
            </div>
           
            <!-- 协同人多选下拉 -->
            <div class="layui-form-item">
                <label class="layui-form-label">协同人</label>
                <div class="layui-input-4">
                    <div id="collaboratorSelect"></div>
                </div>
            </div>
            <!-- 团队名称 -->
            <div class="layui-form-item">
                <label class="layui-form-label">团队名称</label>
                <div class="layui-input-4">
                    <select name="team_name" id="team_name" lay-verify="required" lay-search="">
                        <option value="">请选择团队名称</option>
                        {volist name='teamList' id='vo'}
                        <option value="{$vo}" {if $vo==$team_name} selected {/if}>{$vo}</option>
                        {/volist}
                    </select>
                </div>
            </div>
            <!-- 客户性质 -->
            <div class="layui-form-item">
                <label class="layui-form-label">客户性质</label>
                <div class="layui-input-4">
                    <select name="customer_type" id="customer_type" lay-verify="required" lay-search="">
                        <option value="">请选择客户性质</option>
                        {volist name='customer_type' id='vo'}
                        <option value="{$vo}" {if $vo==$customer_type} selected {/if}>{$vo}</option>
                        {/volist}
                    </select>
                </div>
            </div>
            <!-- 成交时间 -->
            <div class="layui-form-item">
                <label class="layui-form-label">成交时间</label>
                <div class="layui-input-4">
                    <input type="text" id="orderTime" name="order_time" placeholder="请输入成交时间" class="layui-input">
                </div>
            </div>
            <!-- 产品明细表格 -->
            <div class="layui-form-item">
                <label class="layui-form-label">产品明细</label>
                <div class="layui-input-block">
                    <table id="product-table" class="layui-table">
                        <thead>
                            <tr>
                                <th>产品名称</th>
                                <th>产品经理</th>
                                <th>规格型号</th>
                                <th>单位</th>
                                <th>数量</th>
                                <th>销售单价</th>
                                <th>销售价合计</th>
                                <th>进价合计</th>
                                <th>子项利润</th>
                                <th>行备注</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="productTableBody">
                            <!-- 默认提供一行空的输入行（带下拉选择产品名称） -->
                            <tr>
                                <td>
                                    <select name="product_name[]" lay-search lay-verify="required">
                                        <option value="">请选择产品名称</option>
                                        {volist name="productList" id="vo"}
                                        <option value="{$vo.id}">{$vo.product_name} ({$vo.category_name|default='无'})
                                        </option>
                                        {/volist}
                                    </select>
                                </td>
                                <td>
                                    <select name="product_manager[]" lay-search lay-verify="required">
                                        <option value="">请选择产品经理</option>
                                        <!-- 遍历产品经理列表 -->
                                        {volist name="managerList" id="vo"}
                                        <option value="{$vo.admin_id}">{$vo.username}</option>
                                        {/volist}
                                    </select>
                                </td>
                                <td><input type="text" name="spec_model[]" class="layui-input"></td>
                                <td><input type="text" name="unit[]" class="layui-input"></td>
                                <td><input type="number" name="qty[]" class="layui-input" lay-verify="required|number">
                                </td>
                                <td><input type="number" name="unit_price[]" class="layui-input"
                                        lay-verify="required|number" step="0.01"></td>
                                <td><input type="number" name="total_price[]" class="layui-input" readonly></td>
                                <td><input type="number" name="purchase_price[]" class="layui-input"
                                        lay-verify="required|number" step="0.01"></td>
                                <td><input type="number" name="sub_profit[]" class="layui-input" readonly></td>
                                <td><input type="text" name="item_remark[]" class="layui-input"></td>
                                <td><button type="button"
                                        class="layui-btn layui-btn-danger layui-btn-sm delete-row">删除</button></td>
                            </tr>
                        </tbody>
                    </table>
                    <!-- 新增一行按钮 -->
                    <button type="button" id="addRow" class="layui-btn layui-btn-normal">新增一行</button>
                </div>
            </div>
            <!-- 费用和金额字段 -->
            <div class="layui-form-item">
                <label class="layui-form-label">估算运费<span style="color:red;">*</span></label>
                <div class="layui-input-4">
                    <input type="text" id="shipping_cost" name="shipping_cost" lay-verify="required"
                        placeholder="请输入估算运费" class="layui-input">
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label">票种/票金额<span style="color:red;">*</span></label>
                <div class="layui-input-4">
                    <input type="text" id="invoice_amount" name="invoice_amount" lay-verify="required"
                        placeholder="请输入开票金额" class="layui-input">
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label">税费金额<span style="color:red;">*</span></label>
                <div class="layui-input-4">
                    <input type="text" id="tax_amount" name="tax_amount" lay-verify="required" placeholder="请输入税费金额"
                        class="layui-input">
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label">调试费<span style="color:red;">*</span></label>
                <div class="layui-input-4">
                    <input type="text" id="debugging_cost" name="debugging_cost" lay-verify="required"
                        placeholder="请输入调试费" class="layui-input">
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label">佣金<span style="color:red;">*</span></label>
                <div class="layui-input-4">
                    <input type="text" id="sales_commission" name="sales_commission" lay-verify="required"
                        placeholder="请输入佣金" class="layui-input">
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label">分成备注<span style="color:red;">*</span></label>
                <div class="layui-input-4">
                    <input type="text" id="split_remarks" name="split_remarks" lay-verify="required"
                        placeholder="请输入分成备注" class="layui-input">
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label">已收款金额<span style="color:red;">*</span></label>
                <div class="layui-input-4">
                    <input type="text" id="amount_received" name="amount_received" lay-verify="required"
                        placeholder="请输入已收款金额" class="layui-input">
                </div>
            </div>
            <!-- 订单金额、利润、利润率 -->
            <div class="layui-form-item">
                <label class="layui-form-label">订单金额(￥)</label>
                <div class="layui-input-4">
                    <input type="text" id="money" name="money" lay-verify="number|required" placeholder="请输入订单总金额"
                        class="layui-input">
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label">利润(￥)</label>
                <div class="layui-input-4">
                    <input type="text" id="profit" name="profit" lay-verify="required" placeholder="请输入利润"
                        class="layui-input">
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label">利润率(%)</label>
                <div class="layui-input-4" style="position: relative;">
                    <input type="text" id="margin_rate" name="margin_rate" lay-verify="required" placeholder="请输入利润率"
                        class="layui-input">
                    <span style="position: absolute; right: 5px; top: 50%; transform: translateY(-50%);">%</span>
                </div>
            </div>
            <!-- 客户微信回执图 -->
            <div class="layui-form-item">
                <label class="layui-form-label"><span style="color:red;">*</span>客户微信回执图</label>
                <div class="layui-input-4">
                    <div class="layui-upload">
                        <button type="button" class="layui-btn" id="upload_wechat_receipt">
                            <i class="layui-icon">&#xe67c;</i>上传图片
                        </button>
                        <div class="layui-upload-list">
                            <img class="layui-upload-img" id="wechat_receipt_preview" style="max-width: 200px; max-height: 200px; display: none;">
                            <p id="wechat_receipt_text"></p>
                            <input type="hidden" name="wechat_receipt_image" id="wechat_receipt_image" value="" lay-verify="required">
                        </div>
                    </div>
                </div>
            </div>
            <!-- 产品询盘分配图 -->
            <div class="layui-form-item">
                <label class="layui-form-label"><span style="color:red;">*</span>产品询盘分配图</label>
                <div class="layui-input-4">
                    <div class="layui-upload">
                        <button type="button" class="layui-btn" id="upload_inquiry_assign">
                            <i class="layui-icon">&#xe67c;</i>上传图片
                        </button>
                        <div class="layui-upload-list">
                            <img class="layui-upload-img" id="inquiry_assign_preview" style="max-width: 200px; max-height: 200px; display: none;">
                            <p id="inquiry_assign_text"></p>
                            <input type="hidden" name="inquiry_assign_image" id="inquiry_assign_image" value="" lay-verify="required">
                        </div>
                    </div>
                </div>
            </div>
            <!-- 备注 -->
            <div class="layui-form-item">
                <label class="layui-form-label">备注</label>
                <div class="layui-input-4">
                    <textarea name="remark" placeholder="请输入备注信息" class="layui-textarea"></textarea>
                </div>
            </div>
            <!-- 提交按钮 -->
            <div class="layui-form-item">
                <div class="layui-input-block">
                    <button type="button" class="layui-btn" lay-submit lay-filter="submit">提交保存</button>
                </div>
            </div>
        </form>
    </div>
    {include file="common/foot"/}

    <script>
        layui.use(['form', 'layer', 'laydate', 'upload'], function () {
            var form = layui.form,
                layer = layui.layer,
                $ = layui.jquery,
                laydate = layui.laydate,
                upload = layui.upload;
            // 日期控件初始化
            laydate.render({
                elem: '#orderTime',
                type: 'datetime',
                format: 'yyyy-MM-dd HH:mm:ss',
                value: new Date()
            });
            // 自定义验证规则（数字校验）
            form.verify({
                number: function (value) {
                    if (!/^\d+(\.\d+)?$/.test(value)) {
                        return '请输入有效的数字';
                    }
                }
            });
            // 初始化协同人多选下拉
            var collaboratorData = {$collaboratorList|raw};
            // 将协同人数据保存到全局，以便 changeyewu 函数可以访问
            window.collaboratorData = collaboratorData;
            // 将 xmSelect 实例保存到全局，以便 changeyewu 函数可以访问
            window.collaboratorSelectInstance = xmSelect.render({
                el: '#collaboratorSelect',
                name: 'joint_person',
                // layVerify: 'required',
                tips: '请选择协同人员',
                filterable: true,
                clickClose: false,
                data: collaboratorData
            });
            // 渲染现有的下拉框（包括产品名称、询盘来源等）
            form.render('select');

            // 初始化省市联动下拉框
            var $provinceSelect = $('#province');
            var $citySelect = $('#city');
            
            // 填充省份下拉框
            $.each(chinaProvincesCities, function(provinceName, cities) {
                $provinceSelect.append('<option value="' + provinceName + '">' + provinceName + '</option>');
            });
            form.render('select');
            
            // 省份选择变化时，更新城市下拉框
            form.on('select(province_select)', function(data) {
                var selectedProvince = data.value;
                $citySelect.empty();
                
                if (selectedProvince && chinaProvincesCities[selectedProvince]) {
                    var cities = chinaProvincesCities[selectedProvince];
                    $citySelect.append('<option value="">请选择城市</option>');
                    $.each(cities, function(index, cityName) {
                        $citySelect.append('<option value="' + cityName + '">' + cityName + '</option>');
                    });
                } else {
                    $citySelect.append('<option value="">请先选择省份</option>');
                }
                form.render('select');
            });

        // 对初始产品名称下拉选项调用 boldCategory，使分类名加粗
        // 注意：boldCategory 函数已移到全局作用域
        setTimeout(function() {
            boldCategory($('select[name="product_name[]"]'));
        }, 100);

        // 动态根据询盘来源过滤运营人员和运营端口选项
        var yyList = {$yyList|raw};
        var shopList = {$shopList|raw};  // 店铺列表分组数据：{ 来源名称: [ {id:..., name:...}, ... ], ... }
        
        // 将函数定义到全局作用域，以便 changeyewu 函数可以访问
        window.fillSourcePortBySourceName = function(sourceName) {
            var shops = shopList[sourceName] || [];
            var $sourcePort = $('#source_port');
            $sourcePort.empty();
            if (shops.length > 0) {
                $sourcePort.append('<option value="">请选择运营端口</option>');
                $.each(shops, function (index, shop) {
                    $sourcePort.append('<option value="' + shop.id + '">' + shop.name + '</option>');
                });
            } else {
                $sourcePort.append('<option value="">该来源暂无店铺数据</option>');
            }
            form.render('select');
        };
        
        form.on('select(kh_status)', function (data) {
            var sourceName = $(data.elem).find("option:selected").text();
            var users = yyList[sourceName] || [];
            var $oper = $('select[name="oper_user"]');
            $oper.empty().append('<option value="">请选择运营人员</option>');
            $.each(users, function (index, user) {
                $oper.append('<option value="' + user.id + '">' + user.name + '</option>');
            });
            // 更新运营端口选项
            if (typeof window.fillSourcePortBySourceName === 'function') {
                window.fillSourcePortBySourceName(sourceName);
            }
            form.render('select');
        });

        // **为新增产品行准备选项HTML** 
        // 获取初始产品名称下拉的所有选项HTML（包括"请选择"和产品列表）
        var productOptions = $('select[name="product_name[]"]').first().html();
        // 保存到全局作用域，以便 changeyewu 函数可以访问
        window.productOptions = productOptions;

        // 获取初始产品经理下拉的所有选项 HTML  (新增)
        var managerOptions = $('select[name="product_manager[]"]').first().html();
        // 保存到全局作用域，以便 changeyewu 函数可以访问
        window.managerOptions = managerOptions;

        // 页面加载时，初始化产品明细表格：清空所有行，只保留一行空行
        function initProductTable() {
            var $tbody = $('#productTableBody');
            // 清空所有现有的产品明细行
            $tbody.empty();
            
            // 添加一行空的输入行（初始状态）
            var emptyRow = document.createElement('tr');
            emptyRow.innerHTML =
                '<td><select name="product_name[]" lay-search lay-verify="required">' + productOptions + '</select></td>' +
                '<td><select name="product_manager[]" lay-search lay-verify="required">' + managerOptions + '</select></td>' +
                '<td><input type="text" name="spec_model[]" class="layui-input"></td>' +
                '<td><input type="text" name="unit[]" class="layui-input"></td>' +
                '<td><input type="number" name="qty[]" class="layui-input" lay-verify="required|number"></td>' +
                '<td><input type="number" name="unit_price[]" class="layui-input" lay-verify="required|number" step="0.01"></td>' +
                '<td><input type="number" name="total_price[]" class="layui-input" readonly></td>' +
                '<td><input type="number" name="purchase_price[]" class="layui-input" lay-verify="required|number" step="0.01"></td>' +
                '<td><input type="number" name="sub_profit[]" class="layui-input" readonly></td>' +
                '<td><input type="text" name="item_remark[]" class="layui-input"></td>' +
                '<td><button type="button" class="layui-btn layui-btn-danger layui-btn-sm delete-row">删除</button></td>';
            $tbody.append(emptyRow);
            
            // 重新渲染下拉框
            form.render('select');
            
            // 对产品名称下拉选项调用 boldCategory，使分类名加粗
            $tbody.find('select[name="product_name[]"]').each(function() {
                boldCategory($(this));
            });
            
            // 重置金额字段
            $('#money').val('0.00');
            $('#profit').val('0.00');
            $('#margin_rate').val('0.00');
        }
        
        // 页面加载完成后初始化产品明细表格
        $(document).ready(function() {
            initProductTable();
        });

        // 新增一行产品明细
        $('#addRow').on('click', function () {
            var $tbody = $('#productTableBody');
            // 创建新<tr>元素
            var newRow = document.createElement('tr');
            newRow.innerHTML =
                '<td><select name="product_name[]" lay-search lay-verify="required">' + productOptions + '</select></td>' +
                '<td><select name="product_manager[]" lay-search lay-verify="required">' + managerOptions + '</select></td>' +
                '<td><input type="text" name="spec_model[]" class="layui-input"></td>' +
                '<td><input type="text" name="unit[]" class="layui-input"></td>' +
                '<td><input type="number" name="qty[]" class="layui-input" lay-verify="required|number"></td>' +
                '<td><input type="number" name="unit_price[]" class="layui-input" lay-verify="required|number" step="0.01"></td>' +
                '<td><input type="number" name="total_price[]" class="layui-input" readonly></td>' +
                '<td><input type="number" name="purchase_price[]" class="layui-input" lay-verify="required|number" step="0.01"></td>' +
                '<td><input type="number" name="sub_profit[]" class="layui-input" readonly></td>' +
                '<td><input type="text" name="item_remark[]" class="layui-input"></td>' +
                '<td><button type="button" class="layui-btn layui-btn-danger layui-btn-sm delete-row">删除</button></td>';
            $tbody.append(newRow);
            // 重新渲染新添加的下拉框为 LayUI 风格
            form.render('select');
            // （如果有对产品名称下拉选项的特殊处理，如 boldCategory，可在此对 newRow 的 product_name 下拉调用）
        });

        // 删除产品行
        $('#productTableBody').on('click', '.delete-row', function () {
            $(this).closest('tr').remove();
            updateTotals();  // 删除后更新总计
        });

        // 更新单行的销售合计和子项利润
        function updateRow($tr) {
            var qty = parseFloat($tr.find('input[name="qty[]"]').val()) || 0;
            var unitPrice = parseFloat($tr.find('input[name="unit_price[]"]').val()) || 0;
            var purchase = parseFloat($tr.find('input[name="purchase_price[]"]').val()) || 0;
            var total = qty * unitPrice;
            var profit = total - purchase;
            $tr.find('input[name="total_price[]"]').val(total.toFixed(2));
            $tr.find('input[name="sub_profit[]"]').val(profit.toFixed(2));
        }

        // 更新所有产品行的总金额、总利润和利润率
        function updateTotals() {
            var sumTotal = 0, sumProfit = 0;
            // 遍历每一行产品，计算总金额和总利润（已有逻辑）
            $('#productTableBody tr').each(function () {
                var $tr = $(this);
                var qty = parseFloat($tr.find('input[name="qty[]"]').val()) || 0;
                var unitPrice = parseFloat($tr.find('input[name="unit_price[]"]').val()) || 0;
                var purchase = parseFloat($tr.find('input[name="purchase_price[]"]').val()) || 0;
                var lineTotal = qty * unitPrice;
                var lineProfit = lineTotal - purchase;
                sumTotal += lineTotal;
                sumProfit += lineProfit;
            });
            // 更新订单总金额字段
            $('#money').val(sumTotal.toFixed(2));

            // 读取其他费用字段并计算最终利润
            var shippingCost = parseFloat($('#shipping_cost').val()) || 0;
            var taxAmount = parseFloat($('#tax_amount').val()) || 0;
            var debuggingCost = parseFloat($('#debugging_cost').val()) || 0;
            var salesCommission = parseFloat($('#sales_commission').val()) || 0;
            var finalProfit = sumProfit - shippingCost - taxAmount - debuggingCost - salesCommission;
            $('#profit').val(finalProfit.toFixed(2));

            // 计算利润率并更新字段（避免除以 0）
            var marginRate = 0;
            if (sumTotal > 0) {
                marginRate = (finalProfit / sumTotal) * 100;
            }
            $('#margin_rate').val(marginRate.toFixed(2));
        }


        // 当数量、单价或进价改变时，实时更新对应行和总计
        $('#productTableBody').on('input', 'input[name="qty[]"], input[name="unit_price[]"], input[name="purchase_price[]"]', function () {
            var $row = $(this).closest('tr');
            updateRow($row);
            updateTotals();
        });

            // 页面加载完成时，自动计算初始订单金额、利润和利润率
            updateTotals();

            // 当运费、税费、调试费或佣金字段的值发生变化时，实时更新总计、利润和利润率
            $('#shipping_cost, #tax_amount, #debugging_cost, #sales_commission').on('input', function () {
                updateTotals();
            });

            // 图片压缩函数
            function compressImage(file, maxWidth, maxHeight, quality, callback) {
                var reader = new FileReader();
                reader.onload = function(e) {
                    var img = new Image();
                    img.onload = function() {
                        var canvas = document.createElement('canvas');
                        var ctx = canvas.getContext('2d');
                        
                        // 计算压缩后的尺寸
                        var width = img.width;
                        var height = img.height;
                        if (width > maxWidth || height > maxHeight) {
                            if (width > height) {
                                if (width > maxWidth) {
                                    height = height * (maxWidth / width);
                                    width = maxWidth;
                                }
                            } else {
                                if (height > maxHeight) {
                                    width = width * (maxHeight / height);
                                    height = maxHeight;
                                }
                            }
                        }
                        
                        canvas.width = width;
                        canvas.height = height;
                        
                        // 绘制压缩后的图片
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        // 转换为blob
                        canvas.toBlob(function(blob) {
                            callback(blob);
                        }, 'image/jpeg', quality);
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            }

            // 手动上传压缩后的图片
            function uploadCompressedImage(blob, fileName, uploadUrl, progressCallback, successCallback, errorCallback) {
                var formData = new FormData();
                // 确保文件名有正确的扩展名
                if (!fileName.toLowerCase().endsWith('.jpg') && !fileName.toLowerCase().endsWith('.jpeg')) {
                    fileName = fileName.replace(/\.[^/.]+$/, '') + '.jpg';
                }
                formData.append('file', blob, fileName);
                
                var xhr = new XMLHttpRequest();
                
                // 上传进度
                xhr.upload.addEventListener('progress', function(e) {
                    if (e.lengthComputable) {
                        var percent = Math.round((e.loaded / e.total) * 100);
                        if (progressCallback) progressCallback(percent);
                    }
                }, false);
                
                // 上传完成
                xhr.addEventListener('load', function() {
                    if (xhr.status === 200) {
                        try {
                            var res = JSON.parse(xhr.responseText);
                            if (successCallback) successCallback(res);
                        } catch(e) {
                            if (errorCallback) errorCallback('响应解析失败: ' + e.message);
                        }
                    } else {
                        if (errorCallback) errorCallback('上传失败，状态码：' + xhr.status + '，响应：' + xhr.responseText);
                    }
                }, false);
                
                // 上传错误
                xhr.addEventListener('error', function() {
                    if (errorCallback) errorCallback('网络错误');
                }, false);
                
                xhr.open('POST', uploadUrl);
                // 不手动设置 Content-Type，让浏览器自动设置 multipart/form-data
                // 这样 ThinkPHP 才能正确解析文件
                xhr.send(formData);
            }

            // 客户微信回执图上传 - 使用隐藏的input
            var wechatReceiptInput = $('<input type="file" accept="image/*" style="display:none;" id="wechat_receipt_input">');
            $('body').append(wechatReceiptInput);
            
            $('#upload_wechat_receipt').on('click', function() {
                wechatReceiptInput.click();
            });
            
            wechatReceiptInput.on('change', function(e) {
                var file = e.target.files[0];
                if (!file) return;
                
                // 检查文件大小（压缩前限制10MB）
                if(file.size > 10 * 1024 * 1024){
                    layer.msg('图片大小不能超过10MB，请选择较小的图片', {icon: 2});
                    return;
                }
                
                // 预览原图
                var reader = new FileReader();
                reader.onload = function(e) {
                    $('#wechat_receipt_preview').attr('src', e.target.result).show();
                };
                reader.readAsDataURL(file);
                
                // 压缩图片
                $('#wechat_receipt_text').html('<span style="color: #1E9FFF;">正在压缩图片...</span>');
                compressImage(file, 1920, 1920, 0.8, function(compressedBlob){
                    // 显示压缩后的大小
                    var originalSize = (file.size / 1024 / 1024).toFixed(2);
                    var compressedSize = (compressedBlob.size / 1024 / 1024).toFixed(2);
                    $('#wechat_receipt_text').html('<span style="color: #1E9FFF;">压缩完成（' + originalSize + 'MB → ' + compressedSize + 'MB），开始上传...</span>');
                    
                    // 上传压缩后的图片
                    uploadCompressedImage(
                        compressedBlob,
                        file.name.replace(/\.[^/.]+$/, '.jpg'),
                        '{:url("UpFiles/upload")}',
                        function(percent) {
                            $('#wechat_receipt_text').html('<span style="color: #1E9FFF;">上传进度: ' + percent + '%</span>');
                        },
                        function(res) {
                            if(res.code == 1){
                                $('#wechat_receipt_image').val(res.url);
                                $('#wechat_receipt_text').html('<span style="color: #5FB878;">上传成功</span>');
                            } else {
                                $('#wechat_receipt_text').html('<span style="color: #FF5722;">上传失败：' + (res.info || '未知错误') + '</span>');
                            }
                        },
                        function(error) {
                            $('#wechat_receipt_text').html('<span style="color: #FF5722;">上传失败：' + error + '</span>');
                        }
                    );
                });
            });

            // 产品询盘分配图上传 - 使用隐藏的input
            var inquiryAssignInput = $('<input type="file" accept="image/*" style="display:none;" id="inquiry_assign_input">');
            $('body').append(inquiryAssignInput);
            
            $('#upload_inquiry_assign').on('click', function() {
                inquiryAssignInput.click();
            });
            
            inquiryAssignInput.on('change', function(e) {
                var file = e.target.files[0];
                if (!file) return;
                
                // 检查文件大小（压缩前限制10MB）
                if(file.size > 10 * 1024 * 1024){
                    layer.msg('图片大小不能超过10MB，请选择较小的图片', {icon: 2});
                    return;
                }
                
                // 预览原图
                var reader = new FileReader();
                reader.onload = function(e) {
                    $('#inquiry_assign_preview').attr('src', e.target.result).show();
                };
                reader.readAsDataURL(file);
                
                // 压缩图片
                $('#inquiry_assign_text').html('<span style="color: #1E9FFF;">正在压缩图片...</span>');
                compressImage(file, 1920, 1920, 0.8, function(compressedBlob){
                    // 显示压缩后的大小
                    var originalSize = (file.size / 1024 / 1024).toFixed(2);
                    var compressedSize = (compressedBlob.size / 1024 / 1024).toFixed(2);
                    $('#inquiry_assign_text').html('<span style="color: #1E9FFF;">压缩完成（' + originalSize + 'MB → ' + compressedSize + 'MB），开始上传...</span>');
                    
                    // 上传压缩后的图片
                    uploadCompressedImage(
                        compressedBlob,
                        file.name.replace(/\.[^/.]+$/, '.jpg'),
                        '{:url("UpFiles/upload")}',
                        function(percent) {
                            $('#inquiry_assign_text').html('<span style="color: #1E9FFF;">上传进度: ' + percent + '%</span>');
                        },
                        function(res) {
                            if(res.code == 1){
                                $('#inquiry_assign_image').val(res.url);
                                $('#inquiry_assign_text').html('<span style="color: #5FB878;">上传成功</span>');
                            } else {
                                $('#inquiry_assign_text').html('<span style="color: #FF5722;">上传失败：' + (res.info || '未知错误') + '</span>');
                            }
                        },
                        function(error) {
                            $('#inquiry_assign_text').html('<span style="color: #FF5722;">上传失败：' + error + '</span>');
                        }
                    );
                });
            });



        // 表单提交监听
        form.on('submit(submit)', function (data) {
            // 检查联系方式是否已填写
            var contact = $("#contact").val();
            if (!contact || contact.trim() === '') {
                layer.msg('请先输入联系方式', { icon: 2, time: 2000 });
                return false;
            }
            
            // 如果客户未验证或验证失败，先触发验证
            if (!customerValidated) {
                // 先触发一次 changeyewu 验证
                var contactValue = contact.trim();
                $.ajax({
                    type: "GET",
                    dataType: "json",
                    url: "{:url('Order/changeyewu')}" + "?contact=" + encodeURIComponent(contactValue),
                    async: false, // 同步请求，确保验证完成后再提交
                    success: function (result) {
                        if (result['msg']['code'] == 0) {
                            customerValidated = false;
                            layer.msg(result['msg']['msg'] || '该客户不属于您的客户或协同人客户，无法添加订单', { icon: 2, time: 3000 });
                        } else {
                            customerValidated = true;
                        }
                    },
                    error: function () {
                        customerValidated = false;
                        layer.msg('验证客户信息失败，请重试', { icon: 2, time: 2000 });
                    }
                });
            }
            
            // 如果验证失败，阻止提交
            if (!customerValidated) {
                return false;
            }

            // 检查两个图片是否已上传
            var wechatReceiptImage = $('#wechat_receipt_image').val();
            var inquiryAssignImage = $('#inquiry_assign_image').val();
            
            if (!wechatReceiptImage || wechatReceiptImage.trim() === '') {
                layer.msg('请上传客户微信回执图', { icon: 2, time: 2000 });
                return false;
            }
            
            if (!inquiryAssignImage || inquiryAssignImage.trim() === '') {
                layer.msg('请上传产品询盘分配图', { icon: 2, time: 2000 });
                return false;
            }

            // 提交前同步更新总计字段，以防用户未触发输入事件
            updateTotals();
            $.post("{:url('Order/add')}", data.field, function (res) {
                if (res.code === 0) {
                    layer.msg(res.msg, { time: 2000 }, function () {
                        layer.close(layer.index);
                        window.parent.location.reload();
                    });
                } else {
                    layer.msg(res.msg, { time: 2000 });
                }
            }, 'json');
            return false;
        });
        }); // 闭合 layui.use
    </script>
</body>

</html>