<div class="layui-row layui-col-space15">
    <div class="layui-row layui-col-space15">
        <div class="layui-col-md6">
            <div class="layui-card fold-card export">

                <div class="layui-card-header">销售产品排行</div>
                <div class="filter-bar">
                    <div class="total">合计：<span>{$data['product_data']['order_prod'] ? $data['product_data']['order_prod']|array_column='count'|array_sum : 0}</span></div>
                </div>
                <div class="layui-card-body table-scroll">
                    <table id="sp_list_table" class="layui-table layui-table-sm">

                        <thead>
                            <tr>
                                <th>产品</th>
                                <th>销售数量</th>
                            </tr>
                        </thead>
                        <tbody>
                            {volist name="$data['product_data']['order_prod']" id='vo'}
                            <tr>
                                <td>{$vo['product_name']}</td>
                                <td>{$vo['count']}</td>
                            </tr>
                            {/volist}
                            {if !$data['product_data']['order_prod']}<tr>
                                <td colspan="2">暂无数据</td>
                            </tr>{/if}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <div class="layui-col-md6">
            <div class="layui-card fold-card export">

                <div class="layui-card-header">询盘产品排行</div>
                    <div class="filter-bar">
                    <div class="total">合计：<span>{$data['product_data']['oper_prod'] ? $data['product_data']['oper_prod']|array_column='count'|array_sum : 0}</span></div>
                </div>
                <div class="layui-card-body table-scroll">
                    <table id="pd_list_table" class="layui-table layui-table-sm">
                        <thead>
                            <tr>
                                <th>产品</th>
                                <th>询盘数量</th>
                            </tr>
                        </thead>
                        <tbody>

                            {volist name="$data['product_data']['oper_prod']" id='vo'}
                            <tr>
                                <td>{$vo['product_name']}</td>
                                <td>{$vo['count']}</td>
                            </tr>
                            {/volist}
                            {if !$data['product_data']['oper_prod']}<tr>
                                <td colspan="2">暂无数据</td>
                            </tr>{/if}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="layui-row layui-col-space15">
    <div class="layui-row layui-col-space15">
        <div class="layui-col-md6">
            <div class="layui-card fold-card export">

                <div class="layui-card-header">销售产品分类排行</div>
                <div class="filter-bar">
                    <div class="total">合计：<span>{$data['product_data']['order_prod_category'] ? $data['product_data']['order_prod_category']|array_column='count'|array_sum : 0}</span></div>
                </div>
                <div class="layui-card-body table-scroll">
                    <table id="spfl_list_table" class="layui-table layui-table-sm">

                        <thead>
                            <tr>
                                <th>产品分类</th>
                                <th>销售数量</th>
                            </tr>
                        </thead>
                        <tbody>
                            {volist name="$data['product_data']['order_prod_category']" id='vo'}
                            <tr>
                                <td>{$vo['category_name']}</td>
                                <td>{$vo['count']}</td>
                            </tr>
                            {/volist}
                            {if !$data['product_data']['order_prod_category']}<tr>
                                <td colspan="2">暂无数据</td>
                            </tr>{/if}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <div class="layui-col-md6">
            <div class="layui-card fold-card export">

                <div class="layui-card-header">询盘产品分类排行</div>
                <div class="filter-bar">
                    <div class="total">合计：<span>{$data['product_data']['oper_prod_category'] ? $data['product_data']['oper_prod_category']|array_column='count'|array_sum : 0}</span></div>
                </div>
                <div class="layui-card-body table-scroll">
                    <table id="pdfl_list_table" class="layui-table layui-table-sm">
                        <thead>
                            <tr>
                                <th>产品分类</th>
                                <th>询盘数量</th>
                            </tr>
                        </thead>
                        <tbody>

                            {volist name="$data['product_data']['oper_prod_category']" id='vo'}
                            <tr>
                                <td>{$vo['category_name']}</td>
                                <td>{$vo['count']}</td>
                            </tr>
                            {/volist}
                            {if !$data['product_data']['oper_prod_category']}<tr>
                                <td colspan="2">暂无数据</td>
                            </tr>{/if}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="layui-row layui-col-space15">
    <div class="layui-row layui-col-space15">
        <div class="layui-col-md6">
            <div class="layui-card fold-card export">

                <div class="layui-card-header">销售产品地区排行</div>
                <div class="filter-bar">
                    {php}
                        if($data['product_data']['order_prod_country']){
                            $total_count = array_sum(array_column($data['product_data']['order_prod_country'], 'count'));
                            $product_name_list = array_unique(array_column($data['product_data']['order_prod_country'], 'product_name'));
                            $country_list = array_unique(array_column($data['product_data']['order_prod_country'], 'country'));
                        }else{
                            $total_count = 0;
                            $product_name_list = [];
                            $country_list = [];
                        }
                    {/php}
                    <label>产品筛选：</label>
                    <select id="product_filter1" lay-filter="product_filter1" class="layui-select" diy-search
                        style="width: 150px; margin-right: 15px;">
                        <option value="">全部产品</option>
                        {volist name="$product_name_list" id='vo'}
                        <option value="{$vo}">{$vo}</option>
                        {/volist}
                    </select>
                    <label>地区筛选：</label>
                    <select id="country_filter1" lay-filter="country_filter1" class="layui-select" diy-search
                        style="width: 150px; margin-right: 15px;">
                        <option value="">全部地区</option>
                        {volist name="$country_list" id='vo'}
                        <option value="{$vo}">{$vo}</option>
                        {/volist}
                    </select>
                    <div class="total">合计：<span>{$total_count}</span></div>
                </div>
                <div class="layui-card-body table-scroll">
                    <table id="list_table1" class="layui-table merge layui-table-sm">

                        <thead>
                            <tr>
                                <th>产品</th>
                                <th>地区</th>
                                <th>销售数量</th>
                            </tr>
                        </thead>
                        <tbody>
                            {volist name="$data['product_data']['order_prod_country']" id='vo'}
                            <tr>
                                <td>{$vo['product_name']}</td>
                                <td>{$vo['country']}</td>
                                <td>{$vo['count']}</td>
                            </tr>
                            {/volist}
                            {if !$data['product_data']['order_prod_country']}<tr>
                                <td colspan="3">暂无数据</td>
                            </tr>{/if}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <div class="layui-col-md6">
            <div class="layui-card fold-card export">

                <div class="layui-card-header">询盘产品地区排行</div>
                <div class="filter-bar">
                    {php}
                        if($data['product_data']['order_prod_country']){
                            $total_count = array_sum(array_column($data['product_data']['oper_prod_country'], 'count'));
                            $product_name_list = array_unique(array_column($data['product_data']['oper_prod_country'], 'product_name'));
                            $country_list = array_unique(array_column($data['product_data']['oper_prod_country'], 'xs_area'));
                        }else{
                            $total_count = 0;
                            $product_name_list = [];
                            $country_list = [];
                        }
                    {/php}
                    <label>产品筛选：</label>
                    <select id="product_filter2" lay-filter="product_filter2" class="layui-select" diy-search
                        style="width: 150px; margin-right: 15px;">
                        <option value="">全部产品</option>
                        {volist name="$product_name_list" id='vo'}
                        <option value="{$vo}">{$vo}</option>
                        {/volist}
                    </select>
                    <label>地区筛选：</label>
                    <select id="country_filter2" lay-filter="country_filter2" class="layui-select" diy-search
                        style="width: 150px; margin-right: 15px;">
                        <option value="">全部地区</option>
                        {volist name="$country_list" id='vo'}
                        <option value="{$vo}">{$vo}</option>
                        {/volist}
                    </select>
                    <div class="total">合计：<span>{$total_count}</span></div>
                </div>
                <div class="layui-card-body table-scroll">
                    <table id="list_table2" class="layui-table merge layui-table-sm">
                        <thead>
                            <tr>
                                <th>产品</th>
                                <th>地区</th>
                                <th>询盘数量</th>
                            </tr>
                        </thead>
                        <tbody>

                            {volist name="$data['product_data']['oper_prod_country']" id='vo'}
                            <tr>
                                <td>{$vo['product_name']}</td>
                                <td>{$vo['xs_area']}</td>
                                <td>{$vo['count']}</td>
                            </tr>
                            {/volist}
                            {if !$data['product_data']['oper_prod_country']}<tr>
                                <td colspan="3">暂无数据</td>
                            </tr>{/if}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="layui-row layui-col-space15">
    <div class="layui-row layui-col-space15">
        <div class="layui-col-md6">
            <div class="layui-card fold-card export">

                <div class="layui-card-header">销售产品分类地区排行</div>
                            <div class="filter-bar">
                    {php}
                        if($data['product_data']['order_prod_country']){
                            $total_count = array_sum(array_column($data['product_data']['order_prod_category_country'], 'count'));
                            $category_name_list = array_unique(array_column($data['product_data']['order_prod_category_country'], 'category_name'));
                            $country_list = array_unique(array_column($data['product_data']['order_prod_category_country'], 'country'));
                        }else{
                            $total_count = 0;
                            $category_name_list = [];
                            $country_list = [];
                        }
                    {/php}
                    <label>产品筛选：</label>
                    <select id="product_filter3" lay-filter="product_filter3" class="layui-select" diy-search
                        style="width: 150px; margin-right: 15px;">
                        <option value="">全部产品</option>
                        {volist name="$category_name_list" id='vo'}
                        <option value="{$vo}">{$vo}</option>
                        {/volist}
                    </select>
                    <label>地区筛选：</label>
                    <select id="country_filter3" lay-filter="country_filter3" class="layui-select" diy-search
                        style="width: 150px; margin-right: 15px;">
                        <option value="">全部地区</option>
                        {volist name="$country_list" id='vo'}
                        <option value="{$vo}">{$vo}</option>
                        {/volist}
                    </select>
                    <div class="total">合计：<span>{$total_count}</span></div>
                </div>
                <div class="layui-card-body table-scroll">
                    <table id="list_table3" class="layui-table merge layui-table-sm">

                        <thead>
                            <tr>
                                <th>产品分类</th>
                                <th>地区</th>
                                <th>销售数量</th>
                            </tr>
                        </thead>
                        <tbody>
                            {volist name="$data['product_data']['order_prod_category_country']" id='vo'}
                            <tr>
                                <td>{$vo['category_name']}</td>
                                <td>{$vo['country']}</td>
                                <td>{$vo['count']}</td>
                            </tr>
                            {/volist}
                            {if !$data['product_data']['order_prod_category_country']}<tr>
                                <td colspan="3">暂无数据</td>
                            </tr>{/if}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <div class="layui-col-md6">
            <div class="layui-card fold-card export">

                <div class="layui-card-header">询盘产品分类地区排行</div>
                            <div class="filter-bar">
                    {php}
                        if($data['product_data']['order_prod_country']){
                            $total_count = array_sum(array_column($data['product_data']['oper_prod_category_country'], 'count'));
                            $category_name_list = array_unique(array_column($data['product_data']['oper_prod_category_country'], 'category_name'));
                            $country_list = array_unique(array_column($data['product_data']['oper_prod_category_country'], 'xs_area'));
                        }else{
                            $total_count = 0;
                            $category_name_list = [];
                            $country_list = [];
                        }
                    {/php}
                    <label>产品筛选：</label>
                    <select id="product_filter4" lay-filter="product_filter4" class="layui-select" diy-search
                        style="width: 150px; margin-right: 15px;">
                        <option value="">全部产品</option>
                        {volist name="$category_name_list" id='vo'}
                        <option value="{$vo}">{$vo}</option>
                        {/volist}
                    </select>
                    <label>地区筛选：</label>
                    <select id="country_filter4" lay-filter="country_filter4" class="layui-select" diy-search
                        style="width: 150px; margin-right: 15px;">
                        <option value="">全部地区</option>
                        {volist name="$country_list" id='vo'}
                        <option value="{$vo}">{$vo}</option>
                        {/volist}
                    </select>
                    <div class="total">合计：<span>{$total_count}</span></div>
                </div>
                <div class="layui-card-body table-scroll">
                    <table id="list_table4" class="layui-table merge layui-table-sm">
                        <thead>
                            <tr>
                                <th>产品分类</th>
                                <th>地区</th>
                                <th>询盘数量</th>
                            </tr>
                        </thead>
                        <tbody>

                            {volist name="$data['product_data']['oper_prod_category_country']" id='vo'}
                            <tr>
                                <td>{$vo['category_name']}</td>
                                <td>{$vo['xs_area']}</td>
                                <td>{$vo['count']}</td>
                            </tr>
                            {/volist}
                            {if !$data['product_data']['oper_prod_category_country']}<tr>
                                <td colspan="3">暂无数据</td>
                            </tr>{/if}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    function initFoldCard() {
        $('.fold-card').each(function () {
            var $card = $(this);
            var $header = $card.find('.layui-card-header');
            var $scroll = $card.find('.table-scroll');
            if ($scroll.length && $scroll[0].scrollHeight > $scroll.height() + 20) {
                if ($header.find('.toggle-table').length === 0) {
                    $header.append('<button class="layui-btn layui-btn-xs toggle-table">展开</button>');
                }
            } else {
                $header.find('.toggle-table').remove();
            }
        });
    }
    // 页面初始化时运行一次
    $(document).ready(init);

    function init() {
        initFoldCard();
        ExportSelectTables.addCheckboxes();
        mergeProductCells(); // 调用合并单元格函数

        // 初始化自定义搜索
        DiySearch.init({
            elem: ".diy-search",
        });
    }

    // 合并相同产品名称的单元格
    function mergeProductCells() {
        // 获取所有包含产品列的表格
        $('table.merge').each(function () {
            var $table = $(this);
            var $thead = $table.find('thead tr');
            var $tbody = $table.find('tbody tr');

            // 检查表头是否有"产品"列
            var hasProductColumn = false;
            var productColumnIndex = -1;

            $thead.find('th').each(function (index) {
                if (index === 0) {
                    hasProductColumn = true;
                    productColumnIndex = index;
                    return false;
                }
            });

            if (hasProductColumn && $tbody.length > 0) {
                var currentProduct = '';
                var startRow = 0;
                var rowCount = 0;

                $tbody.each(function (rowIndex) {
                    var $row = $(this);
                    var $cell = $row.find('td').eq(productColumnIndex);
                    var productName = $cell.text().trim();

                    if (productName === currentProduct) {
                        rowCount++;
                    } else {
                        // 合并之前的相同产品单元格
                        if (rowCount > 1) {
                            $tbody.eq(startRow).find('td').eq(productColumnIndex).attr('rowspan', rowCount);
                            for (var i = startRow + 1; i < startRow + rowCount; i++) {
                                $tbody.eq(i).find('td').eq(productColumnIndex).hide();
                                // $tbody.eq(i).find('td').eq(productColumnIndex).remove();
                            }
                        }

                        // 开始新的产品计数
                        currentProduct = productName;
                        startRow = rowIndex;
                        rowCount = 1;
                    }
                });

                // 处理最后一组相同的产品
                if (rowCount > 1) {
                    $tbody.eq(startRow).find('td').eq(productColumnIndex).attr('rowspan', rowCount);
                    for (var i = startRow + 1; i < startRow + rowCount; i++) {
                        $tbody.eq(i).find('td').eq(productColumnIndex).hide();
                    }
                }
            }
        });
    }



</script>