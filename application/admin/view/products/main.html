{include file="common/head"/}
<link rel="stylesheet" type="text/css" href="/static/admin/css/admin.css" />
<link rel="stylesheet" type="text/css" href="/static/admin/css/panel.css" />
<div class="admin-main layui-anim layui-anim-upbit">

    <!--  核心指标 -->
    <div class="layui-row layui-col-space15">
        <div class="layui-col-sm3 layui-col-md6">
            <form class="layui-form" id="searchForm">
                <fieldset class="layui-elem-field " style="padding:18px 0;">
                    <legend>时间范围查询</legend>
                    <div class="layui-row">
                        <div class="layui-col-md8">
                            <div class="layui-form-item">
                                <label class="layui-form-label">时间范围：</label>
                                <div class="layui-input-inline">
                                    <div class="layui-col-sm3  layui-col-md8">
                                        <select id="dateRange" lay-filter="dateRange" name="timebucket"
                                            class="layui-input">
                                            <option value="">自定义</option>
                                            <option value="today" selected>今天</option>
                                            <option value="yesterday">昨天</option>
                                            <option value="week">本周</option>
                                            <option value="month">本月</option>
                                            <option value="last month">上月</option>
                                            <option value="year">今年</option>
                                        </select>
                                    </div>
                                    <div class="layui-col-sm3 layui-col-md4">
                                        <div class="layui-input-inline">
                                            <input type="text" class="layui-input" id="at_time" name="at_time"
                                                placeholder="选择日期范围">
                                        </div>
                                    </div>
                                </div>
                            </div>

                        </div>
                        <div class="layui-col-md4">
                            <button class="layui-btn layuiadmin-btn-list" lay-submit lay-filter="LAY-search">
                                <i class="layui-icon layui-icon-search layuiadmin-button-btn"
                                    style="vertical-align: sub;"></i>查询数据
                            </button>
                        </div>
                    </div>
                </fieldset>
            </form>
        </div>
    </div>

    <div class="layui-row layui-col-space15">
        <div class="layui-col-md12">
            <div class="layui-card-header tongji"
                style="font-size:18px; font-weight:bold; color:#333; display:flex; align-items:center;">
                <i class="layui-icon layui-icon-data" style="margin-right:8px; color:#009688;"></i>
                {$data['org']} 数据统计
                <button style="margin-left: 20px;" class="layui-btn layuiadmin-btn-list"
                    onclick="ExportSelectTables.exportSelected('运营数据导出')">导出选中表格</button>
            </div>
        </div>
    </div>


    <!-- 主体部分：左边统计，右边待办 -->
    <div class="layui-row layui-col-space15 diy-search" id="search-con">
        {include file="products/main_content"/}
    </div>
</div>

{include file="common/foot"/}
<script src="/js/xlsx.full.min.js"></script>
<script src="/static/admin/js/export.js"></script>


<script>

    layui.use(['table', 'laydate', 'form'], function () {

        var table = layui.table,
            laydate = layui.laydate,
            form = layui.form,
            $ = layui.jquery;


        function loadData(searchData) {
            $.ajax({
                url: "{:url('Products/main')}",
                type: "POST",
                data: { keyword: searchData },
                success: function (res) {
                    $("#search-con").html(res);
                },
                error: function () {
                    layer.msg('网络错误，请重试');
                }
            });
        }

        // 页面初始化时自动查询一次
        $(document).ready(function () {
            // 获取表单数据并查询
            var formData = {
                timebucket: $('#dateRange').val() || 'today',
                at_time: $('#at_time').val()
            };
            loadData(formData);
        });
        // 搜索表单
        form.on('submit(LAY-search)', function (data) {
            loadData(data.field);
            return false;
        });
        // 日期控件
        laydate.render({
            elem: '#at_time',
            range: true, // 开启范围选择
            trigger: 'click',
        });

        // 控制日期范围选择框的显示与隐藏
        form.on('select(dateRange)', function (data) {
            const isCustom = data.value === '';
            $('#at_time').toggle(isCustom);
            if (!isCustom) {
                $('#at_time').val('');
            }

        });

        // 初始隐藏日期范围选择框
        $('#at_time').hide();
        // 委托绑定
        $(document).on('click', '.toggle-table', function () {
            var $btn = $(this);
            var $scroll = $btn.closest('.fold-card').find('.table-scroll');

            if ($scroll.length === 0) {
                console.warn("未找到 table-scroll 容器");
                return;
            }
            $scroll.toggleClass('expanded');
            if ($scroll.hasClass('expanded')) {
                $btn.text('折叠');
            } else {
                $btn.text('展开');
            }
        });

    })

    // 产品排行筛选功能 - 支持合并单元格
    function filterList(selector, table, column = 0) {
        var selectedName = $(selector).val();
        var totalSum = 0;
        var $table = $(table);
        var $rows = $table.find('tbody tr');
        var mergeColumn = 0; // 只处理第一列的合并单元格

        function toggleRows(startIndex, rowspan, show) {
            for (var i = 0; i < rowspan; i++) {
                var $r = $rows.eq(startIndex + i);
                if ($r.length > 0) {
                    show ? $r.show() : $r.hide();
                    if (show) {
                        var num = Number($r.find('td:last').text().replace(/,/g, '').trim()) || 0;
                        totalSum += num;
                    }
                }
            }
        }

        for (var rowIndex = 0; rowIndex < $rows.length; rowIndex++) {
            var $row = $rows.eq(rowIndex);
            if ($row.find('td').length === 0) continue; // 跳过被合并的行

            var $mergeCell = $row.find('td:eq(' + mergeColumn + ')');
            var rowspan = $mergeCell.attr('rowspan') ? parseInt($mergeCell.attr('rowspan')) : 1;

            var shouldShow = false;

            if (!selectedName) {
                shouldShow = true;
            } else if (column === mergeColumn) {
                // 如果筛选的是合并列
                name = $mergeCell.text().trim();
                shouldShow = (name === selectedName);
            } else {
                // 搜索的是非合并列 → 遍历整个合并组
                for (var i = 0; i < rowspan; i++) {
                    var $subRow = $rows.eq(rowIndex + i);
                    var name = $subRow.find('td:eq(' + column + ')').text().trim();
                    if (name === selectedName) {
                        shouldShow = true;
                        break;
                    }
                }
            }
            toggleRows(rowIndex, rowspan, shouldShow);
            rowIndex += rowspan - 1;
        }

        $table.closest('.layui-card').find('.total span').text(totalSum);
    }

    for (let i = 1; i < 5; i++) {
        $(document).on('change', '#product_filter' + i, function () {
            // 筛选产品时，地区恢复默认
            $('#country_filter' + i).val('');
            $('#input_country_filter' + i).val('');
            filterList('#product_filter' + i, '#list_table' + i);
        });
        $(document).on('change', '#country_filter' + i, function () {
            $('#product_filter' + i).val('');
            $('#input_product_filter' + i).val('');

            filterList('#country_filter' + i, '#list_table' + i, 1);
        });
    }

    var DiySearch = (function () {

        // 收集 lay-search 区域内的条件
        function getParams($search) {
            var params = {};
            $search.find("input, select, textarea").each(function () {
                console.log($(this));
                var name = $(this).attr("name");
                var value = $(this).val();
                if (name) {
                    params[name] = value;
                }
            });
            return params;
        }

        // 触发搜索
        function doSearch($search, opts) {
            var params = getParams($search);
            if (typeof opts.onSearch === "function") {
                opts.onSearch(params);
            }
        }

        // 为 select 元素创建自定义搜索框
        function createCustomSearch($select) {
            var selectId = $select.attr('id');
            var selectName = $select.attr('name') || '';
            var placeholder = $select.find('option:first').text().trim() || '搜索...';
            var width = $select.css('width') || '150px';
            var id = 'input_'+ selectId ;
            // 创建包装器
            var $wrapper = $('<div class="custom-select-wrapper" style="position: relative; display: inline-block; width: ' + width + '; margin-right: 15px; z-index: 1;"></div>');

            // 创建搜索输入框
            var $searchInput = $('<input type="text" class="custom-select-search" placeholder="' + placeholder + '" ' +
                'id="' + id + '"' +
                'style="width: 100%; padding: 6px 8px; border: 1px solid #e6e6e6; border-radius: 2px; height: 32px; line-height: 20px; box-sizing: border-box;">');
            // 克隆原始 select 并设置为透明
            var $originalSelect = $select.clone();
            $originalSelect.addClass('custom-select-original');
            $originalSelect.css({
                'position': 'absolute',
                'top': '0',
                'left': '0',
                'opacity': '0',
                'height': '32px',
                'width': width,
                'pointer-events': 'none'
            });

            // 创建下拉框
            var $dropdown = $('<div class="custom-select-dropdown" style="position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #e6e6e6; border-top: none; max-height: 200px; overflow-y: auto; z-index: 1000; display: none;"></div>');

            // 组装元素
            $wrapper.append($searchInput);
            $wrapper.append($originalSelect);
            $wrapper.append($dropdown);

            // 替换原始 select
            $select.replaceWith($wrapper);

            // 获取所有选项
            var options = [];
            $originalSelect.find('option').each(function () {
                var $option = $(this);
                options.push({
                    value: $option.val(),
                    text: $option.text()
                });
            });

            function getDropdown(ele) {
                var searchTerm = $(ele).val().toLowerCase().trim();

                // 过滤选项 
                var filteredOptions = options.filter(function (option) {
                    return option.text.toLowerCase().includes(searchTerm); //模糊匹配
                    // return option.text.toLowerCase().startsWith(searchTerm); //- 前缀匹配
                });

                // 清空下拉框
                $dropdown.empty();

                if (filteredOptions.length === 0) {
                    $dropdown.append('<div style="padding: 8px; color: #999;">无匹配结果</div>');
                    $searchInput.val('');
                } else {
                    filteredOptions.forEach(function (option) {
                        var $item = $('<div style="padding: 8px; cursor: pointer; border-bottom: 1px solid #f0f0f0;">' + option.text + '</div>');
                        $item.on('click', function () {
                            $searchInput.val(option.text);
                            $originalSelect.val(option.value);
                            $dropdown.hide();
                            // 触发change事件
                            $originalSelect.trigger('change');
                        });
                        $dropdown.append($item);
                    });
                }

                $dropdown.show();
            }

            // 搜索输入事件
            $searchInput.on('input', function () {
                var searchTerm = $(this).val().toLowerCase().trim();

                if (searchTerm === '') {
                    $dropdown.hide();
                    return;
                }
                getDropdown(this);
            });

            $searchInput.on('click', function () {
                //重置输入框
                $(this).val('');
                getDropdown(this);
            });

            // 当选择框值改变时更新搜索框
            $originalSelect.on('change', function () {
                var selectedValue = $(this).val();
                var selectedText = $originalSelect.find('option[value="' + selectedValue + '"]').text();
                $searchInput.val(selectedText);
            });

            // 点击外部关闭下拉框
            $(document).on('click', function (e) {
                if (!$(e.target).closest($wrapper).length) {
                    $dropdown.hide();
                }
            });

            return $wrapper;
        }

        // 初始化
        function init(options) {
            var defaults = {
                elem: ".diy-search",     // 搜索区域选择器
                onSearch: null,          // 搜索回调 (params)
                onReset: null            // 重置回调 ()
            };
            var opts = $.extend({}, defaults, options);

            var $search = $(opts.elem);
            $search.find("select").each(function () {
                //新增输入框
                createCustomSearch($(this));

            });

            // 输入框回车触发搜索
            $search.find("input").off("keypress").on("keypress", function (e) {
                if (e.which === 13) { // 回车键
                    e.preventDefault(); // 防止表单提交刷新
                    doSearch($search, opts);
                }
            });
        }

        return {
            init: init
        };
    })();


</script>
</body>

</html>