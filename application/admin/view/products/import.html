<!DOCTYPE html>
<html>

<head> {include file="common/head"/} </head>

<body>
  <form class="layui-form" style="padding:18px 20px;">
    <div class="layui-form-item">
      <blockquote class="layui-elem-quote"> 支持 <b>.xlsx / .xls / .csv</b> 文件。字段顺序：<br>
        A=产品名称，B=供应商(分类名称)，C=供应商ID(可选)，D=状态(0/1，可选)。<br> 第一行可写表头（包含“产品”或“供应”字样会自动识别为表头并跳过）。<br>
        若提供了供应商ID则优先使用；否则按供应商名称在当前组织下查找，不存在则自动创建。<br> 去重规则：同组织 + 同供应商 + 同产品名 视为重复，不会重复导入。 </blockquote>
    </div>
    <div class="layui-form-item"> <label class="layui-form-label">选择文件</label>
      <div class="layui-input-block"> <input type="file" name="file" id="excel-file" accept=".xlsx,.xls,.csv"
          class="layui-input"> </div>
    </div>
    <div class="layui-form-item">
      <div class="layui-input-block"> <button type="button" class="layui-btn" id="btn-upload">开始导入</button> <button
          type="button" class="layui-btn layui-btn-normal" id="btn-tpl">下载模板</button> <button type="button"
          class="layui-btn layui-btn-primary"
          onclick="var i=parent.layer.getFrameIndex(window.name);parent.layer.close(i);">取消 </button> </div>
    </div>
  </form>
  {include file="common/foot"/}

  <script> layui.use(['jquery', 'layer'], function () { var $ = layui.jquery, layer = layui.layer; $('#btn-upload').on('click', function () { var file = $('#excel-file')[0].files[0]; if (!file) { return layer.msg('请先选择文件'); } var fd = new FormData(); fd.append('file', file); var loadIdx = layer.load(2, { shade: 0.2 }); $.ajax({ url: "{:url('Products/importDo')}", type: 'POST', data: fd, processData: false, contentType: false, success: function (res) { layer.close(loadIdx); if (res.code === 0) { var d = res.data || {}; var tip = '导入成功：' + (d.inserted || 0) + ' 条' + '，重复跳过：' + (d.skipped_exist || 0) + '，空/无效跳过：' + (d.skipped_empty || 0) + '，自动创建供应商：' + (d.created_cats || 0); layer.msg(tip, { icon: 1, time: 1400 }, function () { parent.layui.table.reload('table-list', { page: { curr: 1 } }); var index = parent.layer.getFrameIndex(window.name); parent.layer.close(index); }); } else { layer.msg(res.msg || '导入失败', { icon: 2 }); } }, error: function () { layer.close(loadIdx); layer.msg('请求失败，请重试', { icon: 2 }); } }); }); $('#btn-tpl').on('click', function () { window.location.href = "{:url('Products/tpl')}"; }); }); </script>
</body>

</html>