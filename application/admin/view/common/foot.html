<!-- Bootstrap 5 JS Bundle -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<!-- LayUI JS (保留用于兼容) -->
<script type="text/javascript" src="/static/plugins/layui/layui.js"></script>
<!-- xmSelect 多选插件 JS -->
<script src="/static/admin/js/xm-select.js"></script>
<script>
layui.use(['layer'], function () {
    var layer = layui.layer;

    document.addEventListener('keydown', function (e) {
        e = e || window.event;
        var keyCode = e.keyCode || e.which;

        // ESC 键
        if (keyCode === 27) {
            try {
                // 优先拿到最顶层的 layer（一般所有弹窗都在 top 里）
                var topLayer = null;
                if (top && top.layui && top.layui.layer) {
                    topLayer = top.layui.layer;
                } else if (layui && layui.layer) {
                    topLayer = layui.layer;
                }
                if (!topLayer) {
                    return;
                }

                // 1) 如果自己是在 iframe 里，尝试只关闭“当前这一层”
                var closed = false;
                if (window !== top && window.name) {
                    try {
                        var index = topLayer.getFrameIndex(window.name);
                        if (typeof index !== 'undefined') {
                            topLayer.close(index);
                            closed = true;
                        }
                    } catch (err) {
                        // 忽略
                    }
                }

                // 2) 如果上面没关掉（比如不是 layer 的 iframe），那就直接把所有 layer 都关掉
                if (!closed) {
                    // 不加类型参数，关闭所有类型（page / iframe / msg 等）
                    topLayer.closeAll();
                }
            } catch (err) {
                // 忽略异常
            }
        }
    });
});
</script>


