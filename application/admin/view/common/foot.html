<!-- Bootstrap 5 JS Bundle -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<!-- LayUI JS (保留用于兼容) -->
<script type="text/javascript" src="/static/plugins/layui/layui.js"></script>
<!-- xmSelect 多选插件 JS -->
<script src="/static/admin/js/xm-select.js"></script>
<script>
(function () {
    // 统一的 ESC 关闭弹窗逻辑，所有包含此脚本的页面都会生效
    document.addEventListener('keydown', function (e) {
        var key = e.key || e.keyCode || e.which;
        if (key !== 'Escape' && key !== 'Esc' && key !== 27) {
            return;
        }

        try {
            // 优先使用顶层的 layer，保证 iframe 弹窗也能被捕获
            var topLayer = (top && top.layui && top.layui.layer) ? top.layui.layer : null;
            if (!topLayer && window.layui && window.layui.layer) {
                topLayer = window.layui.layer;
            }

            if (!topLayer) {
                return;
            }

            // 如果当前页面在 iframe 中，先尝试只关闭当前这一层
            var closed = false;
            if (window !== top && window.name && typeof topLayer.getFrameIndex === 'function') {
                var index = topLayer.getFrameIndex(window.name);
                if (typeof index !== 'undefined') {
                    topLayer.close(index);
                    closed = true;
                }
            }

            // 如果不是 iframe 弹窗或无法定位具体窗口，则关闭所有 layer 弹窗
            if (!closed) {
                topLayer.closeAll();
            }
        } catch (err) {
            // 忽略异常，避免影响页面其他逻辑
        }
    });
})();
</script>


