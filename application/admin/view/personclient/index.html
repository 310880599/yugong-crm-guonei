<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>{:config('sys_name')}后台管理</title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <link rel="stylesheet" href="/static/plugins/layui/css/layui.css" media="all" />
    <link rel="stylesheet" href="/static/admin/css/global.css" media="all">
    <link rel="stylesheet" href="/static/common/css/font.css" media="all">
    <link rel="stylesheet" href="/static/admin/css/select.css" media="all">
    <script src="/static/admin/js/select.js"></script>
    <style>
       .filtrate-warp { margin-bottom: 10px; }
        .filtrate-warp .title { padding: 5px 12px 7px 12px; font-size: 14px; font-weight: normal; text-align: left; cursor: pointer; width: 90px; background-color: transparent !important; color: black !important; }
        .filtrate-warp .title:hover { color: black; }
        .filtrate-warp .flag { padding: 6px 12px 6px 12px; cursor: pointer; }
        .filtrate-warp .flag:hover { color: black; }
        .filtrate-warp .layui-badge:hover { color: white !important; }
        
        /* 跟进弹窗样式 */
        .follow-container { padding: 15px; }
        .follow-header { border-bottom: 1px solid #e6e6e6; padding-bottom: 10px; margin-bottom: 15px; }
        .follow-content { display: flex; }
        .follow-info { flex: 1; padding-right: 15px; }
        .follow-history { flex: 1; border-left: 1px solid #e6e6e6; padding-left: 15px; }
        .info-item { margin-bottom: 10px; }
        .info-label { font-weight: bold; display: inline-block; width: 80px; }
        .timeline-item { margin-bottom: 15px; }
        .timeline-title { color: rosybrown; font-size: 14px; margin-bottom: 5px; }
        .timeline-content { margin-left: 10px; }
        .avatar { width: 30px; height: 30px; border-radius: 50%; margin-right: 5px; vertical-align: middle; }
    </style>
</head>

<body class="skin-<?php if(!empty($_COOKIE['skin'])){echo $_COOKIE['skin'];}else{echo '0';setcookie('skin','0');}?>">
<div class="admin-main layui-anim layui-anim-upbit">

    <fieldset class="layui-elem-field">
        <legend>高级查询</legend>
        <div class="layui-card" style="box-shadow:none;margin-top:10px">
            <div class="layui-form layui-card-header layuiadmin-card-header-auto" style="border-bottom:transparent;height:auto">

                <div class="layui-form-item" style="text-align:left;padding-left:20px;">

                    <div class="layui-inline">
                        <label class="layui-form-label">客户级别：</label>
                        <div class="layui-input-inline">
                            <select name="kh_rank" id="kh_rank">
                                <option value="">请选择客户级别</option>
                                {volist name='khRankList' id='vo'}
                                <!-- 这里 value 用 ID，后端才能按 ID 等值筛选 -->
                                <option value="{$vo.id}">{$vo.rank_name}</option>
                                {/volist}
                            </select>
                        </div>
                    </div>

                    <div class="layui-inline">
                        <label class="layui-form-label">客户来源：</label>
                        <div class="layui-input-inline">
                            <select name="kh_status" id="kh_status">
                                <option value="">请选择客户来源</option>
                                {volist name='khStatusList' id='vo'}
                                <!-- 同理，这里也用 ID -->
                                <option value="{$vo.id}">{$vo.status_name}</option>
                                {/volist}
                            </select>
                        </div>
                    </div>

                    <div class="layui-inline">
                        <label class="layui-form-label">手机：</label>
                        <div class="layui-input-inline">
                            <input type="text" id="phone" name="phone" placeholder="请输入手机号码" class="layui-input">
                        </div>
                    </div>

                    <div class="layui-inline">
                        <label class="layui-form-label">客户名称：</label>
                        <div class="layui-input-inline">
                            <input type="text" id="kh_name" name="kh_name" placeholder="请输入客户名称" class="layui-input">
                        </div>
                    </div>

                    <div class="layui-inline">
                        <label class="layui-form-label">运营人员：</label>
                        <div class="layui-input-4">
                            <input type="text" id="oper_user_input" name="oper_user" placeholder="请选择运营人员" class="layui-input">
                        </div>
                    </div>

                    <div class="layui-inline">
                        <label class="layui-form-label">日期查询：</label>
                        <div class="layui-input-inline">
                            <select id="dateRange" lay-filter="dateRange" name="timebucket" class="layui-select">
                                <option value="" selected>自定义</option>
                                <option value="today">今天</option>
                                <option value="yesterday">昨天</option>
                                <option value="week">本周</option>
                                <option value="last week">上周</option>
                                <option value="month">本月</option>
                                <option value="last month">上月</option>
                                <option value="year">今年</option>
                                <option value="last year">去年</option>
                                <option value="-2 hours">两个小时内</option>
                            </select>
                        </div>
                        <div class="layui-input-inline">
                            <input type="text" class="layui-input" id="at_time" name="at_time" placeholder="选择日期范围">
                        </div>
                    </div>

                </div>

                <div class="layui-inline" style="float:right;padding-bottom:15px">
                    <button class="layui-btn layuiadmin-btn-list" lay-submit lay-filter="LAY-app-contlist-search">
                        <i class="layui-icon layui-icon-search layuiadmin-button-btn" style="vertical-align:sub;"></i>查询数据
                    </button>
                </div>

            </div>
        </div>
    </fieldset>

    <table class="layui-table" id="table-list" lay-filter="table-list"></table>
</div>
<!-- 跟进弹窗 -->
<div id="follow-dialog" style="display: none;">
    <div class="follow-container">
        <div class="follow-header">
            <h3>客户跟进</h3>
        </div>
        <div class="follow-content">
            <div class="follow-info">
                <div class="info-item">
                    <span class="info-label">客户ID:</span>
                    <span id="follow-client-id"></span>
                </div>
                <div class="info-item">
                    <span class="info-label">客户名称:</span>
                    <span id="follow-client-name"></span>
                </div>
                <div class="info-item">
                    <span class="info-label">联系人:</span>
                    <span id="follow-contact"></span>
                </div>
                <div class="info-item">
                    <span class="info-label">地区:</span>
                    <span id="follow-area"></span>
                </div>
                <div class="info-item">
                    <span class="info-label">客户来源:</span>
                    <span id="follow-source"></span>
                </div>
                <div class="info-item">
                    <span class="info-label">客户级别:</span>
                    <span id="follow-rank"></span>
                </div>
                <div class="info-item">
                    <span class="info-label">负责人:</span>
                    <span id="follow-user"></span>
                </div>
                <div class="info-item">
                    <span class="info-label">创建时间:</span>
                    <span id="follow-create-time"></span>
                </div>
                <div class="info-item">
                    <span class="info-label">最后跟进:</span>
                    <span id="follow-last-time"></span>
                </div>
                <div class="info-item">
                    <span class="info-label">跟进记录:</span>
                    <textarea id="follow-last-record" class="layui-textarea" readonly style="height: 80px;"></textarea>
                </div>
            </div>
            <div class="follow-history">
                <h4>跟进历史</h4>
                <div id="follow-history-list" style="max-height: 300px; overflow-y: auto;">
                    <!-- 跟进历史将通过JS动态加载 -->
                </div>
                <div style="margin-top: 20px;">
                    <h4>添加跟进记录</h4>
                    <div class="layui-form-item layui-form-text">
                        <textarea name="reply_msg" id="reply_msg" required lay-verify="required"
                            placeholder="请输入跟进内容" class="layui-textarea" style="height: 100px;"></textarea>
                    </div>
                    <div class="layui-form-item">
                        <input type="hidden" name="leads_id" id="leads_id" value="">
                        <button class="layui-btn" lay-filter="btn_comment" lay-submit id="submit-comment">提交记录</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- 操作列 -->
<script type="text/html" id="action">
     <a class="layui-btn layui-btn-primary layui-btn-xs follow-btn" href="javascript:void(0);" data-id="{{d.id}}"><i class="layui-icon">&#xe654;</i>写跟进</a>
    <a class="layui-btn layui-btn-xs" data-id="{{d.id}}" lay-event="edit"><i class="layui-icon">&#xe642;</i>编辑</a>
    <a class="layui-btn layui-btn-primary layui-btn-xs" data-id="{{d.id}}" lay-event="alter"><i class="layui-icon">&#xe60e;</i>转移</a>
    <a class="layui-btn layui-btn-primary layui-btn-xs" data-id="{{d.id}}" lay-event="chengjiao"><i class="layui-icon">&#xe63c;</i>成交</a>
</script>

<!-- 顶部工具栏 -->
<script type="text/html" id="topBtn">
    <button type="button" class="layui-btn layui-btn-primary layui-btn-radius layui-btn-sm" id="add"><i class="layui-icon">&#xe608;</i>添加客户</button>
    <button type="button" class="layui-btn layui-btn-normal layui-btn-radius layui-btn-sm" id="toAll" style="margin-right:10px"><i class="layui-icon">&#xe681;</i>导入客户</button>
    <button type="button" class="layui-btn layui-btn-danger layui-btn-radius layui-btn-sm" id="moveGh" lay-event="moveGh"><i class="layui-icon">&#xe770;</i>移入公海</button>
    <button type="button" class="layui-btn layui-btn-primary layui-btn-radius layui-btn-sm" id="alterAll" lay-event="alterAll"><i class="layui-icon">&#xe60e;</i>转移客户</button>
    <button type="button" class="layui-btn layui-btn-primary layui-btn-radius layui-btn-sm" id="chengjiaoAll" lay-event="chengjiaoAll"><i class="layui-icon">&#xe63c;</i>客户成交</button>
    {if session('aid') eq 1}
    <button type="button" class="layui-btn layui-btn-danger layui-btn-radius layui-btn-sm" id="delAlls" lay-event="delAlls"><i class="layui-icon">&#xe640;</i>选中删除</button>
    {/if}
</script>

{include file="common/foot"/}
<script>
layui.use(['table','form','upload','util','laydate'], function () {
    var table = layui.table, form = layui.form, laydate = layui.laydate, $ = layui.jquery, upload = layui.upload;
    var isMobile = $(window).width() < 768;
    var currentUsername = "{$Think.session.username}" || "default";
    var columnWidthKey = "crm_table_column_widths_" + currentUsername;
    var tableId = "table-list";

    // 列定义
    var cols = [[
        { type: 'checkbox', fixed: true },
        { field: 'id', title: 'ID', width: 80, fixed: true, hide: true },
        { field: 'kh_name', title: '客户名称', sort: true, templet: function(res){
            return "<a href='{:url('dialogue')}?id=" + res.id + "'>" + (res.kh_name || '') + "</a>";
        }},
        { field: 'kh_status_name', title: '询盘来源' },
        { field: 'main_phone', title: '主电话' },
        { field: 'aux_phone', title: '辅助电话' },
        { field: 'joint_person_names', title: '协同人' },
        { field: 'issuccess', title: '成交状态', templet: function(res){ return res.issuccess == 1 ? '已成交' : '未成交'; } },
        { field: 'last_up_records', title: '最新跟进记录' },
        { field: 'pr_user', title: '负责人' },
        { field: 'at_time', title: '创建时间', sort: true },
        { field: 'ut_time', title: '更新于', sort: true },
        { fixed: 'right', width: isMobile ? 100 : 320, align: 'center', toolbar: '#action' }
    ]];

    restoreColWidth(cols[0]);

    // 列表初始化（注意：根据你的实际路由改这里）
    var tableIns = table.render({
        elem: '#' + tableId,
        id: tableId,
        url: "{:url('perClilist')}",   // 若你的路由为 perCliList，请改成 perCliList
        method: 'post',
        toolbar: '#topBtn',
        defaultToolbar: ['filter'],
        page: true,
        limit: 30,
        cols: cols,
        done: bindResizeSave
    });
 // 点击写跟进按钮打开弹窗
    $(document).on('click', '.follow-btn, .client-link', function() {
        var clientId = $(this).data('id');
        openFollowDialog(clientId);
    });

      // 打开跟进弹窗
    function openFollowDialog(clientId) {
        // 显示加载提示
        var loading = layer.load(1, {shade: [0.1, '#fff']});
        
        // 获取客户信息和跟进记录
        $.ajax({
            url: "{:url('Client/getClientDetailAndComments')}",
            method: 'GET',
            data: {id: clientId},
            success: function(res) {
                layer.close(loading);
                if (res.code === 0) {
                    var clientData = res.data.client;
                    var comments = res.data.comments;
                    
                    // 填充客户信息
                    $('#follow-client-id').text(clientData.id);
                    $('#follow-client-name').text(clientData.kh_name);
                    $('#follow-contact').text(clientData.kh_contact);
                    $('#follow-area').text(clientData.xs_area);
                    $('#follow-source').text(clientData.kh_status);
                    $('#follow-rank').text(clientData.kh_rank);
                    $('#follow-user').text(clientData.pr_user);
                    $('#follow-create-time').text(clientData.at_time);
                    $('#follow-last-time').text(clientData.last_up_time || '暂无');
                    $('#follow-last-record').val(clientData.last_up_records || '暂无记录');
                    $('#leads_id').val(clientData.id);
                    
                    // 填充跟进历史
                    var html = '';
                    if (comments.length > 0) {
                        $.each(comments, function(index, item) {
                            html += '<div class="timeline-item">' +
                                '<div class="timeline-title">' + item.create_date + '</div>' +
                                '<div class="timeline-content">' +
                                '<img src="' + (item.avatar || '/static/admin/images/0.jpg') + '" class="avatar" onerror="this.src=\'/static/admin/images/0.jpg\'">' +
                                '<strong>' + item.username + '：</strong>' +
                                item.reply_msg +
                                '</div>' +
                                '</div>';
                        });
                    } else {
                        html = '<p>暂无跟进记录</p>';
                    }
                    $('#follow-history-list').html(html);
                    
                    // 显示弹窗
                    layer.open({
                        type: 1,
                        title: '客户跟进 - ' + clientData.kh_name,
                        area: ['90%', '80%'],
                        content: $('#follow-dialog'),
                        zIndex: layer.zIndex,
                        key: true, // 启用键盘事件，包括ESC关闭
                        success: function(layero, index) {
                            // 确保弹窗内容正确显示
                            $('#follow-dialog').show();
                            // 确保弹窗在最上层
                            layer.setTop(layero);
                        },
                        end: function() {
                            // 弹窗完全关闭后，确保元素被正确隐藏并移除遮挡
                            $('#follow-dialog').hide().appendTo('body');
                        }
                    });
                } else {
                    layer.msg(res.msg || '获取客户信息失败');
                }
            },
            error: function() {
                layer.close(loading);
                layer.msg('网络错误，获取客户信息失败');
            }
        });
    }
    // 提交跟进记录
    $('#submit-comment').on('click', function() {
        var replyMsg = $('#reply_msg').val();
        var leadsId = $('#leads_id').val();
        
        if (!replyMsg) {
            layer.msg('请输入跟进内容');
            return;
        }
        
        // 显示加载提示
        var loading = layer.load(1, {shade: [0.1, '#fff']});
        
        $.ajax({
            method: 'post',
            url: "{:url('Client/comment')}",
            data: {
                reply_msg: replyMsg,
                leads_id: leadsId
            },
            success: function (res) {
                layer.close(loading);
                if (res.code === 0) {
                    layer.msg(res.msg);
                    $('#reply_msg').val('');
                    
                    // 更新历史记录
                    var now = new Date();
                    var createDate = now.getFullYear() + '年' + (now.getMonth() + 1) + '月' + now.getDate() + '日 ' 
                        + now.getHours() + ':' + (now.getMinutes() < 10 ? '0' : '') + now.getMinutes();
                    
                    var historyHtml = '<div class="timeline-item">' +
                        '<div class="timeline-title">' + createDate + '</div>' +
                        '<div class="timeline-content">' +
                        '<img src="{$Think.session.avatar|default="/static/admin/images/0.jpg"}" class="avatar" onerror="this.src=\'/static/admin/images/0.jpg\'">' +
                        '<strong>{$Think.session.username}：</strong>' +
                        replyMsg +
                        '</div>' +
                        '</div>';
                    $('#follow-history-list').prepend(historyHtml);
                    
                    $('#follow-last-record').val(replyMsg);
                    $('#follow-last-time').text(createDate);
                    
                    // 更新表格中的最新跟进记录
                    tableIns.reload();
                } else {
                    layer.msg(res.msg);
                }
            },
            error: function () {
                layer.close(loading);
                layer.msg('提交失败');
            }
        });
    });
    // 拖拽列宽后的保存
    function bindResizeSave() {
        $(document).off('mouseup.saveWidth').on('mouseup.saveWidth', function () {
            setTimeout(saveWidths, 10);
        });
    }
    function saveWidths() {
        var widths = {};
        $('#' + tableId).next('.layui-table-view').find('th').each(function () {
            var field = $(this).data('field');
            if (field) widths[field] = $(this).outerWidth();
        });
        localStorage.setItem(columnWidthKey, JSON.stringify(widths));
    }
    function restoreColWidth(colArr) {
        var saved = JSON.parse(localStorage.getItem(columnWidthKey) || '{}');
        colArr.forEach(function (c) { if (saved[c.field]) c.width = saved[c.field]; });
    }

    // 添加按钮
    $('#add').on('click', function () {
        layer.open({
            type: 2,
            title: '添加客户',
            area: ['100%', '86%'],
            content: "{:url('Client/add')}"
        });
    });

    // 顶部工具栏事件
    table.on('toolbar(table-list)', function (obj) {
        var checkStatus = table.checkStatus(obj.config.id), data = checkStatus.data;
        switch (obj.event) {
            case 'moveGh':
                if (data.length === 0) { layer.msg('请选择要操作的数据'); return; }
                var ids1 = data.map(function(it){ return it.id; });
                layer.confirm('确定将 ' + data.length + ' 个客户转入公海？', function(index){
                    layer.open({
                        type: 2, title: '移入公海', area: ['100%','86%'],
                        content: "{:url('Client/toMoveGh')}?ids=" + ids1.join(',')
                    });
                    layer.close(index);
                });
                break;
            case 'alterAll':
                if (data.length === 0) { layer.msg('请选择要操作的数据'); return; }
                var ids2 = data.map(function(it){ return it.id; });
                layer.confirm('确定要转移选中的 ' + data.length + ' 个客户吗？', function(index){
                    layer.open({
                        type: 2, title: '转移客户', area: ['100%','86%'],
                        content: "{:url('Client/alterPrUserPri')}?ids=" + ids2.join(',')
                    });
                    layer.close(index);
                });
                break;
            case 'chengjiaoAll':
                if (data.length === 0) { layer.msg('请选择要操作的数据'); return; }
                var ids3 = data.map(function(it){ return it.id; });
                layer.confirm('确定将选中的 ' + data.length + ' 个客户标记为已成交吗？', function(index){
                    $.post("{:url('Client/chengjiao')}", { ids: ids3 }, function(res){
                        layer.close(index);
                        if (res.code === 0) {
                            layer.msg(res.msg, { time: 1000, icon: 1 });
                            tableIns.reload();
                        } else {
                            layer.msg(res.msg || '操作失败', { time: 1500, icon: 2 });
                        }
                    });
                });
                break;
            case 'delAlls':
                if (data.length === 0) { layer.msg('请先选择要删除的客户'); return; }
                var ids4 = data.map(function(it){ return it.id; });
                layer.confirm('确定删除选中的 ' + ids4.length + ' 个客户吗？', function(index){
                    var loading = layer.load(1, { shade: [0.1,'#fff'] });
                    $.post("{:url('del')}", { ids: ids4 }, function(res){
                        layer.close(loading);
                        if (res.code === 0) {
                            layer.msg(res.msg, { time: 1000, icon: 1 });
                            tableIns.reload();
                        } else {
                            layer.msg(res.msg || '删除失败', { time: 1500, icon: 2 });
                        }
                    });
                    layer.close(index);
                });
                break;
        }
    });

    // 行内事件
    table.on('tool(table-list)', function (obj) {
        var layEvent = obj.event, id = obj.data.id;
        lineEvent(layEvent, id);
    });
    // 弹层内按钮事件委托
    $('body').on('click', '.layui-layer-content [lay-event]', function(){
        var layEvent = $(this).attr('lay-event');
        var id = $(this).data('id');
        lineEvent(layEvent, id);
    });
    // 行内事件处理
    function lineEvent(event, id) {
        if (event === 'del') {
            layer.confirm('确定要删除这个客户吗？', function(index){
                var loading = layer.load(1, { shade: [0.1,'#fff'] });
                $.post("{:url('del')}", { ids: [id] }, function(res){
                    layer.close(loading);
                    if (res.code === 0) {
                        layer.msg(res.msg, { time: 1000, icon: 1 });
                        tableIns.reload();
                    } else {
                        layer.msg('操作失败！', { time: 1000, icon: 2 });
                    }
                });
                layer.close(index);
            });
        } else if (event === 'edit') {
            layer_add("编辑客户", "{:url('Client/edit')}?id=" + id);
        } else if (event === 'alter') {
            layer_add("转移客户", "{:url('Client/alterPrUserPri')}?ids=" + id);
        } else if (event === 'chengjiao') {
            layer.confirm('确定这个客户已成交吗？', function(index){
                $.post("{:url('Client/chengjiao')}", { ids: id }, function(res){
                    layer.close(index);
                    if (res.code === 0) {
                        layer.msg(res.msg, { time: 1000, icon: 1 });
                        tableIns.reload();
                    } else {
                        layer.msg('操作失败！', { time: 1000, icon: 2 });
                    }
                });
            });
        }
    }

    // 搜索表单提交
    form.on('submit(LAY-app-contlist-search)', function (data) {
        table.reload('table-list', {
            url: "{:url('Client/personClientSearch')}",
            where: { keyword: data.field },
            page: { curr: 1 }
        });
        return false;
    });

    // 日期控件
    laydate.render({ elem: '#at_time', range: true, trigger: 'click' });
    form.on('select(dateRange)', function (data) {
        var isCustom = data.value === '';
        $('#at_time').toggle(isCustom);
        if (!isCustom) $('#at_time').val('');
    });

    // 运营人员下拉（保持你原来的 EditableSelect 用法）
    const khSelect = new EditableSelect(document.getElementById('oper_user_input'), {$_yyList|raw}, '运营人员', '', 'name');

    // 导入
    upload.render({
        elem: '#toAll',
        url: "{:url('Client/xlsUpload')}",
        accept: 'file',
        field: 'xlsFile',
        exts: 'xls|xlsx',
        before: function () { layer.msg('正在导入数据，请稍等...', { icon: 16, shade: 0.04, time: false }); },
        done: function (res) {
            layer.msg(res.msg, { time: 1800, icon: res.code === 0 ? 1 : 2 });
            if (res.code === 0) location.reload();
        }
    });
});

// 公共弹窗
function layer_add(title, url) {
    layer.open({ type: 2, title: title, area: ['100%','80%'], maxmin: true, content: url });
}
</script>
</body>
</html>