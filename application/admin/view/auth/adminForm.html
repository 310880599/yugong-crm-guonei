<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>{:config('sys_name')}后台管理</title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <link rel="stylesheet" href="/static/plugins/layui/css/layui.css" media="all" />
    <link rel="stylesheet" href="/static/admin/css/global.css" media="all">
    <link rel="stylesheet" href="/static/common/css/font.css" media="all">
    <link rel="stylesheet" href="/static/admin/css/select.css" media="all">
    <script src="/js/jquery.min.js"></script>
    <script src="/js/layer.js"></script>
    <script src="/static/admin/js/select.js"></script>
    <!-- （可选）引入 xmSelect 插件的样式文件，如有 -->
    <!-- <link rel="stylesheet" href="/static/plugins/layui/css/xm-select.css" media="all"> -->
    <!-- 引入 LayUI 核心 JS -->
    <script src="/static/plugins/layui/layui.js"></script>
    <!-- 引入 xmSelect 多选插件 JS（确保在 LayUI 之后引入） -->
    <script src="/static/admin/js/xm-select.js"></script>    
</head>
<body class="skin-<?php if(!empty($_COOKIE['skin'])){echo $_COOKIE['skin'];}else{echo '0';setcookie('skin','0');}?>">
<style>
    /* 修复运营端口下拉列表被遮挡的问题 */
    #operation_ports_select + .layui-form-select,
    #channel-select + .layui-form-select {
        position: relative;
        z-index: 9999;
    }
    
    #operation_ports_select + .layui-form-select dl,
    #channel-select + .layui-form-select dl {
        position: absolute !important;
        z-index: 10000 !important;
        max-height: 300px;
        overflow-y: auto;
        background: #fff;
        border: 1px solid #d2d2d2;
        box-shadow: 0 2px 4px rgba(0,0,0,0.12);
    }
    
    /* 确保多选下拉框的下拉列表在最上层 */
    #port-item .layui-form-select,
    #channel-item .layui-form-select {
        position: relative;
        z-index: 9999;
    }
    
    #port-item .layui-form-select dl,
    #channel-item .layui-form-select dl {
        z-index: 10000 !important;
        position: absolute !important;
        max-height: 300px;
        overflow-y: auto;
    }
    
    /* 修复页面其他可能的遮挡问题 */
    .admin-main {
        position: relative;
        z-index: 1;
        overflow: visible;
    }
    
    .layui-form-item {
        position: relative;
        z-index: auto;
        overflow: visible;
    }
    
    /* 确保下拉列表在所有元素之上 */
    .layui-form-select.layui-form-selected dl {
        z-index: 10001 !important;
    }
    
    /* 当表单容器有overflow属性时，确保下拉框可以显示 */
    .layui-form-pane {
        overflow: visible !important;
    }
    
    /* 修复可能存在的父容器遮挡问题 */
    .layui-form-pane .layui-form-item {
        overflow: visible !important;
    }

    /* 修复多选下拉框选项列表被父容器遮挡的问题 */
    #operation_ports_select + .layui-form-select,
    #channel-select + .layui-form-select {
        position: relative;
        z-index: 9999;
    }

    #operation_ports_select + .layui-form-select dl,
    #channel-select + .layui-form-select dl {
        position: absolute !important;
        z-index: 10000 !important;
        max-height: 300px;
        overflow-y: auto;
        background: #fff;
        border: 1px solid #d2d2d2;
        box-shadow: 0 2px 4px rgba(0,0,0,0.12);
    }

    /* 确保多选下拉框的下拉列表在最上层（针对动态添加的容器） */
    #port-item .layui-form-select,
    #channel-item .layui-form-select {
        position: relative;
        z-index: 9999;
    }

    #port-item .layui-form-select dl,
    #channel-item .layui-form-select dl {
        position: absolute !important;
        z-index: 10000 !important;
        max-height: 300px;
        overflow-y: auto;
    }

    /* 修复页面其他可能的遮挡问题 */
    .admin-main {
        position: relative;
        z-index: 1;
        overflow: visible;
    }
    .layui-form-item {
        position: relative;
        z-index: auto;
        overflow: visible;
    }

    /* 确保下拉列表始终在所有元素之上 */
    .layui-form-select.layui-form-selected dl {
        z-index: 10001 !important;
    }

    /* 当表单容器有 overflow 属性时，确保下拉框可以正常显示 */
    .layui-form-pane {
        overflow: visible !important;
    }
    .layui-form-pane .layui-form-item {
        overflow: visible !important;
    }

    /* 确保主要内容容器允许下拉框溢出显示 */
    .layui-body, .layui-layout-content {
        overflow: visible !important;
    }
    /* （可选）为运营端口下拉容器单独提升层级 */
    #port-item .layui-form-select {
        position: relative;
        z-index: 9999;
    }
    #port-item .layui-form-select dl {
        position: absolute !important;
        z-index: 10000 !important;
        max-height: 300px;  /* 与已有样式一致，限制下拉最大高度 */
        overflow-y: auto;   /* 下拉列表内部可滚动 */
    }


</style>
<div class="admin-main layui-anim layui-anim-upbit">
    <fieldset class="layui-elem-field layui-field-title">
        <legend>{$title}</legend>
    </fieldset>
    <form class="layui-form layui-form-pane" lay-filter="form">
        <div class="layui-form-item">
            <label class="layui-form-label">所属用户组</label>
            <div class="layui-input-4">

                <select name="group_id" id="user_group" lay-verify="required" lay-filter="groupSelect">
                    <option value="">请选择用户组</option>
                    {volist name="authGroup" id="vo"}
                    <option value="{$vo.group_id}" {if $result['is_yy']}selected{/if}>{$vo.title}</option>
                    {/volist}
                </select>
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">所属主管</label>
            <div class="layui-input-4">
                <select name="parent_id">
                    <option value="0">无（不设上级）</option>
                    {volist name="leaderList" id="vo"}
                    <option value="{$vo.admin_id}" {if $result['username']==$vo.username}selected{/if}>{$vo.username}
                    </option>
                    {/volist}
                </select>
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">团队名称</label>
            <div class="layui-input-4">
                <input type="text" name="team_name" value="{$team_name}" placeholder="团队名称（可选）" class="layui-input">

            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">所属组织</label>
            <div class="layui-input-4">
                <select name="org" lay-verify="required" multiple  lay-search id="orgSelect" lay-filter="orgSelect">
                    <option value="">请选择组织</option>
                    {volist name="orgList" id="vo"}
                    <option value="{$vo}">{$vo}</option>
                    {/volist}
                </select>
            </div>
        </div>

        <div class="layui-form-item">
            <label class="layui-form-label">{:lang('username')}</label>
            <div class="layui-input-4">
                <input type="text" name="username" lay-verify="required" placeholder="{:lang('pleaseEnter')}登录用户名"
                    class="layui-input">
            </div>
            <div class="layui-form-mid layui-word-aux">
                用户名在4到25个字符之间。
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">{:lang('pwd')}</label>
            <div class="layui-input-4">
                <input type="password" name="pwd" placeholder="{:lang('pleaseEnter')}登录密码" {if
                    condition="ACTION_NAME eq 'adminadd'" }lay-verify="required" {/if} class="layui-input">
            </div>
            <div class="layui-form-mid layui-word-aux">
                密码必须大于6位，小于15位。
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">头像</label>
            <input type="hidden" name="avatar" id="avatar">
            <div class="layui-input-block">
                <div class="layui-upload">
                    <button type="button" class="layui-btn layui-btn-primary" id="adBtn"><i
                            class="icon icon-upload3"></i>点击上传</button>
                    <div class="layui-upload-list">
                        <img class="layui-upload-img" id="adPic">
                        <p id="demoText"></p>
                    </div>
                </div>
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">{:lang('email')}</label>
            <div class="layui-input-4">
                <input type="text" name="email" lay-verify="email" placeholder="{:lang('pleaseEnter')}用户邮箱"
                    class="layui-input">
            </div>
            <div class="layui-form-mid layui-word-aux">
                用于密码找回，请认真填写。
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">{:lang('tel')}</label>
            <div class="layui-input-4">
                <input type="text" name="tel" lay-verify="phone" value="" placeholder="{:lang('pleaseEnter')}手机号"
                    class="layui-input">
            </div>
        </div>
        <div class="layui-form-item">
            <div class="layui-input-block">
                <input type="hidden" name="admin_id">
                <button type="button" class="layui-btn" lay-submit="" lay-filter="submit">{:lang('submit')}</button>
                <a href="{:url('adminList')}" class="layui-btn layui-btn-primary">{:lang('back')}</a>
            </div>
        </div>
    </form>
</div>
{include file="common/foot"/}
<link rel="stylesheet" href="/static/admin/css/multiSelect.css">
<script>

    layui.config({
        //  base: '/js/' // 扩展模块目录
    }).extend({
    formMulti: '/js/form.mutil',
    });
    layui.use(['formMulti', 'layer', 'upload'], function() {
        var form = layui.formMulti, layer = layui.layer, $ = layui.jquery, upload = layui.upload;
        var info = {$info|raw};
        var is_admin = "{$result['is_admin']}";
        var is_position = "{$result['is_position']}";
        var channel = "{$result['channel']}";

        form.val("form", info);
        if (info) {
            $('#adPic').attr('src', info.avatar);
        }
        form.render();
        
        // 存储已选择的店铺ID
        var selectedShopIds = [];
        
        // 获取店铺列表（使用 xmSelect 渲染多选下拉）
        function getShopList(channelValue) {
            $('#port-item').remove();  // 移除旧的运营端口选择框容器
            if (!channelValue) {
                return;
            }
            var adminId = (info && info.admin_id) ? info.admin_id : 0;
            var url = "{:url('getShops')}";
            // 发起 Ajax 请求获取指定渠道的端口列表
            $.get(url, { 
                inquiry_id: channelValue,      // 渠道ID【替换】参数名改为 inquiry_id
                admin_id: adminId 
            }, function(res) {
                if (res.code === 0) {
                    console.log('获取店铺失败:', res.msg);
                    layer.msg(res.msg, { icon: 2, time: 3000 });
                    return;
                }
                if (res.code > 0 && res.data && res.data.length > 0) {
                    // 构造运营端口多选下拉的容器 HTML（使用 xmSelect）
                    var portHtml = 
                        '<div class="layui-form-item" id="port-item">' +
                            '<label class="layui-form-label">运营端口</label>' +
                            '<div class="layui-input-4">' +
                                '<div id="operationPortsSelect"></div>' +
                                '<input type="hidden" name="port_id" />' +  // 【替换】隐藏域用于提交选中的端口ID
                            '</div>' +
                        '</div>';
                    // 将端口选择框插入到渠道选择框后方
                    $('#channel-item').after(portHtml);
                    // 准备 xmSelect 数据
                    var selectedPorts = [];
                    if (info && info.port_id) {
                        // 将已有的端口ID字符串转成数组
                        selectedPorts = String(info.port_id).split(',').map(function(id) {
                            return id.trim();
                        }).filter(Boolean);
                    }
                    var xmData = [];
                    $.each(res.data, function(index, item) {
                        var portId = String(item.id).trim();
                        var portName = String(item.port_name).trim();
                        var disabledFlag = false;
                        var displayName = portName;
                        if (item.is_used) {
                            if (selectedPorts.indexOf(portId) === -1) {
                                // 已被其他管理员占用的端口，禁用选择
                                disabledFlag = true;
                                displayName = portName + '（已占用）';
                            } else {
                                // 当前管理员已拥有的端口，仍可选（允许取消选择）
                                disabledFlag = false;
                                displayName = portName;
                            }
                        }
                        xmData.push({ name: displayName, value: portId, disabled: disabledFlag });
                    });
                    // 默认选中值（端口ID数组）
                    var initValue = selectedPorts.length > 0 ? selectedPorts : [];
                    // 渲染 xmSelect 下拉多选框
                    window.operationPortsSelectInstance = xmSelect.render({
                        el: '#operationPortsSelect',    // 容器元素选择器
                        name: 'operation_ports',        // 提交字段名（xmSelect内部使用）
                        layVerify: 'required',          // 验证规则：必填
                        tips: '请选择运营端口',           // 占位提示文字
                        filterable: true,               // 开启搜索过滤
                        clickClose: false,              // 多选时点击选项不关闭下拉
                        initValue: initValue,           // 初始化选中值
                        data: xmData                    // 下拉选项数据
                    });
                } else {
                    layer.msg('该渠道暂无端口数据', { icon: 0 });
                }
            }).fail(function() {
                layer.msg('获取店铺列表失败', { icon: 2 });
            });
        }

        // 更新店铺可用性（选择过的店铺不能再被选择）
        function updateShopAvailability() {
            var $select = $('#operation_ports_select');
            if ($select.length === 0) {
                return;
            }
            
            // 获取当前选中的所有值（店铺名称）
            var currentSelected = [];
            $select.find('option:selected').each(function() {
                var shopName = $(this).val().trim();
                if (shopName && currentSelected.indexOf(shopName) === -1) {
                    currentSelected.push(shopName);
                }
            });
            
            // 更新所有选项的禁用状态
            $select.find('option').each(function() {
                var $option = $(this);
                var shopName = $option.val().trim();
                var originalText = $option.data('original-text') || $option.text().replace(/（已选择）|（已占用）/g, '');
                $option.data('original-text', originalText);
                
                // 检查是否已被其他管理员占用
                var isUsedByOther = $option.text().indexOf('（已占用）') !== -1 && !$option.prop('selected');
                
                // 如果店铺已被其他管理员占用，保持禁用状态
                if (isUsedByOther) {
                    $option.prop('disabled', true);
                    return;
                }
                
                // 如果店铺已被当前用户选中，保持可选（允许取消选择）
                if ($option.prop('selected')) {
                    $option.prop('disabled', false);
                    $option.text(originalText);
                } 
                // 如果店铺在当前选择列表中但未被选中（重复项），禁用
                else if (currentSelected.indexOf(shopName) !== -1 && shopName) {
                    $option.prop('disabled', true);
                    $option.text(originalText + '（已选择）');
                }
                // 其他情况，启用该选项
                else {
                    $option.prop('disabled', false);
                    $option.text(originalText);
                }
            });
            
            form.render('select'); // 重新渲染
        }
        
        function getChannelList(ele) {
            var url = "{:url('getChannels')}";
            $.get(url, function(res) {
                if (res.code > 0) {
                    // 构建“所属渠道”下拉选择框 HTML
                    var channelHtml = '<div class="layui-form-item" id="channel-item">'
                        + '<label class="layui-form-label">所属渠道</label>'
                        + '<div class="layui-input-4">'
                        + '<select name="inquiry_id" id="channel-select" lay-verify="required" lay-filter="channelSelect">'
                        + '<option value="">请选择渠道</option>';
                    // 动态添加渠道选项（仅 status=0 的渠道）
                    var selectedChannel = '';
                    $.each(res.data, function(index, item) {
                        var sel = '';
                        if (info && item.id == info.inquiry_id) {
                            sel = 'selected class="layui-this"';
                            selectedChannel = item.id;  // 记录选中的渠道ID
                        }
                        channelHtml += '<option ' + sel + ' value="' + item.id + '">' + item.name + '</option>';
                    });
                    channelHtml += '</select></div></div>';
                    // 插入渠道选择框并渲染表单
                    $(ele).after(channelHtml);
                    form.val("form", info.org);
                    form.render('select');  // 渲染下拉框
                    // 确保下拉列表不被遮挡
                    setTimeout(function() {
                        $('#channel-select').next('.layui-form-select').css('z-index', '9999')
                            .find('dl').css({ 'z-index': '10000', 'position': 'absolute' });
                    }, 200);
                    // 如果已有选中的渠道，则自动加载对应端口列表
                    if (selectedChannel) {
                        getShopList(selectedChannel);
                    }
                } else {
                    layer.msg('获取渠道列表失败', {icon: 2});
                }
            });
        }



        // 监听用户组选择框
        function handleOperationGroup() {
            var selectedText = $('#user_group option:selected').text();
            var $formItem = $('#user_group').closest('.layui-form-item');
            $('#channel-item').remove();
            $('#operation-role-item').remove(); // 移除已存在的运营角色选项
            // 如果选择了“运营”用户组
            if (selectedText === '运营') {
                if (is_admin == '1' || is_position == '1') {
                    // 创建运营职位单选按钮组 HTML
                    var roleHtml = '<div class="layui-form-item" id="operation-role-item" style="display:block">'
                        + '<label class="layui-form-label">运营职位</label>'
                        + '<div class="layui-input-4">'
                        + '<input type="radio" name="position" value="1" title="运营总监" lay-filter="operationPosition" ' + (info && info.position == 1 ? 'checked' : '') + '>'
                        + '<input type="radio" name="position" value="2" title="运营主管" lay-filter="operationPosition" ' + (info && info.position == 2 ? 'checked' : '') + '>'
                        + '<input type="radio" name="position" value="0" title="运营专员" lay-filter="operationPosition" ' + (info && info.position == 0 ? 'checked' : '') + '>'
                        + '</div></div>';
                    // 插入运营职位选项并渲染
                    $formItem.after(roleHtml);
                    form.render('radio');
                    // 获取渠道列表并插入渠道下拉框
                    getChannelList('#operation-role-item');
                } else {
                    // 非主管的运营用户，仅显示所属渠道（不可更改）
                    var channelHtml = '<div class="layui-form-item" id="channel-item">'
                        + '<label class="layui-form-label">所属渠道</label>'
                        + '<div class="layui-input-4">'
                        + '<select name="inquiry_id" id="channel-select" lay-verify="required" lay-filter="channelSelect">'  // 【替换】使用 inquiry_id 作为字段名
                        + '<option value="' + "{$result['inquiry_id']}" + '" selected>' + channel + '</option>'  // 显示当前渠道名称
                        + '</select></div></div>';
                    $formItem.after(channelHtml);
                    form.val("form", info.org);
                    form.render('select', 'inquiry_id');  // 渲染渠道下拉框
                    // 加载该渠道的端口列表
                    if ("{$result['inquiry_id']}" !== "0") {
                        getShopList("{$result['inquiry_id']}");
                    }
                }
            } else {
                // 非“运营”用户组时，移除渠道选择框和端口选择框
                $('#channel-item').remove();
                $('#port-item').remove();
            }
        }

        // 初始化时调用一次以根据当前用户组显示相应字段
        handleOperationGroup();

        // 当所属用户组下拉改变时，触发重新渲染
        form.on('select(groupSelect)', function() {
            handleOperationGroup();
        });
        
        // 监听渠道下拉选择变化
        form.on('select(channelSelect)', function(data) {
            var channelValue = data.value;
            getShopList(channelValue);
        });
        
        
        // 表单提交前，将选中的运营端口数组转为逗号字符串写入隐藏域
        form.on('submit(submit)', function(data) {
            if (window.operationPortsSelectInstance) {
                var selectedValues = window.operationPortsSelectInstance.getValue('value');  // 获取选中端口的值（ID数组）
                var portsStr = selectedValues.join(',');
                $('input[name="port_id"]').val(portsStr);    // 设置隐藏域 port_id 的值
                data.field.port_id = portsStr;               // 确保提交数据包含 port_id 字段
            }
            var loading = layer.load(1, { shade: [0.1, '#fff'] });
            $.post("", data.field, function(res) {
                layer.close(loading);
                if (res.code > 0) {
                    layer.msg(res.msg, {time:1800, icon:1}, function() {
                        location.href = res.url;
                    });
                } else {
                    layer.msg(res.msg, {time:1800, icon:2});
                }
            });
            return false; // 阻止默认提交
        });

        //普通图片上传
        var uploadInst = upload.render({
            elem: '#adBtn'
            , url: '{:url("UpFiles/upload")}'
            , before: function (obj) {
                //预读本地文件示例，不支持ie8
                obj.preview(function (index, file, result) {
                    $('#adPic').attr('src', result); //图片链接（base64）
                });
            },
            done: function (res) {
                if (res.code > 0) {
                    $('#avatar').val(res.url);
                } else {
                    //如果上传失败
                    return layer.msg('上传失败');
                }
            }
            , error: function () {
                //演示失败状态，并实现重传
                var demoText = $('#demoText');
                demoText.html('<span style="color: #FF5722;">上传失败</span> <a class="layui-btn layui-btn-mini demo-reload">重试</a>');
                demoText.find('.demo-reload').on('click', function () {
                    uploadInst.upload();
                });
            }
        });
    });
</script>